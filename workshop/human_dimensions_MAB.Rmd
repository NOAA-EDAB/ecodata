---
title: "Human Dimensions MAB and Shelf-wide"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    theme: lumen
    self_contained: false
    lib_dir: libs
---

```{r setup, include=FALSE}
# Image Directory
image.dir <- here::here("workshop/images")
gis.dir <- here::here("data-raw/gis")
#Default Rmd options
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center') #allows for inserting R code into captions

#Plotting and data libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(ecodata)
library(here)
library(kableExtra)
library(ggrepel)
library(stringr)
#library(patchwork)
library(grid)
library(cowplot)

#GIS libraries
library(sf)
library(rgdal)
library(raster)
library(ggspatial)
library(marmap)


#General inline text input for report

#Council
council <- "Mid-Atlantic Fishery Management Council"
council_abbr <- "MAFMC"

#Region identifiers
epu <- "Mid-Atlantic Bight"
epu_abbr <- "MAB"
region <- "Mid-Atlantic"
region_abbr <- "MA" #Some commercial data organized by "MA" or "NE" regions, not by EPU 


```

```{r GIS-setup}

#CRS
crs <- "+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0 +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#EPU shapefile
epu_sf <- ecodata::epu_sf %>% 
  filter(EPU %in% c("MAB","GB","GOM"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -77
xmax = -65
ymin = 36
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

#Time series constants
shade.alpha <- 0.3
shade.fill <- "lightgrey"
lwd <- 1
pcex <- 2
trend.alpha <- 0.5
trend.size <- 2
hline.size <- 1
hline.alpha <- 0.35
hline.lty <- "dashed"
label.size <- 5
hjust.label <- 1.5
letter_size <- 4
feeding.guilds1<- c("Piscivore","Planktivore","Benthivore","Benthos")
feeding.guilds <- c("Apex Predator","Piscivore","Planktivore","Benthivore","Benthos")
x.shade.min <- 2012
x.shade.max <- 2022

#Define constants for figure plot
series.col <- c("indianred","black")

#Function for custom ggplot facet labels
label <- function(variable,value){
  return(facet_names[value])
}
```

Trend lines are shown when slope is significantly different from 0 at the p < 0.05 level. An orange line signifies an overall positive trend, and purple signifies a negative trend. To minimize bias introduced by small sample size, no trend is fit when N < 30. Dashed lines represent mean values of time series unless the indicator is an anomaly, in which case the dashed line is equal to 0. Shaded regions indicate the past ten years. If there are no new data for 2018, the shaded region will still cover this time period.

## Mid-Atlantic

### Commercial Fisheries {.tabset .tabset-fade}

#### Commercial Landings



```{r comdat-commercial-landings, fig.cap="MAFMC managed seafood landings in US (red) and total landings (black) by feeding guild. \\label{comm-landings}"}


#Managed landings
managed_landings <- ecodata::comdat  %>%
  dplyr::filter(Var %in% c("Planktivore MAFMC managed species - Seafood Landings",
                           "Piscivore MAFMC managed species - Seafood Landings",
                           "Benthivore MAFMC managed species - Seafood Landings",
                           "Apex Predator MAFMC managed species - Seafood Landings",
                           "Benthos MAFMC managed species - Seafood Landings", "Planktivore JOINT managed species - Seafood Landings",
                           "Piscivore JOINT managed species - Seafood Landings",
                           "Benthivore JOINT managed species - Seafood Landings",
                           "Apex Predator JOINT managed species - Seafood Landings",
                           "Benthos JOINT managed species - Seafood Landings"),
         Time >= 1986) %>% 
  tidyr::separate(Var, into = c("feeding.guild"), sep = " ") %>% 
  dplyr::group_by(feeding.guild, EPU, Time) %>% 
  dplyr::summarise(Value = sum(Value)) %>% 
  dplyr::mutate(grouping = c("managed"), 
                Units = c("metric tons")) %>% 
  dplyr::ungroup()

#Total landings
total_landings <- ecodata::comdat  %>% 
  dplyr::filter(Var %in% c("Planktivore Landings",
                           "Piscivore Landings",
                           "Benthivore Landings",
                           "Apex Predator Landings",
                           "Benthos Landings"),
         Time >= 1986) %>% 
  dplyr::mutate(grouping = c("total")) %>% 
  tidyr::separate(Var, into = c("feeding.guild"), sep = " ")

# #Assign feeding guild column for plotting with ggplot
landings <-
  rbind(managed_landings, total_landings) %>%
  dplyr::filter(!stringr::str_detect(feeding.guild, "Apex")) %>%
  #tidyr::separate(Var, into = c("feeding.guild", "a", "grouping"), sep = " ") %>% 
  dplyr::mutate(#feeding.guild = stringr::str_extract(Var,c(feeding.guilds)),
         #grouping = recode(grouping, "Landings" = "total"),
         Var = paste(feeding.guild, grouping)) %>%
  dplyr::mutate(feeding.guild = factor(feeding.guild, levels = feeding.guilds))
 
# #Add JOINT landings to MANAGED landings and remove
# landings[landings$Var ==  "Piscivore managed",]$Value <- landings[landings$Var ==  "Piscivore managed",]$Value + landings[landings$Var ==  "Piscivore joint",]$Value

landings <- landings   %>%
  dplyr::group_by(Var, EPU) %>%
  dplyr::mutate(hline = mean(Value))

#Define constants for figure plot
series.col <- c("indianred","black") 

#facet names for titles
facet_names <- list("Apex" = expression("Apex"),
                    "Piscivores" = expression("Piscivores"),
                    "Planktivores" = expression("Planktivores"),
                    "Benthivores" = expression("Benthivores"),
                    "Benthos" = expression("Benthos"))



mab_landings<- landings %>%
  dplyr::filter(EPU == "MAB") %>% 
  ggplot2::ggplot(aes(x = Time, y = Value, color = grouping)) +
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var)) +
  # ecodata::geom_lm(aes(x = Time, y = Value,
  #              group = Var))+
  
  #Add time series
  ggplot2::geom_line(size = lwd) +
  ggplot2::geom_point(size = pcex) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::geom_hline(aes(yintercept = hline,
                 color = grouping,
                 size = grouping),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  #facet_wrap(feeding.guild~., scales = "free", labeller = label, ncol = 1)+
  ggplot2::facet_wrap(~feeding.guild, ncol = 1, scales = "free")+
  #ggplot2::facet_wrap(~feeding.guild, ncol = 1, scales = "free")+
  #Axis and theme
  #ggplot2::ylim(0, 200)+
  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000})+
  ggplot2::scale_x_continuous(breaks = seq(1985, 2020, by = 5), expand = c(0.01, 0.01)) +
  ggplot2::ylab(expression("Landings (10"^3*"metric tons)")) +
  ggplot2::xlab(element_blank())+
  ecodata::theme_facet() +
  ggplot2::theme(strip.text=element_text(hjust=0), 
                 legend.position = "none")+
  ggplot2::ggtitle("Mid-Atlantic Bight")+
  ecodata::theme_title()

mab_landings 
```

```{r hms-landings-comdat-commercial_landings, warning=F, fig.cap = ("HMS groups include “Bluefin Tuna”, “BAYS”, “Swordfish”, “Large Coastal Sharks”, “Small Coastal Sharks”, “Pelagic Sharks”, “Smoothhound Sharks”. “BAYS” includes bigeye, albacore, yellowfin and skipjack tunas. “Large Coastal Sharks” includes blacktip, bull, great hammerhead, scalloped hammerhead, smooth hammerhead, lemon, nurse, sandbar, silky, spinner, and tiger sharks. “Small Coastal Sharks” includes Atlantic sharpnose, blacknose, bonnethead, finetooth sharks. “Pelagic Sharks” includes blue, porbeagle, shortfin mako, and thresher sharks. “Smoothhound Sharks” includes smooth dogfish shark.")}

## Apex pred
apex<-ecodata::hms_landings %>% 
  dplyr::filter(stringr::str_detect(Var, "Landings")) %>% 
  separate(Var, c("Var", "trash"), sep = "_")

##Plot
p1<-apex %>% 
  dplyr::filter(EPU == "MAB") %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value)) %>% 

  ggplot2::ggplot(aes(x = Time, y = Value, color = Var)) +
  ggplot2::geom_line(size = lwd) +
  ggplot2::geom_point(size = pcex) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 color = Var,
                 size = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  ecodata::theme_facet() +
  ggplot2::theme(strip.text=element_text(hjust=0), 
        legend.position = "bottom", 
        legend.direction = "horizontal", 
        legend.title = element_blank())+
  ggplot2::ylab(expression("Landings (metric tons)")) +
  ggplot2::xlab("Time")+
  ggplot2::ggtitle("HMS Landings")+
  ecodata::theme_title()

p1

``` 


```{r comdat-total-landings, fig.asp=.35, fig.cap = paste0("Total commercial landings (black), Total US landings (blue), and MAFMC managed seafood landings from US (red). \\label{total-landings}")}
council_abbr <- "MAFMC"
#Managed landings
managed_landings <- ecodata::comdat  %>%
  dplyr::filter(Var %in% c("Planktivore MAFMC managed species - Seafood Landings",
                           "Piscivore MAFMC managed species - Seafood Landings",
                           "Benthivore MAFMC managed species - Seafood Landings",
                           "Apex Predator MAFMC managed species - Seafood Landings",
                           "Benthos MAFMC managed species - Seafood Landings", "Planktivore JOINT managed species - Seafood Landings",
                           "Piscivore JOINT managed species - Seafood Landings",
                           "Benthivore JOINT managed species - Seafood Landings",
                           "Apex Predator JOINT managed species - Seafood Landings",
                           "Benthos JOINT managed species - Seafood Landings"),
         Time >= 1986) 

US_landings <- ecodata::comdat  %>%
  dplyr::filter(Var == "Seafood Landings",
         Time >= 1986)
# #Total landings
total_landings <- ecodata::comdat  %>%
  dplyr::filter(Var == "Landings",
         Time >= 1986)

total_landings_agg <- total_landings %>%
  dplyr::group_by(EPU,Time) %>%
  dplyr::summarise(Value = sum(Value)/1000) %>% 
  dplyr::mutate(Var = "Total",hline = mean(Value))

us_total_landings_agg <- US_landings %>%
  dplyr::group_by(EPU,Time) %>%
  dplyr::summarise(Value = sum(Value)/1000) %>% 
  dplyr::mutate(Var = "USTotal",hline = mean(Value))

managed_landings_agg <- managed_landings %>%
  dplyr::group_by(EPU,Time) %>%
  dplyr::summarise(Value = sum(Value)/1000) %>% 
  dplyr::mutate(Var = "Managed",hline = mean(Value))

landings_agg <- rbind(total_landings_agg, managed_landings_agg, us_total_landings_agg)# %>% 
#  dplyr::mutate(Value = Value/1000)
series.col2 <- c("indianred",  "black", "steelblue4")

landings_aggx<- landings_agg %>% 
  dplyr::filter(EPU == "MAB")

mab_total <- landings_aggx  %>% 
ggplot2::ggplot()+
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  #ecodata::geom_lm(aes(x = Time, y = Value))+
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  ggplot2::ylim(15,600)+
  # ggplot2::geom_line(data =landings_agg_post2018, aes(x = Time, y = Value, color = Var), size = lwd) +
  # ggplot2::geom_point(data =landings_agg_post2018,aes(x = Time, y = Value, color = Var), size = pcex, shape = 1)+
  # ggplot2::geom_line(data =landings_agg_pre2018, aes(x = Time, y = Value, color = Var), size = lwd) +
  # ggplot2::geom_point(data =landings_agg_pre2018,aes(x = Time, y = Value, color = Var), size = pcex, shape = 16)+
#  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000})+
  ggplot2::scale_x_continuous(breaks = seq(1985, 2020, by = 5), expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col2, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ylab(expression("Landings (10"^3*"mt)")) +
  ggplot2::xlab(element_blank())+
  ggplot2::theme(legend.position = "left")+
  ggplot2::geom_hline(aes(yintercept = hline,
               
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts() +
  ggplot2::ggtitle("Mid-Atlantic")+
  ecodata::theme_title()

mab_total
```

#### Commercial Revenue 

```{r bennet, fig.cap = paste0("Revenue change from the 2015 values in dollars (black), Price (PI), and Volume Indicators (VI) for commercial  landings in the Mid-Atlantic Bight. \\label{bennet}")}

#Filter data into two dataframes for plotting

indicators <- ecodata::bennet %>% 
  dplyr::filter(EPU == epu_abbr) %>% 
  dplyr::filter(stringr::str_detect(Var, pattern="Total"),
         !Var == "Total Revenue Change - Bennet", 
         !Time < 1985) %>% 
  dplyr::mutate(Var, Var = plyr::mapvalues(Var, from = c("Total Volume Index - Bennet", "Total Price Index - Bennet"),
                                           to = c("Volume","Price"))) %>% 
  dplyr::group_by(Time) %>% 
  dplyr::mutate(New = sum(Value))

revchange <- ecodata::bennet %>% 
  dplyr::filter(EPU == "MAB",
         Var %in% c("Total Revenue Change - Bennet"),
         !Time<1985)
#custom bar fill color (color-blind friendly)
ind_fill <- c("#a6cee3", "#b2df8a")

#limits
y.lim <- c(-450,600)

#plot
ggplot2::ggplot()+
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  ggplot2::geom_bar(data = indicators, aes(x = Time, y = Value, fill = Var), stat="identity")+
  ggplot2::scale_fill_manual(name = "Indicators", values = ind_fill) +
  ggplot2::geom_line(data = revchange, aes(x = Time, y = Value, color = "$"))+
  ggplot2::scale_colour_grey(name ="Revenue Change") +
  ggplot2::ggtitle("Bennet Indicator")+
  ggplot2::labs(y="Value $1,000,000 ($2015)") +
  ggplot2::scale_x_continuous(breaks = seq(1985, 2020, by = 5), expand = c(0.01, 0.01)) +
  #::scale_y_continuous(breaks = seq(y.lim[1], y.lim[2], by = 100), 
  #                            limits = y.lim, expand = c(0.01, 0.01)) +
  ecodata::theme_ts() +
  ggplot2::xlab(element_blank())+
  ggplot2::theme(title = element_text(size = 10))+
  ecodata::theme_title()

```

```{r bennet-all, fig.cap = paste0("Revenue change from the 2015 values in dollars (black), Price (PI), and Volume Indicators (VI) for commercial landings in the Mid-Atlantic Bight. \\label{bennet}")}

#Filter data into two dataframes for plotting
indicators <- ecodata::bennet %>% 
  dplyr::filter(EPU == epu_abbr) 

indicators$Var<- gsub( "Predator", "", indicators$Var)
indicators$Var<- gsub( "Value", "Volume", indicators$Var)
indicators<- indicators %>% 
  separate(Var, c("Guild", "Var") ) %>% 
  dplyr::filter(!Var == "Revenue",
                !Guild == "Total", 
         !Time < 1985) %>% 
  dplyr::group_by(Time,  Var) %>% 
  dplyr::mutate(component = sum(Value)) %>% 
  ungroup()

  # dplyr::filter(#stringr::str_detect(Var, pattern="Total"),
  #        !Var == "Total Revenue Change - Bennet", 
  #        !Time < 1985) %>% 
  # dplyr::mutate(Var, Var = plyr::mapvalues(Var, from = c("Total Volume Index - Bennet", "Total Price Index - Bennet"),
  #                                          to = c("Volume","Price"))) %>% 
  # dplyr::group_by(Time) %>% 
  # dplyr::mutate(New = sum(Value)) %>% 
  # dplyr::group_by(Time, Var) %>% 
  # dplyr::mutate(component = sum(Value))

revchange <- ecodata::bennet %>% 
  dplyr::filter(EPU == "MAB",
         #Var %in% c("Total Revenue Change - Bennet"),
         !Time<1985)
#custom bar fill color (color-blind friendly)
#ind_fill <- c("#a6cee3", "#b2df8a", "#000001")

#limits
y.lim <- c(-400,550)

indicators$Guild<-factor(indicators$Guild, levels = c("Apex", "Piscivore", "Planktivore", 
                                                      "Benthivore", "Benthos", "Other"))

#plot
ggplot2::ggplot()+
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  ggplot2::geom_bar(data = indicators, aes(x = Time, y = Value, fill = Guild), stat="identity")+
  #ggplot2::scale_fill_manual(name = "Indicators", values = Guild) +
  ggplot2::geom_line(data = indicators, aes(x = Time, y = component, color = "$"))+
  ggplot2::facet_wrap(~Var)+
  ggplot2::scale_colour_grey(name ="Component") +
  ggplot2::ggtitle("Bennet Indicator")+
  ggplot2::labs(y="Value $1,000,000 ($2015)") +
  ggplot2::scale_x_continuous(breaks = seq(1990, 2020, by = 10), expand = c(0.01, 0.01)) +
  #ggplot2::scale_y_continuous(breaks = seq(y.lim[1], y.lim[2], by = 100), 
  #                            limits = y.lim, expand = c(0.01, 0.01)) +
  ggplot2::scale_fill_brewer(palette = "Set1")+
  ecodata::theme_ts() +
  ggplot2::xlab(element_blank())+
  ggplot2::theme(title = element_text(size = 10))+
  ecodata::theme_title()+
  ecodata::theme_facet()

```

```{r bennet2, fig.cap = paste0("Revenue change from the 2015 values in dollars (black), Price (PI), and Volume Indicators (VI) for commercial landings in the Mid-Atlantic Bight. \\label{bennet}")}

#Filter data into two dataframes for plotting

indicators <- ecodata::bennet %>% 
  dplyr::filter(EPU == epu_abbr) 

indicators$Var<- gsub( "Predator", "", indicators$Var)
indicators$Var<- gsub( "Value", "Volume", indicators$Var)
indicators<- indicators %>% 
  separate(Var, c("Guild", "Var") ) %>% 
  dplyr::filter(!Var == "Revenue",
                !Guild == "Total", 
         !Time < 1985) %>% 
  dplyr::group_by(Time, Guild) %>% 
  dplyr::mutate(New = sum(Value))

revchange <- ecodata::bennet %>% 
  dplyr::filter(EPU == "MAB",
         Var %in% c("Total Revenue Change - Bennet"),
         !Time<1985)
#custom bar fill color (color-blind friendly)
ind_fill <- c("#a6cee3", "#b2df8a")

#limits
y.lim <- c(-450,600)

#plot
ggplot2::ggplot()+
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  ggplot2::geom_bar(data = indicators, aes(x = Time, y = Value, fill = Var), stat="identity")+
  ggplot2::scale_fill_manual(name = "Indicators", values = ind_fill) +
  ggplot2::geom_line(data = revchange, aes(x = Time, y = Value, color = "$"))+
  ggplot2::scale_colour_grey(name ="Revenue Change") +
  ggplot2::ggtitle("Bennet Indicator")+
  ggplot2::labs(y="Value $1,000,000 ($2015)") +
  ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 10), expand = c(0.01, 0.01)) +
  #ggplot2::scale_y_continuous(breaks = seq(y.lim[1], y.lim[2], by = 100), 
  #                            limits = y.lim, expand = c(0.01, 0.01)) +
  ecodata::theme_ts() +
  ggplot2::facet_wrap(~Guild)+
  ggplot2::theme(title = element_text(size = 10), 
                 legend.position = "bottom")+
  ecodata::theme_title()

```

```{r bennet-table}
indicators <- ecodata::bennet %>% 
  dplyr::filter(EPU == epu_abbr) 

indicators$Var<- gsub( "Predator", "", indicators$Var)
indicators$Var<- gsub( "Value", "Volume", indicators$Var)
indicators<- indicators %>% 
  separate(Var, c("Guild", "Var") ) %>% 
  dplyr::filter(!Var == "Revenue",
                !Guild == "Total", 
         !Time < 1985) %>% 
  dplyr::group_by(Time, Guild) %>% 
  dplyr::mutate(New = sum(Value)) %>% 
  ungroup()

#dplyr::select(ind2, !c(Units, EPU, Guild, Source, Var, New))

ind2<- indicators %>% 
  dplyr::mutate(Name = paste(Guild, Var)) %>% 
  dplyr::select(-c(Guild, Units, EPU, Var, New)) %>% 
  tidyr::pivot_wider(names_from = Name, values_from = Value) %>% 
  dplyr::select(Time, `Apex Volume`, `Apex Price`, 
                `Benthivore Volume`, `Benthivore Price`, 
                `Benthos Volume`, `Benthos Price`,
                `Planktivore Volume`, `Planktivore Price`,
                `Piscivore Volume`, `Piscivore Price`,
                `Other Volume`, `Other Price` )

Table<- kable(ind2, col.names = c("Time", "Volume", "Price",  "Volume", "Price",
                           "Volume", "Price",  "Volume", "Price", 
                           "Volume", "Price",  "Volume", "Price")) %>% 
  kableExtra::add_header_above(c(" ", "Apex Pred" = 2, "Benthivore" = 2, 
                                 "Benthos" = 2, "Planktivore" = 2, 
                                 "Piscivore" = 2, "Other" = 2))


```



```{r comdat-comm-revenue,  fig.cap = "Total revenue for the region (black) and revenue from MAFMC managed species (red). \\label{comm-rev}"}
## Apex pred
apex<-ecodata::hms_landings %>% 
  dplyr::filter(stringr::str_detect(Var, "Revenue"), 
                Time<2021) %>% 
  separate(Var, c("Var", "trash"), sep = "_") %>% 
  group_by(Time) %>% 
  summarise(Value = sum(Value)) %>% 
  mutate(Var = c("HMS Revenue"), 
         Units = c("metric tons"), 
         EPU = c("MAB"))
#Filtering and aggregation step
rev_agg <- ecodata::comdat %>% 
  dplyr::filter(Var %in% c("Piscivore MAFMC managed species - Revenue",
                           "Planktivore MAFMC managed species - Revenue",
                           "Benthivore MAFMC managed species - Revenue", 
                           "Benthos MAFMC managed species - Revenue", 
                           "Piscivore JOINT managed species - Revenue",
                           "Planktivore JOINT managed species - Revenue",
                           "Benthivore JOINT managed species - Revenue", 
                           "Benthos JOINT managed species - Revenue")) %>% 
  rbind(apex) %>% 
  dplyr::mutate(Status = c("Managed")) %>% #Create groups for 
  dplyr::group_by(Status, Time, EPU) %>% 
  dplyr::summarise(Total = sum(Value)) %>% 
  dplyr::group_by(Status, EPU) %>% 
  dplyr::mutate(hline = mean(Total))

rev_total<- ecodata::comdat %>% 
  dplyr::filter(Var == "Revenue") %>% 
  dplyr::mutate(Status = c("Total")) %>% 
  dplyr::group_by(Status, Time, EPU) %>% 
  dplyr::summarise(Total = sum(Value)) %>% 
  dplyr::group_by(Status, EPU) %>% 
  dplyr::mutate(hline = mean(Total))
  
series.col <- c("indianred","black")

rev<- rbind(rev_agg, rev_total) %>% 
  dplyr::filter(EPU == "MAB", 
                Time >1986)
#Plotting
ggplot2::ggplot(data = rev) +
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+  
  
  #lines
  ecodata::geom_gls(aes(x = Time, y = Total,
               group = Status),
             alpha = trend.alpha, size = trend.size) +
  # ecodata::geom_lm(aes(x = Time, y = Total,
  #              group = Status))+
  ggplot2::geom_line(aes(x = Time, y = Total, color = Status), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Total, color = Status), size = 1.5) +

  #axes
  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000000})+
  ggplot2::scale_x_continuous(breaks = seq(1985, 2020, by = 5), expand = c(0.01, 0.01)) +
      scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Total Commercial Revenue") +
  ggplot2::ylab(expression("Revenue (10"^6*"USD)")) +
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Status),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ggplot2::xlab(element_blank())+
  ecodata::theme_ts()+
  ecodata::theme_title()



```

```{r hms-comm-revenue,  fig.cap = "HMS revenue. \\label{comm-rev}"}
## Apex pred
apex<-ecodata::hms_landings %>% 
  dplyr::filter(stringr::str_detect(Var, "Revenue")) %>% 
  separate(Var, c("Var", "trash"), sep = "_")


#Define constants for figure plot
series.col <- c("indianred","black")

##Plot
p1<-apex %>% 
  dplyr::filter(EPU == "MAB") %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(Value = Value/1000000, 
                hline = mean(Value)) %>% 

  ggplot2::ggplot(aes(x = Time, y = Value, color = Var)) +
  
  #Add time series
  ggplot2::geom_line(size = lwd) +
  ggplot2::geom_point(size = pcex) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 color = Var,
                 size = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  ecodata::theme_facet() +
  ggplot2::theme(strip.text=element_text(hjust=0), 
        legend.position = "bottom", 
        legend.direction = "horizontal", 
        legend.title = element_blank())+
  ggplot2::ylab(expression("Revenue (10^6 US Dollars)")) +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("HMS Revenue")+
  ecodata::theme_title()

p1

```

#### Commercial diversity

```{r commercial-div, fig.cap = paste0("Fleet diversity and fleet count in the ",region,". \\label{comm-div}")}

# 
comm_div <- ecodata::commercial_div %>% 
  dplyr::filter(EPU == region_abbr) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value))

ylim_fc <- c(min(comm_div[comm_div$Var == "Fleet count",]$Value) - 10, max(comm_div[comm_div$Var == "Fleet count",]$Value) + 10 )
ylim_fd <- c(0, max(comm_div[comm_div$Var == "Fleet diversity in revenue",]$Value) + 3 )
# 
# #Create dataframe for label locations
# label_loc <- data.frame(xloc = min(comm_div$Time)+0.25,
#                         yloc = c(ylim_fc[2]*0.95, ylim_fd[2]*0.95),
#                         labels = LETTERS[1:2],
#                         Var = c("Fleet count","Fleet diversity in revenue"))
# 
 series.col = c("black")


fleet_count <- comm_div %>% 
  dplyr::filter(Var == "Fleet count") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  #label
  # annotate("text", x = label_loc[label_loc$Var == "Fleet count",]$xloc,
  #          y = label_loc[label_loc$Var == "Fleet count",]$yloc,
  #          label = label_loc[label_loc$Var == "Fleet count",]$label,
  #          size = letter_size) +

  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  # ecodata::geom_lm(aes(x = Time, y = Value,
  #              group = Var))+
  ggplot2::ylim(ylim_fc)+
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Fleet count") +
  ggplot2::ylab(expression("Count (n)")) +
  ggplot2::xlab("")+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()+
  ecodata::theme_title()

fleet_div <- comm_div %>% 
  dplyr::filter(Var == "Fleet diversity in revenue") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
 ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
    #label
  # annotate("text", x = label_loc[label_loc$Var == "Fleet diversity in revenue",]$xloc,
  #          y = label_loc[label_loc$Var == "Fleet diversity in revenue",]$yloc,
  #          label = label_loc[label_loc$Var == "Fleet diversity in revenue",]$label,
  #          size = letter_size) +

  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  ggplot2::ylim(ylim_fd)+
  # ecodata::geom_lm(aes(x = Time, y = Value,
  #              group = Var))+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Fleet diversity") +
  ggplot2::ylab(expression("Effective Shannon")) +
  ggplot2::xlab(element_blank())+

  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
 ecodata::theme_ts()+
 ecodata::theme_title()

cowplot::plot_grid(fleet_count, fleet_div, ncol = 1, align = "hv") + 
  ggplot2::theme(plot.margin = unit(c(0.1, 0, 0, 0), "cm"))

```


```{r commercial-div-species-div,  fig.cap = paste0("Species revenue diversity in the ",region,". \\label{spec-div}")}
comm_div <- ecodata::commercial_div %>% 
  dplyr::filter(EPU == region_abbr) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value))

comm_div %>% 
  dplyr::filter(Var == "Permit revenue species diversity") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  # geom_gls(aes(x = Time, y = Value,
  #              group = Var),
  #            alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  # ecodata::geom_lm(aes(x = Time, y = Value,
  #              group = Var))+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Permit revenue species diversity") +
  ggplot2::ylab(expression("Effective Shannon")) +
  ggplot2::xlab(element_blank())+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
 ecodata::theme_ts()+
 ecodata::theme_title()
```

#### Stock status

```{r stock-status, echo=FALSE, warning=F, fig.cap = paste0("Summary of single species status for MAMFC and jointly managed stocks, goosefish and dogfish jointly managed.")} 
#Get data, spread for plotting, and filter
stock_status <- ecodata::stock_status %>%
  dplyr::mutate(Code = recode(Code, "Dogfish" = "Sp. Dogfish" ), 
                Code = recode(Code, "Mackerel" = "At. Mackerel")) %>% 
  tidyr::spread(.,Var,Value) %>% 
  dplyr::filter(Council %in% c("MAFMC","Both")) %>% 
  dplyr::group_by(Stock) %>% 
  dplyr::mutate(score = case_when(
    #(B.Bmsy < 0.5) ~"a",
    (F.Fmsy > 1 & B.Bmsy > 0.5 & B.Bmsy < 1) ~ "a", 
    (F.Fmsy < 1 & B.Bmsy > 0.5 & B.Bmsy < 1) ~ "b",
    (F.Fmsy < 1 & B.Bmsy > 1) ~ "c", 
    (F.Fmsy > 1 & B.Bmsy < 0.5) ~ "d")) %>% 
  dplyr::mutate(Council = dplyr::recode(Council, "Both" = "MAFMC/NEFMC"))
    
#Plot constants
y.max <- 2.1 #1.75 mackerel cut off F/Fmsy is 1.8
x.max <- 2.6
#A dataframe that defines custom legend for stocks with unknown status
unknown <- data.frame(text = c("Unknown Status", "Longfin Squid",
                              "Shortfin Squid", "N. Goosefish", "S. Goosefish", "Blueline Tilefish", "Chub Mackerel"),
                    x = rep(0.9*x.max,7), y = seq(0.88*y.max,1.2,-0.1))

# Custom Color
custom_color<- c("#56B4E9", "#009E73", "#0072B2", "#E6AB02")
#Plotting code
ggplot2::ggplot(data = stock_status) +
  ggplot2::geom_vline(xintercept = 1, linetype = "dotted")+
  ggplot2::geom_vline(xintercept = 0.5, linetype = "dashed")+
  ggplot2::geom_hline(yintercept = 1, linetype = "dashed") +
  ggplot2::geom_point(aes(x = B.Bmsy,
                 y = F.Fmsy,
                 shape = Council,
                 color = score)) +
  ggrepel::geom_text_repel(aes(x = B.Bmsy, #geom_text_repel auto-jitters text around points
                      y = F.Fmsy,
                      label = Code, 
                      color = score), 
                  show.legend = FALSE, nudge_y = -0.01, nudge_x = 0.05) +
  ggplot2::scale_color_brewer(palette = "Dark2",
                     breaks = stock_status$score) +
  ggplot2::ylim(0,y.max) +
  ggplot2::xlim(0,x.max) +
  ggplot2::geom_text(data = unknown, aes(x = x-0.5, y = y+0.2, label = text), #Custom legend for unknown stock status
            size = c(4.75,rep(4,6))) +
  #ggplot2::annotate("rect", xmin = 0.8*x.max,
  #         xmax = x.max
  #         ymin = 0.65*y.max,
  #         ymax = 0.90*y.max,
  #         alpha = 0.1) +
  ggplot2::xlab(expression(~B/B[msy])) +
  ggplot2::ylab(expression(~F/F[msy])) +
  ggplot2::guides(color = FALSE) +
  ecodata::theme_ts()
```

#### Oyster aquaculture

```{r aquaculture, fig.cap = "Oyster aquaculture production in pieces. \\label{oyster-aqua}"}

aqua <- ecodata::aquaculture %>%
  dplyr::filter(Region %in% c("MD", "VA", "NJ")) %>% 
  dplyr::filter(!Value == "NA") %>% 
  dplyr::mutate(Time = as.integer(Time), 
                Value = as.numeric(Value))

ggplot2::ggplot() +
 #Highlight last ten years
  ggplot2::geom_line(data = aqua, aes(x = Time, y = Value, color = Region), size = lwd) +
  ggplot2::geom_point(data = aqua,aes(x = Time, y = Value, color = Region), size = pcex) +
  #ggplot2::facet_wrap(~Region, nrow = 3)+
  ggplot2::ggtitle("Oyster Production in MAB")+
  ggplot2::ylab(expression("Oysters production")) +
  ggplot2::xlab(element_blank())+
  scale_x_continuous(breaks=c(2009,2011,2013,2015, 2017, 2019))+
  ecodata::theme_ts()+
  ecodata::theme_title()

# aqua %>% group_by(Time) %>% summarise(Value = sum(Value)) %>% 
#   dplyr::filter(Time %in% c(max(Time), max(Time-1))) %>% 
#   dplyr::summarise(m = mean(Value))
# 
# aqua %>% group_by(Time) %>% summarise(Value = sum(Value)) %>% 
#   dplyr::filter(Time %in% c(max(Time-2), max(Time-3),  max(Time-4)), 
#                 !Value == "NA") %>%  
#   dplyr::summarise(m= mean(Value))

```

#### Engagement and reliance

```{r commercial-engagement, message=F, fig.cap= "Commercial engagement, reliance and environmental justicve vulnerability for the top commercial fishing communities in the Mid-Atlantic. (* Scored high (1.00 and above) for both commercial engagement and reliance indicators)", message = FALSE, warning=FALSE}

com<-ecodata::engagement %>% 
  dplyr::filter(Region == "MAB", 
                Fishery == "Commercial") %>% 
  dplyr::rename("EJRating" = "EJ Rating")

com2<-com %>% 
  ggplot2::ggplot()+
  ggplot2::geom_point(aes(x = Eng, y = Rel, color = EJRating), size = 2)+
  ggplot2::geom_vline(xintercept = 1, linetype = "dashed",color = "black", size = 0.5)+
  ggplot2::geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.5) +
  ggrepel::geom_text_repel(aes(x = Eng, #geom_text_repel auto-jitters text around points
                      y = Rel,
                      label = Community,
                      color = EJRating), show.legend = FALSE, direction = "both", box.padding = 0.2, size = 3)+
  ggplot2::scale_color_brewer(palette = "Dark2", #Change legend labels for clarity
                     breaks = com$EJRating) +
  xlim(-2,12.7)+
  ylim(-1,3.0)+
  theme(legend.position=c(0.85, 0.15), 
        #legend.title = element_blank(),       
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))+
  labs(color = "EJ Vulnerability")+
  ggplot2::xlab("Commercial Engagement Index") +
  ggplot2::ylab("Commercial Reliance Index") +
  ggplot2::ggtitle("Environmental Justice in Top Commercial Fishing Communities")+
  #ggplot2::guides(color = FALSE) +
  #theme_bw()
  ecodata::theme_ts()+
  ecodata::theme_title()
  #ecodata::theme_facet()
  
  
gridExtra::grid.arrange(com2, bottom = textGrob("Low <---------------------------------------------------------------------------------------------------------------------------> High", 
                                     x = 0.5, y = 1, gp = gpar(fontsize = 7)),
                          left = textGrob("Low <--------------------------------------------------------------------------------------> High", rot = 90,
                                   x = 1, y = 0.45, gp = gpar(fontsize = 7)))


```

#### Environmental Justice Spider


```{r commercial-EJ, fig.cap="Environmental justice indicators (Poverty Index, population composition index, and personal disruption index) for top commercial fishing communities in Mid-Altantic."}


knitr::include_graphics(file.path(image.dir, "EJ_Commercial_MAB_2023.png"))

```

### Recreational fisheries {.tabset .tabset-fade}

#### Recreational landings

```{r recdat-landings, fig.cap = paste0("Total recreational landings (seafood harvest) in the Mid-Atlantic region. \\label{rec-landings}")}

landings_rec <- ecodata::recdat %>% 
  dplyr::filter(EPU == region_abbr,
         Var == "Recreational Seafood") %>% 
  dplyr::mutate(hline = mean(Value))

series.col <- "black"

ggplot2::ggplot(data = landings_rec)+
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  # ecodata::geom_lm(aes(x = Time, y = Value,
  #              group = Var))+
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000000})+
  ggplot2::scale_x_continuous(breaks = seq(1985, 2020, by = 5), expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Recreational seafood harvest") +
  ggplot2::ylab(expression("Landings (10"^6*"lbs)")) +
  ggplot2::xlab(element_blank())+
  ggplot2::geom_hline(aes(yintercept = hline,
               
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()+
  ecodata::theme_title()
```

#### Recreational diversity

```{r recdat-effort,fig.cap = paste0("Recreational effort, recreational effort diversity, number of recreational anglers, and diversity of recreational catch in the ",region,". \\label{recdat}")}
recdat <- ecodata::recdat %>% 
  dplyr::filter(EPU == region_abbr) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value))

ylim_re <- c(2e7, 7e7)
ylim_rd <- c(1.75,2.75)
ylim_ra  <- c(1e6, 3.5e6)

# #Create dataframe for label locations
# label_loc <- data.frame(xloc = min(recdat$Time)+0.3,
#                         yloc = c(ylim_re[2]*0.975,
#                                  ylim_rd[2]*0.975,
#                                  ylim_ra[2]*0.975),
#                         labels = LETTERS[1:3],
#                         Var = c("Recreational Effort",
#                                 "Recreational fleet effort diversity across modes",
#                                 "Recreational anglers"))

series.col <- "black"
# x.shade.min <- max(recdat$Time, na.rm = T) - 9
# x.shade.max <- max(recdat$Time, na.rm = T)

rec_effort <- recdat %>% 
  dplyr::filter(Var == "Recreational Effort") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  #label
  # annotate("text", 
  #          x = label_loc[label_loc$Var == "Recreational Effort",]$xloc,
  #          y = label_loc[label_loc$Var == "Recreational Effort",]$yloc,
  #          label = label_loc[label_loc$Var == "Recreational Effort",]$labels,
  #          size = letter_size)+
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  # ecodata::geom_lm(aes(x = Time, y = Value,
  #              group = Var))+
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000000}, limits = ylim_re)+
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Recreational effort")+
  ggplot2::ylab(expression(atop("Angler Trips",paste("(Number x 10"^6*")")))) +
  ggplot2::xlab(element_blank())+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts() +
  ecodata::theme_title()



rec_effort
```

```{r recdat-diversity}

recdat <- ecodata::recdat %>% 
  dplyr::filter(EPU == region_abbr) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value))

ylim_re <- c(2e7, 7e7)
ylim_rd <- c(1.75,2.75)
ylim_ra  <- c(1e6, 3.5e6)

series.col <- "black"

rec_div <- recdat %>% 
  dplyr::filter(Var == "Recreational fleet effort diversity across modes") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  # annotate("text", 
  #          x = label_loc[label_loc$Var == "Recreational fleet effort diversity across modes",]$xloc,
  #          y = label_loc[label_loc$Var == "Recreational fleet effort diversity across modes",]$yloc,
  #          label = label_loc[label_loc$Var == "Recreational fleet effort diversity across modes",]$labels,
  #          size = letter_size)+
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  # ecodata::geom_lm(aes(x = Time, y = Value,
  #              group = Var))+
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  ggplot2::ylim(ylim_rd)+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Recreational fleet effort diversity")+
  ggplot2::ylab(expression("Effective Shannon")) +
  ggplot2::xlab(element_blank())+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()+
  ecodata::theme_title()

rec_div

```


```{r recdat-div-catch}

recdat <- ecodata::recdat %>% 
  dplyr::filter(EPU == region_abbr) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value))

ylim_re <- c(2e7, 7e7)
ylim_rd <- c(1.75,2.75)
ylim_ra  <- c(1e6, 3.5e6)

series.col <- "black"

rec_div_catch <- recdat %>% 
  dplyr::filter(Var == "Recreational Diversity of Catch") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
    # annotate("text", 
    #        x = label_loc[label_loc$Var == "Recreational anglers",]$xloc,
    #        y = label_loc[label_loc$Var == "Recreational anglers",]$yloc,
    #        label = label_loc[label_loc$Var == "Recreational anglers",]$labels,
    #        size = letter_size)+
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  # ecodata::geom_lm(aes(x = Time, y = Value,
  #              group = Var))+
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Recreational diversity of catch")+
  ggplot2::ylab(expression("Effective Shannon")) +
  ggplot2::xlab(element_blank())+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()+
  ecodata::theme_title()

rec_div_catch
```

#### Recreational Engagement and reliance

```{r recreational-engagement, message=F, fig.cap= "Recreational engagement, reliance and environmental justice vulnerability for the top recreational fishing communities in the Mid-atlantic. (* Scored high (1.00 and above) for both recreational engagement and reliance indicators). "}

com<-ecodata::engagement %>% 
  dplyr::filter(Region == "MAB", 
                Fishery == "Recreational") %>% 
  dplyr::rename("EJRating" = "EJ Rating")

com2<-com %>% 
  ggplot2::ggplot()+
  ggplot2::geom_point(aes(x = Eng, y = Rel, color = EJRating), size = 2)+
  ggplot2::geom_vline(xintercept = 1, linetype = "dashed", color = "black", size = 0.5)+
  ggplot2::geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.5) +
  ggrepel::geom_text_repel(aes(x = Eng, #geom_text_repel auto-jitters text around points
                      y = Rel,
                      label = Community,
                      color = EJRating), show.legend = FALSE, direction = "both", box.padding = 0.3, size = 3)+
  ggplot2::scale_color_brewer(palette = "Dark2", #Change legend labels for clarity
                     breaks = com$EJRating, 
                     direction = 1) +
  xlim(-1,13)+
  ylim(-1,14)+
  theme(legend.position=c(0.5, 0.83), 
        #legend.title = element_blank(),       
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))+
  labs(color = "EJ Vulnerability")+
  ggplot2::xlab("Recreational Engagement Index") +
  ggplot2::ylab("Recreational Reliance Index") +
  ggplot2::ggtitle("Environmental Justice in Top Recreational Fishing Communities")+
  #ggplot2::guides(color = FALSE) +
  ecodata::theme_ts()+
  ecodata::theme_title()
  
  
gridExtra::grid.arrange(com2, bottom = textGrob("Low <--------------------------------------------------------------------------------------------------------------------------------------> High", 
                                     x = 0.5, y = 1, gp = gpar(fontsize = 7)),
                          left = textGrob("Low <----------------------------------------------------------------------------------------> High", rot = 90,
                                   x = 1, y = 0.5, gp = gpar(fontsize = 7)))


```

#### Environmental Justice Spider



```{r recreational-EJ, fig.cap="Environmental justice indicators (Poverty Index, population composition index, and personal disruption index) for top recreational fishing communities in Mid-Atlantic."}
knitr::include_graphics(file.path(image.dir, "EJ_Recreational_MAB_2023.png"))

```

#### Recreational Shark Landings

```{r rec_hms, fig.cap="Recreational shark landings from mrip."}
ecodata::rec_hms %>% 
  dplyr::filter(EPU == "MAB") %>%
  tidyr::separate(Var, c("Var", "X"), sep = "-") %>%
  dplyr::mutate(Value = Value/10000) %>% 
  ggplot2::ggplot()+
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var))+
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var))+
  ggplot2::ylab(expression("Landings (N"^4*")"))+
  ggplot2::ggtitle("Recreational Shark Landings")+
  ggplot2::xlab(element_blank())+
  ggplot2::theme(legend.title = element_blank())+
  ecodata::theme_ts()+
  ecodata::theme_title()

```

Recent pelagic landings coming primarily from Common Thresher and Shortfin Mako. 

### Ecosystem Overfishing {.tabset .tabset-fade}

<!-- #### Primary Production Required -->

<!-- ```{r ppr, fig.cap="Primary production required to support the commercial landings. Included are the top species accounting for 80% of the landings in each year."} -->
<!-- a<- ecodata::ppr %>%  -->
<!--   dplyr::group_by(EPU) %>%  -->
<!--   dplyr::mutate(hline = mean(Value)) %>%  -->
<!--   dplyr::filter(Var == "PPR", -->
<!--                 EPU == "MAB",  -->
<!--                 Time <= 1997)  -->

<!-- ecodata::ppr %>%  -->
<!--   dplyr::group_by(EPU) %>%  -->
<!--   dplyr::mutate(hline = mean(Value)) %>%  -->
<!--   dplyr::filter(Var == "PPR", -->
<!--                 EPU == "MAB",  -->
<!--                 Time >= 1997) %>%  -->
<!--   ggplot2::ggplot() + -->
<!--   ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = -Inf, ymax = Inf) + -->
<!--   ggplot2::geom_point(aes(x = Time, y = Value))+ -->
<!--   ggplot2::geom_line(aes(x = Time, y = Value))+ -->
<!--   ggplot2::geom_line(data = a, aes(x = Time, y = Value), linetype = "dashed")+ -->
<!--   # ecodata::geom_lm(aes(x = Time, y = Value, -->
<!--   #              group = Var))+ -->
<!--   ggplot2::geom_hline(aes(yintercept = hline), -->
<!--            size = hline.size, -->
<!--            alpha = hline.alpha, -->
<!--            linetype = hline.lty)+ -->
<!--   ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) + -->
<!--   ggplot2::ggtitle("Primary Production Required")+ -->
<!--   ggplot2::ylab("Proportion of Total PPD ")+ -->
<!--   ggplot2::xlab(element_blank())+ -->
<!--   ecodata::theme_ts()+ -->
<!--   ecodata::theme_title() -->
<!-- ``` -->

#### Fogarty Index

```{r fogarty, fig.cap="Fogarty Index"}

ecodata::ppr %>% 
  dplyr::filter(Var == "Fogarty") %>% 
  dplyr::mutate(Value = Value*1000) %>% 
  dplyr::group_by(EPU) %>% 
  dplyr::mutate(hline = mean(Value), 
                gr_up = c(0.92),
                rd_up = c(2.5),
                gr_lw = c(0.22),
                rd_lw = c(1)) %>% 
  dplyr::filter(EPU == "MAB") %>% 
  ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_ribbon( aes(ymin = gr_lw, ymax = gr_up, x = Time), fill = "darkolivegreen3", alpha = 0.5)+
  ggplot2::geom_ribbon( aes(ymin = rd_lw, ymax = rd_up, x = Time), fill = "sandybrown", aplha = 0.5)+
  ggplot2::geom_point(aes(x = Time, y = Value))+
  ggplot2::geom_line(aes(x = Time, y = Value))+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  #ggplot2::facet_wrap( ~ EPU)+
  ggplot2::ggtitle("Fogarty Index")+
  ggplot2::ylab("PPT")+
  ggplot2::xlab(element_blank())+
  ecodata::theme_ts()+
  ecodata::theme_title()
```

#### Ryther index

```{r ryther, fig.cap="Ryther Index"}


ecodata::ppr %>% 
  dplyr::filter(Var == "Ryther") %>% 
  dplyr::group_by(EPU) %>% 
  dplyr::mutate(hline = mean(Value), 
                gr_up = c(1.1),
                rd_up = c(5),
                gr_lw = c(0.3),
                rd_lw = c(3))%>%
  
  dplyr::filter(EPU == "MAB") %>% 
  ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_ribbon( aes(ymin = gr_lw, ymax = gr_up, x = Time), fill = "darkolivegreen3", alpha = 0.5)+
  ggplot2::geom_ribbon( aes(ymin = rd_lw, ymax = rd_up, x = Time), fill = "sandybrown", aplha = 0.5)+
  ggplot2::geom_point(aes(x = Time, y = Value))+
  ggplot2::geom_line(aes(x = Time, y = Value))+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  #ggplot2::facet_wrap( ~ EPU)+
  ggplot2::ggtitle("Ryther Index")+
  ggplot2::ylab("mt km-2 y-1")+
  ggplot2::xlab(element_blank())+
  ecodata::theme_ts()+
  ecodata::theme_title()
```

<!-- #### Mean Trophic Level -->

<!-- ```{r mtl, fig.cap="Mean trophic level"} -->

<!-- ecodata::ppr %>%  -->
<!--   dplyr::filter(Var == "MTL") %>%  -->
<!--   dplyr::group_by(EPU) %>%  -->
<!--   dplyr::mutate(hline = mean(Value)) %>%  -->
<!--   dplyr::filter(EPU == "MAB") %>%  -->
<!--   ggplot2::ggplot() + -->
<!--   ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = -Inf, ymax = Inf) + -->
<!--   ggplot2::geom_point(aes(x = Time, y = Value))+ -->
<!--   ggplot2::geom_line(aes(x = Time, y = Value))+ -->
<!--   ggplot2::geom_hline(aes(yintercept = hline), -->
<!--            size = hline.size, -->
<!--            alpha = hline.alpha, -->
<!--            linetype = hline.lty)+ -->
<!--   ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) + -->
<!--   #ggplot2::facet_wrap( ~ EPU)+ -->
<!--   ggplot2::ggtitle("Mean Trophic Level")+ -->
<!--   ggplot2::ylab("")+ -->
<!--   ggplot2::xlab(element_blank())+ -->
<!--   ecodata::theme_ts()+ -->
<!--   ecodata::theme_title() -->
<!-- ``` -->

#### PP reconstructed

```{r pp-reconstructed, fig.cap="reconstructed primary production"}


a<-ecodata::ppr %>% 
  dplyr::filter(Var == "PP") %>% 
  dplyr::group_by(EPU) %>% 
  dplyr::mutate(hline = mean(Value)) %>% 
  dplyr::filter(EPU == "MAB", 
                Time <=1997) 

ecodata::ppr %>% 
  dplyr::filter(Var == "PP") %>% 
  dplyr::group_by(EPU) %>% 
  dplyr::mutate(hline = mean(Value)) %>% 
  dplyr::filter(EPU == "MAB", 
                Time >=1997) %>% 
  ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_point(aes(x = Time, y = Value))+
  ggplot2::geom_line(aes(x = Time, y = Value))+
  ggplot2::geom_line(data = a, aes(x = Time, y = Value), linetype = "dashed")+
  ggplot2::geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  #ggplot2::facet_wrap( ~ EPU)+
  ggplot2::ggtitle("PP Reconstrcted")+
  ggplot2::ylab("mtC region-1 year-1")+
  ecodata::theme_ts()+
  ecodata::theme_title()
```

### Wind Energy Area Revenue

```{r wea-spp-rev, fig.cap="Wind energy revenue in the Mid-Atlantic"}
ecodata::wind_revenue %>%
  tidyr::separate(Var, sep = "-", into = c("Species", "Var")) %>% 
  dplyr::filter(Var == "sum_value") %>% 
  dplyr::mutate(Value = as.numeric(Value), 
                Value = Value/1000000,
                Time = as.integer(Time)) %>%
  dplyr::filter(EPU == "MAB", 
                Species %in% c("LONGFIN SQUID", "MONK", "SUMMER FLOUNDER",
                               "OCEAN QUAHOG", "SURF CLAM")) %>% 
                # Species %in% c("SQUID / LOLIGO","MONK","FLOUNDER, SUMMER / FLUKE",
                #                "QUAHOGS/BUSHEL",  "CLAM, SURF/BUSHEL" )) %>%
  dplyr::mutate(Species = recode(Species, "LONGFIN SQUID"="Longfin Squid", 
                                 "MONK" = "Monkfish", 
                                 "SUMMER FLOUNDER" = "Summer Flounder", 
                                 "OCEAN QUAHOG" = "Ocean Quahog",
                                 "SURF CLAM" = "Surfclam")) %>% 
  ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Species))+
  ggplot2::geom_line(aes(x = Time, y = Value, color = Species))+
  scale_x_continuous(breaks=c(2008,2012,2016, 2020))+
  ggplot2::ggtitle("Fishery Revenue in Wind Lease Areas")+
  ggplot2::ylab(expression("Dollars (10"^6*")"))+
  theme(legend.title = element_blank())+
  ggplot2::xlab(element_blank())+
  ecodata::theme_ts()+
  ecodata::theme_title()
```

```{r wea-port-rev, fig.cap="Percent of port revenue from Wind Energy Areas(WEA) in descending order of most to least port revenue from WEA."}
df.symbol <- ecodata::wind_port %>% filter(EPU == "MAB", 
                                           !Var %in% c("WEA_MAX", "TOT_MAX", 
                                                     "perc_MIN", "perc_MAX")) %>% 
   pivot_wider( names_from = Var, values_from = Value) %>%
  dplyr::mutate(City = paste0(City,State)) %>% 
  dplyr::select(City, EJ, Gent) %>% 
  pivot_longer(cols = c(EJ, Gent), names_to = "Variable") %>% 
  filter(!value == "NA") %>% 
  dplyr::mutate(symbol = recode(Variable, EJ = -7, Gent = -3), 
                Variable = recode(Variable,"EJ"= "Mid-High to High EJ Concerns" , 
                                  "Gent" ="Mid-High to High Gentrificaiton Concerns"))

# Percentage plot

df.all.perc<- ecodata::wind_port %>% filter(EPU == "MAB") %>%
  pivot_wider( names_from = Var, values_from = Value) %>%
  dplyr::mutate(ordering = WEA_MAX,  
                City = paste0(City, State), 
                perc_dif =  c(perc_MAX - perc_MIN), 
                TOT_MAX = c(100 - perc_dif - perc_MIN)) %>% 
  pivot_longer(cols = c(perc_MIN,  perc_dif, TOT_MAX), names_to="Var", values_to = "Value") %>% 
  dplyr::arrange(desc(ordering)) %>%
  dplyr::mutate(City = factor(City, levels = unique(City))) %>% 
  dplyr::filter(!Var %in% c("WEA_MAX", "EJ", "Gent")) %>% 
  dplyr::mutate(Var = recode(Var,"perc_MIN"= "WEA Revenue" , 
                                  "perc_dif" ="WEA Revenue Range", 
                             "TOT_MAX" = "Non-WEA Revenue"), 
                Var = factor(Var, levels = c("Non-WEA Revenue", 
                                             "WEA Revenue Range", 
                                             "WEA Revenue")))
p2<-ggplot2::ggplot()+
  ggplot2::geom_bar(data = df.all.perc, aes(fill = Var, y = reorder(City, ordering), x = Value), stat="identity" )+
  scale_fill_brewer()+
  ggplot2::theme(legend.position = "bottom", 
                 legend.title = element_blank(), 
                 legend.box="vertical", legend.margin=margin())+
  ggplot2::geom_point(data = df.symbol, aes(x = symbol,y = City, shape = Variable)) +
  scale_shape_manual(values = c(17, 16)) +
  ggplot2::ggtitle("Port Revenue from Wind Energy Area")+
  ggplot2::xlab(expression("Port Revenue (%)"))+
  ggplot2::ylab(element_blank())+
  ecodata::theme_ts()

p2

```


### Total ABC/ACL

```{r abcacl-stacked}

ecodata::abc.acl %>% 
  dplyr::filter(EPU == "MAB") %>% 
  tidyr::separate(col = Var, into = c("Fishery", "Var"), sep = "_") %>% 
  dplyr::filter(Var == "Quota") %>% 
  dplyr::mutate(Fishery = gsub("Commercial", "C", Fishery), 
                Fishery = gsub("Recreational", "R", Fishery)) %>% 
   dplyr::group_by(Fishery, Time) %>% 
   dplyr::summarise(Value = sum(Value)) %>% 
  ggplot2::ggplot()+
  ggplot2::geom_bar(aes( y = Value, x = Time, fill = Fishery), stat="identity", position = "stack" )+
  ggplot2::ggtitle("ABC or ACL for MAFMC Managed Species")+
  ggplot2::theme(legend.text = element_text(size = 8), 
                 legend.key.height = unit(2, "mm"))+
  ggplot2::ylab("ABC or ACL")+
  ggplot2::xlab(element_blank())+
  ecodata::theme_ts()+
  ggplot2::guides(fill=guide_legend(ncol=2))+
  ecodata::theme_title()

```

```{r abcacl}

ecodata::abc.acl %>% 
  dplyr::filter(EPU == "MAB") %>% 
  tidyr::separate(col = Var, into = c("Fishery", "Var"), sep = "_") %>% 
  dplyr::filter(Var == "Quota") %>% 
  dplyr::group_by(Fishery) %>% 
  #dplyr::mutate(Value = Value/10000) %>% 
  dplyr::summarise(Value_mean = mean(Value), 
                   Value_sd = sd(Value)) %>%
  dplyr::mutate(upper = Value_mean + Value_sd, 
                lower = Value_mean - Value_sd) %>% 
  ungroup() %>% 
  ggplot2::ggplot()+
  ggplot2::geom_bar(aes( y = Fishery, x = Value_mean), stat="identity" )+
  ggplot2::geom_errorbar(aes( y = Fishery, xmin = lower, xmax=upper),
                         stat="identity")+
  #ggplot2::geom_point()+
  #ggplot2::geom_line()+
  ggplot2::ggtitle("ABC or ACL for MAFMC Managed Species")+
  #ggplot2::ylab(expression("ABC/ACL"))+
  ggplot2::xlab("ABC or ACL")+
  ecodata::theme_ts()+
  ecodata::theme_title()
  

```

### ABC/ACL ratio to Catch

```{r abcacl-catch, fig.cap = "Catch divided by ABC/ACL for MAFMC managed fisheies. Chub mackerel removed due extremely low catch. Outliers = Recreational Black Sea Bass.  Possible management success story? - See comment in google doc."}
mean<- ecodata::abc.acl %>% 
  dplyr::filter(EPU == "MAB") %>% 
  tidyr::separate(col = Var, into = c("FMP", "Var"), sep = "_") %>% 
  tidyr::pivot_wider(names_from = Var, values_from = Value)  %>% 
  #tidyr::separate(Catch, into = c("Catch", "X"), sep = ",") %>% 
  dplyr::mutate(Catch = as.numeric(stringr::str_extract(Catch, pattern = "\\d+")), 
                Quota = as.numeric(stringr::str_extract(Quota, pattern = "\\d+")),
                Value = Catch/Quota, 
                Time = as.character(Time)) %>% 
  filter(!Value == "NA") %>%
  dplyr::group_by(Time) %>% 
  dplyr::summarise(val = mean(Value)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Time = as.numeric(Time))

ecodata::abc.acl %>% 
  dplyr::filter(EPU == "MAB") %>% 
  tidyr::separate(col = Var, into = c("FMP", "Var"), sep = "_") %>% 
  tidyr::pivot_wider(names_from = Var, values_from = Value)  %>% 
  #tidyr::separate(Catch, into = c("Catch", "X"), sep = ",") %>% 
  dplyr::mutate(Catch = as.numeric(stringr::str_extract(Catch, pattern = "\\d+")), 
                Quota = as.numeric(stringr::str_extract(Quota, pattern = "\\d+")),
                Value = Catch/Quota, 
                Time = as.numeric(Time))%>% 
  filter(!Value == "NA") %>% 
  ggplot2::ggplot()+
  #geom_boxplot()+
  geom_point(aes(x = Time, y = Value))+
  geom_point(data = mean, aes(x = Time, y = val), color = "red")+
  geom_line(data = mean, aes(x = Time, y = val), color = "red")+
  geom_hline(yintercept = 1, linetype='dashed', col = 'gray')+
  ggplot2::ggtitle("MAFMC Catch per ABC or ACL")+
  ggplot2::ylab(expression("Catch / ABC or ACL"))+
  ggplot2::theme(legend.title = element_blank())+
  ggplot2::xlab(element_blank())+
  ecodata::theme_ts()+
  ecodata::theme_title()


```


## Shelfwide Indicators

### HMS Stock Status

```{r hms-stock-status, echo=FALSE, warning=F, fig.cap = paste0("Summary of single species status for HMS stocks.")} 

y.max <- 5
x.max <- 2
#Get data, spread for plotting, and filter
unknown <- data.frame(text = c("Unknown Status", "ATL SBH", "SPF", "WA BFT"),
                      x = rep(0.9*x.max,4), y = seq(0.88*y.max,3.5,-0.3))



stock_status<-ecodata::hms_stock_status %>% 
  #tidyr::spread(.,Var,Value) %>% 
  tidyr::separate(Var, c("species_abr", "spp", "Var"), ":") %>% 
  tidyr::pivot_wider(names_from = Var, values_from = Value) %>% 
  dplyr::group_by(spp) %>% 
  dplyr::filter(!species_abr == "------", 
                !species_abr == "-----") %>% 
  dplyr::mutate(score = case_when(
    (B.Bmsy <0.5) ~"a",
    (B.Bmsy == 0.5) ~"a", 
    (F.Fmsy == 1) ~ "a",
    (F.Fmsy >1) ~ "a", 
    (F.Fmsy < 1 & B.Bmsy > 0.5 & B.Bmsy < 1) ~ "b",
    (F.Fmsy < 1 & B.Bmsy > 1) ~ "c"))
#Plot constants


#Plotting code
ggplot2::ggplot(data = stock_status) +
  ggplot2::geom_vline(xintercept = 1, linetype = "dotted", color = "grey60")+
  ggplot2::geom_vline(xintercept = 0.5, linetype = "dashed", color = "grey60")+
  ggplot2::geom_hline(yintercept = 1, linetype = "dashed", color = "grey60") +
  ggplot2::geom_point(aes(x = B.Bmsy,
                          y = F.Fmsy,
                          color = stock_status$score)) +
  ggrepel::geom_text_repel(aes(x = B.Bmsy, #geom_text_repel auto-jitters text around points
                               y = F.Fmsy,
                               label = species_abr,
                               color = stock_status$score), show.legend = FALSE,
                           nudge_y = -0.01, nudge_x = 0.05) +
  ggplot2::ylim(0,y.max) +
  ggplot2::xlim(0,x.max*1.1) +
  ggplot2::geom_text(data = unknown, aes(x = x, y = y, label = text), #Custom legend for unknown stock status
                     size = c(4.75,rep(4,3))) +
  ggplot2::annotate(geom="text", x=0.43, y=5, label="ATL SBN (F/Fmsy = 22.5)",
                    color="#1B9E77")+
  ggplot2::scale_color_brewer(palette = "Dark2", #Change legend labels for clarity
                              breaks = stock_status$score) +
  ggplot2::xlab(expression(~B/B[msy])) +
  ggplot2::ylab(expression(~F/F[msy])) +
  ggplot2::guides(color = FALSE) +
  ecodata::theme_ts()
```

### Proposed Wind Development

```{r wind-dev-cumul, fig.cap = ""}

knitr::include_graphics(file.path(image.dir, "Cumulative Timeline_Full Region_SoE2023 v2-01.png"))
```

<!-- ```{r wind-dev-cumul-MAB, fig.cap = ""} -->

<!-- knitr::include_graphics(file.path(image.dir, "MidAtlantic_2021128-01.jpg")) -->
<!-- #knitr::include_url("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/docs/images/MidAtlantic_2021119-01.jpg") -->
<!-- ``` -->

<!-- ```{r wind-dev-NE, fig.cap = ""} -->

<!-- #knitr::include_url("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/docs/images/NE2021119.jpg") -->
<!-- knitr::include_graphics(file.path(image.dir, "NE2021128-01.jpg")) -->
<!-- ``` -->

<!-- ```{r wind-dev-survey, fig.cap = ""} -->

<!-- knitr::include_graphics(file.path(image.dir, "SurveyMap202133.png")) -->
<!-- #knitr::include_url("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/docs/images/SurveysWindFarmAreas_20201229.jpg") -->
<!-- ``` -->

```{r wind-proposed-dev, eval = T, echo = F, fig.cap='Proposed wind development on the northeast shelf.', out.width='80%'}
 ecodata::wind_dev_speed %>% mutate(Value = as.numeric(Value)/1000000, 
                                                Time = as.integer(Time)) %>% 
  dplyr::filter(Var == "Acres", 
                Report_year == "year2023") %>% 
  ggplot2::ggplot()+
  ggplot2::geom_point(aes(x = Time, y = Value))+
  ggplot2::geom_line(aes(x = Time, y = Value))+
  #ggplot2::geom_point(aes(x = Time, y = `2022`))+
  #ggplot2::geom_line(aes(x = Time, y = `2022`))+
  ggplot2::ylab("Total Area (Million Acres)")+
  ggplot2::xlab("Project Construction Year")+
  ggplot2::ggtitle("Proposed Wind Development")+
  ecodata::theme_ts()+
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_continuous(breaks=c(2020,2022, 2024,2026, 2028, 2030))+
  ecodata::theme_title()+
  scale_colour_discrete(name="Year Reported", labels=c("2021","2022"))


```

### Landings and Revenue in Wind Energy Areas

Notes - Percent Landings and Revenue from wind energy areas. Data from GARFO VTR. 
\* Landings and revenue for these species are likely underestimated due to limited coverage of these fisheries in historic reporting requirements for vessels issued federal permits by the NMFS Greater Atlantic Regional Fisheries Office.  However, such limitations also suggest an inaccurately higher proportion of such landings and revenues in existing lease areas. ** Clearnose skates were reported separately from skates, which is presumed to include all skates managed under the Northeast skate complex. *** Based on comparison with other data sources, the high values for Illex squid are likely overestimates affected by the methods used to model logbook data to estimate spatial overlap of fishing operations with wind energy areas."

```{r wea-landings-rev, fig.cap="Percent Landings and Revenue from wind energy areas. Data from GARFO VTR. *Landings and revenue for these species are likely underestimated due to limited coverage of these fisheries in historic reporting requirements for vessels issued federal permits by the NMFS Greater Atlantic Regional Fisheries Office.  However, such limitations also suggest an inaccurately higher proportion of such landings and revenues in existing lease areas. **Clearnose skates were reported separately from skates, which is presumed to include all skates managed under the Northeast skate complex. ***Based on comparison with other data sources, the high values for Illex squid are likely overestimates affected by the methods used to model logbook data to estimate spatial overlap of fishign operations with wind energy areas.	"}

dt<- ecodata::wea_landings_rev %>% 
  dplyr::select("NEFMC, MAFMC, and ASMFC Managed Species", 
                "perc_landings_max","perc_revenue_max" ) %>% 
 dplyr::slice_head(n =10) %>% 
  dplyr::mutate(perc_landings_max = paste0(perc_landings_max, " %"),
                perc_revenue_max = paste0(perc_revenue_max, " %")) %>% 
  dplyr::rename("Maximum Percent Total Annual Regional Species Landings"="perc_landings_max",
    "Maximum Percent Total Annual Regional Species Revenue"="perc_revenue_max") 
kable(dt, caption = "Top ten species Landings and Revenue from Wind Energy Areas." ) %>% 
  kable_classic(full_width = F, html_font = "Cambria")

```

<!-- ### Wind Sites and Occurrence  -->

<!-- <span style="color: red;">NO NEW DATA</span> -->

<!-- These are the five species most likely to occur in the lease areas.  -->

<!-- ```{r wind-occupancy, eval = T, echo = F, fig.cap='', out.width='80%'} -->
<!-- wind1 <- ecodata::wind_occupancy -->
<!-- wind1$trend<- ifelse(wind1$Trend == "pos",  -->
<!--                     "$\\nearrow$", -->
<!--                     ifelse(wind1$Trend == "neg", -->
<!--                     "$\\searrow$",  -->
<!--                     " "))  -->
<!-- wind2<-wind1 %>% dplyr::select(Area, Season, Species, trend) -->
<!-- names<-c("Area", "Season", "Species", "trend") -->
<!-- bnew<-c("Area.1", "Season.1", "Species.1", "trend.1") -->
<!-- cnew<-c("Area.2", "Season.2", "Species.2", "trend.2") -->
<!-- dnew<-c("Area.3", "Season.3", "Species.3", "trend.3") -->
<!-- enew<-c("Area.4", "Season.4", "Species.4", "trend.4") -->
<!-- a<-wind2 %>% dplyr::filter(Area == "Existing-North")  -->
<!-- b<-wind2 %>% dplyr::filter(Area == "Proposed-North") %>%  -->
<!--   dplyr::rename_at(vars(names), ~ bnew) -->
<!-- c<-wind2 %>% dplyr::filter(Area == "Existing-Mid")%>%  -->
<!--   dplyr::rename_at(vars(names), ~ cnew) -->
<!-- d<-wind2 %>% dplyr::filter(Area == "Proposed-Mid")%>%  -->
<!--   dplyr::rename_at(vars(names), ~ dnew) -->
<!-- e<-wind2 %>% dplyr::filter(Area == "Existing-South")%>%  -->
<!--   dplyr::rename_at(vars(names), ~ enew) -->
<!-- all<- a %>% cbind(b,c,d,e) %>%  -->
<!--   dplyr::select(2:4,7:8,11:12,15:16,19:20) -->

<!-- kable(all, escape = FALSE, -->
<!--       col.names = c("Season", "Species", "Trend", "Species", "Trend", "Species","Trend", "Species","Trend", "Species", "Trend"), -->
<!--       caption = "Species with highest probability of occupancy species each season and area, with observed trends", -->
<!--       booktabs = T) %>% -->
<!--     add_header_above(c(" " = 1, "Existing - North" = 2, "Proposed - North" = 2,  -->
<!--                      "Existing - Mid" = 2, "Proposed - Mid" = 2,  -->
<!--                      "Existing - South" = 2)) %>% -->
<!--   kable_styling(latex_options = c("hold_position", "scale_down"))  -->
<!-- ``` -->
### Wind and Scientific Surveys

```{r wind-survey-table}
dat<- data.frame(XSurvey= c("Fall BTS", "Spring BTS", "EcoMon", "Scallop",
                            "Shellfish(Clams)", "Right Whale (Air)", 
                            "Marine Mammal/Turtle (Ship/Air)",
                            "Altantic Shark (Bottom Long-Line",
                            "GOM Bottom Long-Line", "GOM Shrimp Survey", 
                            "Atlantic Shark COASTPAN"), 
                 X1 = c("Started", "Started", "No",
                                                    "Started", "No", "Inital", 
                                                    "No", "No","No", "No","No"), 
                 X2 = c("Inital", "Initial", "No", "Initial", 
                                            "No", "Initial","No", "No","No", "No",
                                            "No" ), 
                 X3 = c( "No", "No","No",
                        "No","No",  "Initial", "No", "No","No", "No","No"), 
                 X4 = c("No", "No","No", "No","No","No", 
                                         "No","No", "No","No","No"), 
                 X5 = c("No", "No","No", "No","No","No", 
                                         "No","No", "No","No","No"),
                 X6 = c("Initial", "Initial","No", "No","No","No", 
                                         "No","No", "No","No","No"))

column_names <- c("Survey","1.Evaluate designs & Impacts","2.Design New Methods","3.Calibrate New/Existing Surveys","4.Bridge Solutions","5.Conduct New Surveys","6.Comms & Data")
#DT::datatable(dat, colnames = column_names)

kable(dat, col.names = column_names)
```









