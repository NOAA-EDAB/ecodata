#### Get Community Social Vulnerability Indicators (CSVI)

library(dplyr)
library(tidyr)

# Set directory
raw.dir <- here::here("data-raw")

# Define input files
comm_social_vuln_csv <- "fishdata_2022_CSVI_1-23-2025.csv"

get_community_social_vulnerability <- function(save_clean = F){
  # Create data frame to define State-EPU
  EPUlook <- data.frame(State = c("ME", "MA", "RI", "CT", "DE", "NH", "NY", "NJ", "MD", "VA", "NC", "PA"),
                  EPU = c("NE", "NE", "NE", "NE", "MAB", "NE","MAB","MAB","MAB","MAB","MAB","MAB"))

  # this reads numbers in as numbers
  dat <- readr::read_csv(file.path(raw.dir,comm_social_vuln_csv))

  # These are Bobby's data edits
  #rename top communities
  dat$GEO_NAME <- replace(dat$GEO_NAME,
                          dat$GEO_NAME=="Port Clyde-Tenants Harbor/Saint George/Spruce Head, ME",
                          "Port Clyde-Tenants Harbor, ME")
  
  
  dat$GEO_NAME <- replace(dat$GEO_NAME,
                          dat$GEO_NAME=="Sandwich/East Sandwich/Forestdale, MA",
                          "Sandwich, MA")
  
  
  dat$GEO_NAME <- replace(dat$GEO_NAME,
                          dat$GEO_NAME=="Reedville/District 5 (Northumberland County), VA",
                          "Reedville, VA")
  
  # If we want a long dataset, these need to be numbers to have them with the Eng and Rel values
  # Otherwise we need a wide dataset
  ##reorder ranks
  dat$ComEng_ct <- 
    factor(dat$ComEng_ct, levels=c("high", "med high", "med", "low"))
  dat$ComRel_ct <- 
    factor(dat$ComRel_ct, levels=c("high", "med high", "med", "low"))
  dat$RecEng_ct <- 
    factor(dat$RecEng_ct, levels=c("high", "med high", "med", "low"))
  dat$RecRel_ct <- 
    factor(dat$RecRel_ct, levels=c("high", "med high", "med", "low"))
  dat$poverty_rank <- 
    factor(dat$poverty_rank, levels=c("high", "med high", "med", "low"))
  dat$pop_composition_rank <- 
    factor(dat$pop_composition_rank, levels=c("high", "med high", "med", "low"))
  dat$personal_disruption_rank <- 
    factor(dat$personal_disruption_rank, levels=c("high", "med high", "med", "low"))
  dat$labor_force_str_rank <- 
    factor(dat$labor_force_str_rank, levels=c("high", "med high", "med", "low"))
  dat$housing_characteristics_rank <- 
    factor(dat$housing_characteristics_rank, levels=c("high", "med high", "med", "low"))
  dat$housing_disrupt_rank <- 
    factor(dat$housing_disrupt_rank, levels=c("high", "med high", "med", "low"))
  dat$retiree_migration_rank <- 
    factor(dat$retiree_migration_rank, levels=c("high", "med high", "med", "low"))
  dat$urban_sprawl_index_rank <- 
    factor(dat$urban_sprawl_index_rank, levels=c("high", "med high", "med", "low"))
  

  community_social_vulnerability <- dat |>
    # Filter only Northeast region
    #dplyr::filter(REGION == "Northeast") |>
    # Deselect unnecessary columns
    dplyr::select(!c("MAPNAME", "geography", "REGION")) |>
    # can't do this and keep correct data attributes (numeric and factor)
    # tidyr::pivot_longer(cols = c("TOTPOP",
    #                              "personal_disruption",
    #                              "pop_composition",
    #                              "poverty",
    #                              "labor_force_str",
    #                              "housing_characteristics",
    #                              "housing_disrupt",
    #                              "retiree_migration",
    #                              "urban_sprawl_index",
    #                              "ComEng",
    #                              "ComRel",
    #                              "RecEng",
    #                              "RecRel",
    #                              "RecEng_ct",
    #                              "RecRel_ct",
    #                              "ComEng_ct",
    #                              "ComRel_ct",
    #                              "personal_disruption_rank",
    #                              "pop_composition_rank",
    #                              "poverty_rank",
    #                              "labor_force_str_rank",
    #                              "housing_characteristics_rank",
    #                              "housing_disrupt_rank",
    #                              "retiree_migration_rank",
    #                              "urban_sprawl_index_rank"),
    #                       names_to = "Var", values_to = "Value") |>
    dplyr::rename("State" = "STATEABBR",
                  "City" = "GEO_NAME",
                  "Time" = "year") |>
    dplyr::left_join(EPUlook, by = "State")

  if (save_clean){
    usethis::use_data(community_social_vulnerability, overwrite = T)
  } else {
    return(community_social_vulnerability)
  }
}
get_community_social_vulnerability(save_clean = T)
