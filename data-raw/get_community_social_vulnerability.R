#### Get Community Social Vulnerability Indicators (CSVI)

library(dplyr)
library(tidyr)

# Set directory
raw.dir <- here::here("data-raw")

# Define input files
comm_social_vuln_csv <- "fishdata_2022_CSVI_1-23-2025.csv"

get_community_social_vulnerability <- function(save_clean = F){
  # Create data frame to define State-EPU
  df<- data.frame(State = c("ME", "MA", "RI", "CT", "DE", "NH", "NY", "NJ", "MD", "VA", "NC", "PA"),
                  EPU = c("NE", "NE", "NE", "NE", "NE", "NE","MAB","MAB","MAB","MAB","MAB","MAB"))

  community_social_vulnerability <- read.csv(file.path(raw.dir,comm_social_vuln_csv))


  community_social_vulnerability$ComEng <- as.character(community_social_vulnerability$ComEng)
  community_social_vulnerability$ComRel <- as.character(community_social_vulnerability$ComRel)
  community_social_vulnerability$RecEng <- as.character(community_social_vulnerability$RecEng)
  community_social_vulnerability$RecRel <- as.character(community_social_vulnerability$RecRel)


  community_social_vulnerability <- community_social_vulnerability |>
    # Filter only Northeast region
    dplyr::filter(REGION == "Northeast") |>
    # Deselect unnecessary columns
    dplyr::select(!c("GEO_NAME", "geography", "REGION")) |>
    tidyr::pivot_longer(cols = c("TOTPOP",
                                 "personal_disruption",
                                 "pop_composition",
                                 "poverty",
                                 "labor_force_str",
                                 "housing_characteristics",
                                 "housing_disrupt",
                                 "retiree_migration",
                                 "urban_sprawl_index",
                                 "ComEng",
                                 "ComRel",
                                 "RecEng",
                                 "RecRel",
                                 "RecEng_ct",
                                 "RecRel_ct",
                                 "ComEng_ct",
                                 "ComRel_ct",
                                 "personal_disruption_rank",
                                 "pop_composition_rank",
                                 "poverty_rank",
                                 "labor_force_str_rank",
                                 "housing_characteristics_rank",
                                 "housing_disrupt_rank",
                                 "retiree_migration_rank",
                                 "urban_sprawl_index_rank"),
                          names_to = "Var", values_to = "Value") |>
    dplyr::rename("State" = "STATEABBR",
                  "City" = "MAPNAME",
                  "Time" = "year") |>
    left_join(df, by = "State")

  if (save_clean){
    usethis::use_data(community_social_vulnerability, overwrite = T)
  } else {
    return(community_social_vulnerability)
  }
}
get_community_social_vulnerability(save_clean = T)
