#### Get Community Climate Change Risk Indicators (CCCRI)

library(readxl)
library(dplyr)
library(tidyr)

# Set directory
raw.dir <- here::here("data-raw")

# Define input files
comm_clim_vuln_xlsx <- "NE_CCCVI_00_22.xlsx"
comm_clim_subregion_xlsx <- "SOE SubRegions_CCCRI_Clean.xlsx"

get_community_climate_vulnerability <- function(save_clean = F){
  # Create data frame to define State-EPU
  df<- data.frame(State = c("ME", "MA", "RI", "CT", "DE", "NH", "NY", "NJ", "MD", "VA", "NC"),
                  EPU = c("NE", "NE", "NE", "NE", "MAB", "NE","MAB","MAB","MAB","MAB","MAB"))

  # Transform vulnerability input file into SOE format
  community_climate_vulnerability <- readxl::read_excel(file.path(raw.dir,comm_clim_vuln_xlsx),
                                                        sheet = "NE_CCCVI_Final00_22") |>
    dplyr::mutate(Units = NA_character_) |>
    tidyr::pivot_longer(cols = c("class_lbs_percent",
                                 "class_val_percent",
                                 "oaSum",
                                 "tempSum",
                                 "stckSum",
                                 "sensSum",
                                 "vulnSum",
                                 "RegionalQuotientLbs",
                                 "RegionalQuotientVal",
                                 "recsimplb_all",
                                 "recsimplvl_all",
                                 "oaSum_region",
                                 "tempSum_region",
                                 "stckSum_region",
                                 "sensSum_region",
                                 "vulnSum_region"),
                        names_to = "Var", values_to = "Value") |>
    dplyr::rename("State" = "STATE_ABB",
                  "Port" = "PORT_NAME",
                  "Time" = "YEAR") |>
    left_join(df, by = "State") |>
    tidyr::unite("PortState", c(Port, State), sep = ", ") |>
    tidyr::unite("Var", c(PortState,Var), sep = "-") |>
    dplyr::select(Time, Var, Value, EPU, Units)

  # Transform NE subregion input file into SOE format
  community_climate_newengland <- readxl::read_excel(file.path(raw.dir,comm_clim_subregion_xlsx),
                                                        sheet = "NewEngland SOE_CCCRI_Clean") |>
    dplyr::select("YEAR","TempSum","STCKSum","OASum","SENSSum","VULNSum","TempSumLB","STCKSumLB","OASumLB","SENSSumLB","VULNSumLB") |>
    tidyr::pivot_longer(cols = c("TempSum",
                                 "STCKSum",
                                 "OASum",
                                 "SENSSum",
                                 "VULNSum",
                                 "TempSumLB",
                                 "STCKSumLB",
                                 "OASumLB",
                                 "SENSSumLB",
                                 "VULNSumLB"),
                        names_to = "Var", values_to = "Value") |>
    dplyr::mutate(EPU = "NE",
                  Var2 = "Regional",
                  Units = "value") |>
    dplyr::mutate(Units = case_when(stringr::str_detect(Var, "LB") ~ "pounds",
                                    stringr::str_detect(Var, "LB", negate = T) ~ "value")) |>
    dplyr::rename("Time" = "YEAR") |>
    tidyr::unite("Var", c(Var2,Var), sep = "-") |>
    dplyr::select(Time, Var, Value, EPU, Units)

  # Transform MAB subregion input file into SOE format
  community_climate_midatlantic <- readxl::read_excel(file.path(raw.dir,comm_clim_subregion_xlsx),
                                                     sheet = "MidAtlantic SOE_CCCRI_Clean") |>
    dplyr::select("YEAR","TempSum","STCKSum","OASum","SENSSum","VULNSum","TempSumLB","STCKSumLB","OASumLB","SENSSumLB","VULNSumLB") |>
    tidyr::pivot_longer(cols = c("TempSum",
                                 "STCKSum",
                                 "OASum",
                                 "SENSSum",
                                 "VULNSum",
                                 "TempSumLB",
                                 "STCKSumLB",
                                 "OASumLB",
                                 "SENSSumLB",
                                 "VULNSumLB"),
                        names_to = "Var", values_to = "Value") |>
    dplyr::mutate(EPU = "MAB",
                  Var2 = "Regional",
                  Units = "value") |>
    dplyr::mutate(Units = case_when(stringr::str_detect(Var, "LB") ~ "pounds",
                                    stringr::str_detect(Var, "LB", negate = T) ~ "value")) |>
    dplyr::rename("Time" = "YEAR") |>
    tidyr::unite("Var", c(Var2,Var), sep = "-") |>
    dplyr::select(Time, Var, Value, EPU, Units)

  community_climate_vulnerability <- rbind(community_climate_vulnerability,
                                           community_climate_newengland,
                                           community_climate_midatlantic)

  # 2022 data were found to be incomplete
  # Removing from ecodata until further review
  community_climate_vulnerability <- dplyr::filter(community_climate_vulnerability, Time != 2022)


    if (save_clean){
      usethis::use_data(community_climate_vulnerability, overwrite = T)
    } else {
      return(community_climate_vulnerability)
    }
}
get_community_climate_vulnerability(save_clean = T)
