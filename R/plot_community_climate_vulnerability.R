#' plot community climate vulnerability
#'
#' Plots time series of proportion of communities in each climate sensitivity category, or regional sensitivities
#'
#' @param shadedRegion Numeric vector. Years denoting the shaded region of the plot (most recent 10)
#' @param report Character string. Which SOE report ("MidAtlantic", "NewEngland")
#' @param varName Character string. Which variable: ocean acidification sensitivity,
#' temperature sensitivity, stock biomass sensitivity, total sensitivity, total vulnerability
#' ("oaSum","tempSum","stckSum","sensSum","vulnSum")
#' @param plottype Character string. Which plot: proportion of communities (default) 
#' or regional sensitivity by revenue or landings ("propcomm", "regionrev", "regionland")
#' @param n Numeric scalar. Number of years used (from most recent year) to estimate short term trend . Default = 0 (No trend calculated)
#'
#' @return ggplot object
#'
#'
#' @export
#'

plot_community_climate_vulnerability <- function(shadedRegion = NULL,
                              report="MidAtlantic",
                              varName = "vulnSum",
                              plottype = "propcomm",
                              n = 0) {

  # generate plot setup list (same for all plot functions)
  setup <- ecodata::plot_setup(shadedRegion = shadedRegion,
                               report=report)

  # which report? this may be bypassed for some figures
  if (report == "MidAtlantic") {
    filterEPUs <- c("MAB")
  } else {
    filterEPUs <- setup$region_abbr
  }

  # optional code to wrangle ecodata object prior to plotting
  # e.g., calculate mean, max or other needed values to join below

   vulquants <- data.frame(ymin = c(1,1.51,2.51,3.51),
                           ymax = c(1.5,2.5,3.5,4),
                           category = c("Low",
                                        "Moderate",
                                        "High",
                                        "Very High"))

   risk = c("darkgreen", "yellow3", "orange", "red")
   names(risk) <- c("Low","Moderate","High","Very High")

   varTitle <- c("Ocean Acidification Sensitivity", "Temperature Sensitivity", "Biomass Status Sensitivity",
                 "Total Climate Sensitivity", "Total Climate Vulnerability")
   names(varTitle) <- c("oaSum","tempSum","stckSum",
                        "sensSum","vulnSum")
   
   if(plottype=="propcomm"){ #proportion of communities
     
     props <- ecodata::community_climate_vulnerability |>
       dplyr::filter(!stringr::str_detect(Var, "Regional-")) |>
       tidyr::separate(Var, into = c("Town", "StateVar"), sep = ",") |> #using two steps because some towns have - in the name
       tidyr::separate(StateVar, into = c("State", "Var"), sep = "-") |> # which also seps the variable
       tidyr::unite("Town", c(Town, State), sep = ",") |>
       dplyr::filter(!is.na(Value), #remove communities with no ranking in a given year
                     Var %in% varName,
                     EPU %in% filterEPUs) |>
       #dplyr::select(Time, Port, State, Var) |>
       dplyr::group_by(Time, EPU) |>
       dplyr::mutate(commn = dplyr::n(),
                     risk = dplyr::case_when(Value <= 1.5 ~ "Low",
                                             Value > 3.5 ~ "Very High",
                                             Value > 1.5 & Value <= 2.5 ~ "Moderate",
                                             Value > 2.5 & Value <= 3.5 ~ "High")) |>
       dplyr::group_by(Time, EPU, risk) |>
       dplyr::mutate(catn = dplyr::n(),
                     propcat = catn/commn)
     
     propsonly <- props |>
       dplyr::select(Time, EPU, risk, propcat) |>
       dplyr::distinct()
     
     # code for generating plot object p
     # ensure that setup list objects are called as setup$...
     # e.g. fill = setup$shade.fill, alpha = setup$shade.alpha,
     # xmin = setup$x.shade.min , xmax = setup$x.shade.max
     #
     
     p <- ggplot2::ggplot() + 
       ggplot2::annotate("rect", fill = setup$shade.fill, alpha = setup$shade.alpha,
                         xmin = setup$x.shade.min , xmax = setup$x.shade.max,
                         ymin = -Inf, ymax = Inf) +
       #, group=PORT_NAME
       #ggplot2::geom_line(aes(group = PORT_NAME), alpha = 0.05) +
       # ggplot2::geom_rect(data = vulquants,
       #                    aes(ymin = ymin, ymax = ymax, fill = category, xmin = -Inf, xmax = Inf),
       #                    alpha = .3) +
       #ggplot2::scale_fill_manual(values=risk) +
       ggplot2::geom_point(data=propsonly, ggplot2::aes(x=Time, y=propcat, color=risk)) +
       ggplot2::geom_line(data=propsonly,ggplot2::aes(x=Time, y=propcat, color=risk)) +
       ggplot2::scale_color_manual(values=risk,
                                   breaks=c('Low', 'Moderate', 'High', 'Very High'),
                                   name=varTitle[varName]) +
       ggplot2::facet_wrap(~EPU) +
       #ggplot2::ylim(1,4) +
       ggplot2::theme_bw() +
       #ggplot2::ggtitle("Mid-Atlantic") +
       #ggplot2::theme(legend.position = "blank")
       ggplot2::ylab("Proportion communities") +
       ecodata::geom_lm(n=n) +
       ecodata::theme_ts()+
       ecodata::theme_facet()+
       ecodata::theme_title()
     
     
     return(p)
     
   }else{ #regional plots
     
     if(plottype == "regionrev"){
       units <- "value"
       type <- "Revenue"
     }else{
       units <- "pounds"
       type <- "Landings"
     }
     
     regional <- ecodata::community_climate_vulnerability |>
       dplyr::filter(stringr::str_detect(Var, "Regional-")) |>
       dplyr::mutate(Varin = stringr::str_extract(Var, '\\b\\w+$'), #keep everything before -
                     Varpre = stringr::str_to_lower(stringr::str_split_i(Varin, "Sum", 1)),
                     Var = paste0(Varpre, "Sum")) |>
       dplyr::filter(Var %in% varName,
                     EPU %in% filterEPUs,
                     Units %in% units)
     
     p <- ggplot2::ggplot() +
       #Highlight last ten years
       ggplot2::annotate("rect", fill = setup$shade.fill, alpha = setup$shade.alpha,
                         xmin = setup$x.shade.min , xmax = setup$x.shade.max,
                         ymin = -Inf, ymax = Inf) +
       ggplot2::geom_rect(data = vulquants,
                          ggplot2::aes(ymin = ymin, ymax = ymax, fill = category, xmin = -Inf, xmax = Inf),
                          alpha = .3) +
       ggplot2::scale_fill_manual(values=risk,
                                  breaks=c('Low', 'Moderate', 'High', 'Very High'),
                                  name=varTitle[varName]) + 
       # ecodata::geom_gls(data = regional, ggplot2::aes(x = Time, y = Value,
       #                              group = Var),
       #                 alpha = setup$trend.alpha, size = setup$trend.size) +
       ecodata::geom_lm(data = regional,n=n, ggplot2::aes(x = Time, y = Value,
                                          group = Var),
                        alpha = setup$trend.alpha, size = setup$trend.size) +
       ggplot2::geom_line(data = regional, ggplot2::aes(x = Time, y = Value), linewidth = setup$lwd) +
       ggplot2::geom_point(data = regional, ggplot2::aes(x = Time, y = Value), size = setup$pcex) +
       ggplot2::facet_wrap(~EPU) +
       #ggplot2::ylim(1,4) +
       ggplot2::theme_bw() +
       #ggplot2::ggtitle("Mid-Atlantic") +
       #ggplot2::theme(legend.position = "blank")
       ggplot2::ylab(paste("Regional", type, varTitle[varName])) +
       ecodata::theme_ts()+
       ecodata::theme_facet()+
       ecodata::theme_title()
     
     
     return(p)
     
                     
       
   }
   
   
}

attr(plot_community_climate_vulnerability,"report") <- c("MidAtlantic","NewEngland")
attr(plot_community_climate_vulnerability,"varName") <- c("oaSum","tempSum","stckSum","sensSum","vulnSum")
attr(plot_community_climate_vulnerability,"plottype") <- c("propcomm", "regionrev", "regionland")


