---
title: "Macrofauna MAB and Shelf-wide"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    theme: lumen
    self_contained: false
    lib_dir: libs
---

```{r setup, include=FALSE}
#Image Directory
image.dir <- here::here("workshop/images")

#Default Rmd options
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center') #allows for inserting R code into captions

#Plotting and data libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(ecodata)
library(here)
library(kableExtra)
library(ggrepel)
library(stringr)
library(patchwork)
library(grid)
library(ggiraph)
library(vegan)
library(rpart)
library(colorRamps)
library(cowplot)

#GIS libraries
library(sf)
library(rgdal)
library(raster)


#GIS directory
gis.dir <- here::here("data-raw","gridded")

#General inline text input for report
#Council
council <- "Mid-Atlantic Fishery Management Council"
council_abbr <- "MAFMC"

#Region identifiers
epu <- "Mid-Atlantic Bight"
epu_abbr <- "MAB"
region <- "Mid-Atlantic"
region_abbr <- "MA" #Some commercial data organized by "MA" or "NE" regions, not by EPU 


```

```{r GIS-setup}

#CRS
crs <- "+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0 +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#EPU shapefile
epu_sf <- ecodata::epu_sf %>% 
  filter(EPU %in% c("MAB","GB","GOM"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -77
xmax = -65
ymin = 36
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

#Time series constants
shade.alpha <- 0.3
shade.fill <- "lightgrey"
lwd <- 1
pcex <- 2
trend.alpha <- 0.5
trend.size <- 2
hline.size <- 1
hline.alpha <- 0.35
hline.lty <- "dashed"
label.size <- 5
hjust.label <- 1.5
letter_size <- 4
feeding.guilds <- c("Apex Predator","Piscivore","Planktivore","Benthivore","Benthos")
x.shade.min <- 2012
x.shade.max <- 2022
series.col <- c("indianred","black")
#Function for custom ggplot facet labels
label <- function(variable,value){
  return(facet_names[value])
}
```

Trend lines are shown when slope is significantly different from 0 at the p < 0.05 level. An orange line signifies an overall positive trend, and purple signifies a negative trend. To minimize bias introduced by small sample size, no trend is fit when N < 30. Dashed lines represent mean values of time series unless the indicator is an anomaly, in which case the dashed line is equal to 0. Shaded regions indicate the past ten years. If there are no new data for 2018, the shaded region will still cover this time period.

## Mid-Atlantic Bight

### Surveys {.tabset .tabset-fade}



#### NEFSC BTS & NEAMAP 


```{r aggregate-biomass, fig.cap = paste0("Spring (left) and fall (right) surveyed biomass in the Mid-Atlantic Bight. Data from the NEFSC Bottom Trawl Survey are shown in black, with NEAMAP shown in red. \\label{nefsc-biomass}")}
agg<-ecodata::aggregate_biomass %>%
  dplyr::filter(EPU == "MAB",
                !stringr::str_detect(Var, "Apex|inshore|offshore|managed|NEFMC|MAFMC|JOINT|NA")) %>% #remove unused datasets
  tidyr::separate(Var, c("feeding.guild", "season", "Biomass", "Var1", "Null", "Area"), sep = " ") %>%
  tidyr::unite("Var", feeding.guild:season, sep = " ") %>%
  dplyr::mutate(stat = recode(Var1, Index = "Mean",
                      Standard = "SD")) %>%
  dplyr::select(-Biomass, -Var1, -Null, -Units) %>%
  # dplyr::filter(!Area == "-") %>%
  dplyr::group_by(Var, Time, EPU, Area) %>%
  tidyr::pivot_wider(id_cols = c(Var, Time, EPU, Area),names_from =  stat, values_from =  Value) %>%
  dplyr::filter(!Mean == "NULL", 
                !Time == 2020) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Mean = as.numeric(Mean), 
                SD = as.numeric(SD))


agg_bio<-agg %>% dplyr::filter(EPU == epu_abbr,
         Time >= 1968) %>%
  dplyr::group_by(Var, EPU) %>%
  dplyr::mutate(hline = mean(Mean, na.rm = T), 
                 upper = Mean + (2*SD),
                lower = Mean - (2*SD)) %>%
  dplyr::ungroup()  
 

agg_bio$Var <- factor(agg_bio$Var,levels = c("Piscivore Spring",
                                                   "Piscivore Fall",
                                                    "Benthivore Spring",
                                                   "Benthivore Fall",
                                                    "Planktivore Spring",
                                                    "Planktivore Fall",
                                                    "Benthos Spring",
                                                   "Benthos Fall"))
series.col <- rep("black",length(unique(agg_bio$Var)))
facet_names <- list("Piscivores" = expression("Piscivores"),
                    "Planktivores" = expression("Planktivores"),
                    "Benthivores" = expression("Benthivores"),
                    "Benthos" = expression("Benthos"))
#Get NEAMAP
neamap <- ecodata::mab_inshore_survey %>%
  tidyr::separate(Var, into = c("Var",  "Val"), sep = "-") %>% 
  tidyr::pivot_wider(names_from = Val, values_from = Value) %>% 
  dplyr::mutate(Value = as.numeric(Value), 
                CV = as.numeric(CV)) %>% 
  dplyr::group_by(Var) %>%
  dplyr::mutate(hline = mean(Value),
         SD = Value * CV, #calculate SD from CV
         upper = Value + (2*SD),
         lower = Value - (2*SD))

neamap$Var <- factor(neamap$Var,levels = c("Piscivore Spring","Piscivore Fall",
                                           "Benthivore Spring", "Benthivore Fall",
                                           "Planktivore Spring", "Planktivore Fall",
                                           "Benthos Spring", "Benthos Fall"))
## Piscivore
neamap.1<-neamap %>%
  dplyr::filter(stringr::str_detect(Var,"Piscivore"))
p1<-agg_bio %>%
  dplyr::filter(stringr::str_detect(Var,"Piscivore")) %>%
  ggplot2::ggplot() +

  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  #Test for trend and add lines
  ecodata::geom_gls(aes(x = Time, y = Mean,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  # ecodata::geom_lm(aes(x = Time, y = Mean,
  #              color = Var),
  #            alpha = trend.alpha, size = trend.size) +
  #ecodata::geom_lm(aes(x = Time, y = Mean))+

  #Add time series
  ggplot2::geom_ribbon(aes(x = Time, ymin = pmax(lower,0), ymax = upper),
              alpha = 0.5,
              fill = "grey") +
  ggplot2::geom_line(aes(x = Time, y = Mean),size = lwd-0.5) +
  ggplot2::geom_point(aes(x = Time, y = Mean),size = pcex-0.5) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  ggplot2::facet_wrap(Var~.,ncol = 2) +
     #Add NEAMAP
  ggplot2::geom_ribbon(data = neamap.1, aes(x = Time, ymin = pmax(lower,0), ymax = upper),
              alpha = 0.5,
              fill = "pink")+
  ggplot2::geom_line(data = neamap.1, aes(x = Time, y = Value),
            color = "#ca0020")+
  ggplot2::geom_point(data = neamap.1, aes(x = Time, y = Value),
             size = pcex-0.5,
             color = "#ca0020")+

  #Axis and theme
  ggplot2::scale_x_continuous(breaks = seq(1970, 2020, by = 10), expand = c(0.01, 0.01)) +
  #ylim(0, 1200)+
  ggplot2::ylab(expression("Biomass (kg tow"^-1*")")) +
  ecodata::theme_facet()+
  ggplot2::theme(strip.text=element_text(hjust=0),
        axis.title.x=element_blank())

## Benthivore
neamap.2<-neamap %>%
  dplyr::filter(stringr::str_detect(Var,"Benthivore"))
p2<-agg_bio %>%
  dplyr::filter(stringr::str_detect(Var,"Benthivore")) %>%
  ggplot2::ggplot() +

  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  #Test for trend and add lines
  ecodata::geom_gls(aes(x = Time, y = Mean,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  # ecodata::geom_lm(aes(x = Time, y = Mean,
  #              color = Var),
  #            alpha = trend.alpha, size = trend.size) +
  #ecodata::geom_lm(aes(x = Time, y = Mean))+

  #Add time series
  ggplot2::geom_ribbon( aes(x = Time, ymin = pmax(lower,0), ymax = upper),
              alpha = 0.5,
              fill = "grey") +
  ggplot2::geom_line(aes(x = Time, y = Mean),size = lwd-0.5) +
  ggplot2::geom_point(aes(x = Time, y = Mean),size = pcex-0.5) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  ggplot2::facet_wrap(Var~.,ncol = 2) +
       #Add NEAMAP
  ggplot2::geom_ribbon(data = neamap.2, aes(x = Time, ymin = pmax(lower,0), ymax = upper),
              alpha = 0.5, fill = "pink")+
  ggplot2::geom_line(data = neamap.2, aes(x = Time, y = Value),
            color = "#ca0020")+
  ggplot2::geom_point(data = neamap.2, aes(x = Time, y = Value),
             size = pcex-0.5,
             color = "#ca0020")+

  #Axis and theme
  ggplot2::scale_x_continuous(breaks = seq(1970, 2020, by = 10), expand = c(0.01, 0.01)) +
  ggplot2::ylab(expression("Biomass (kg tow"^-1*")")) +
  ecodata::theme_facet()+
  ggplot2::theme(strip.text=element_text(hjust=0),
        axis.title.x=element_blank())


### Planktivore
neamap.3<-neamap %>%
  dplyr::filter(stringr::str_detect(Var,"Planktivore"))
p3<-agg_bio %>%
  dplyr::filter(stringr::str_detect(Var,"Planktivore")) %>%
  ggplot2::ggplot() +

  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  #Test for trend and add lines
  ecodata::geom_gls(aes(x = Time, y = Mean,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  # ecodata::geom_lm(aes(x = Time, y = Mean,
  #              color = Var),
  #            alpha = trend.alpha, size = trend.size) +
  #ecodata::geom_lm(aes(x = Time, y = Mean))+

  #Add time series
  ggplot2::geom_ribbon(aes(x = Time, ymin = pmax(lower,0), ymax = upper),
              alpha = 0.5,
              fill = "grey") +
  ggplot2::geom_line(aes(x = Time, y = Mean),size = lwd-0.5) +
  ggplot2::geom_point(aes(x = Time, y = Mean),size = pcex-0.5) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  ggplot2::facet_wrap(Var~.,ncol = 2) +
       #Add NEAMAP
  ggplot2::geom_ribbon(data = neamap.3, aes(ymax = pmax(upper, 0), ymin = lower, x = Time),
                fill = "pink", alpha = 0.5) +
  ggplot2::geom_line(data = neamap.3, aes(x = Time, y = Value),
            color = "#ca0020")+
  ggplot2::geom_point(data = neamap.3, aes(x = Time, y = Value),
             size = pcex-0.5,
             color = "#ca0020")+

  #Axis and theme
  ggplot2::scale_x_continuous(breaks = seq(1970, 2020, by = 10), expand = c(0.01, 0.01)) +
  #ylim(0, 600)+
  ggplot2::ylab(expression("Biomass (kg tow"^-1*")")) +
  ecodata::theme_facet()+
  ggplot2::theme(strip.text=element_text(hjust=0),
        axis.title.x=element_blank())

### Benthos
neamap.4<-neamap %>%
  dplyr::filter(stringr::str_detect(Var,"Benthos"))
p4<-agg_bio %>%
  dplyr::filter(stringr::str_detect(Var,"Benthos")) %>%
  #ggplot(aes(x = Time, y = Mean)) +
  ggplot2::ggplot() +
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  #Test for trend and add lines
  ecodata::geom_gls(aes(x = Time, y = Mean,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  # ecodata::geom_lm(aes(x = Time, y = Mean,
  #              color = Var),
  #            alpha = trend.alpha, size = trend.size) +
  #ecodata::geom_lm(aes(x = Time, y = Mean))+
  #Add time series
   ggplot2::geom_ribbon( aes(x = Time, ymin = pmax(lower,0), ymax = upper),
               alpha = 0.5,
               fill = "grey") +
  ggplot2::geom_line(aes(x = Time, y = Mean),size = lwd-0.5) +
  ggplot2::geom_point(aes(x = Time, y = Mean), size = pcex-0.5) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  ggplot2::facet_wrap(Var~.,ncol = 2) +
       #Add NEAMAP
  ggplot2::geom_ribbon(data = neamap.4, aes(ymax = pmax(upper, 0), ymin = lower, x = Time),
              fill = "pink", alpha = 0.5) +
  ggplot2::geom_line(data = neamap.4, aes(x = Time, y = Value),
            color = "#ca0020")+
  ggplot2::geom_point(data = neamap.4, aes(x = Time, y = Value),
             size = pcex-0.5,
             color = "#ca0020")+

  ggplot2::scale_x_continuous(breaks = seq(1970, 2020, by = 10), expand = c(0.01, 0.01)) +

  ggplot2::ylab(expression("Biomass (kg tow"^-1*")")) +
  ecodata::theme_facet()+
  ggplot2::theme(strip.text=element_text(hjust=0),
        axis.title.x=element_blank())
cowplot::plot_grid(p1, p2, p3, p4, nrow=4)
```

#### Just NEAMAP
```{r mab-inshore-survey}
#Get NEAMAP
neamap <- ecodata::mab_inshore_survey %>%
  tidyr::separate(Var, into = c("Var",  "Val"), sep = "-") %>% 
  tidyr::pivot_wider(names_from = Val, values_from = Value) %>%  
  dplyr::mutate(Value = as.numeric(Value), 
                CV = as.numeric(CV)) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value),
         SD = Value * CV, #calculate SD from CV
         upper = Value + (2*SD), 
         lower = Value - (2*SD))

neamap$Var <- factor(neamap$Var,levels = c("Piscivore Spring","Piscivore Fall",
                                           "Benthivore Spring", "Benthivore Fall",
                                           "Planktivore Spring", "Planktivore Fall",  
                                           "Benthos Spring", "Benthos Fall"))
## Piscivore 
neamap %>% 
  ggplot2::ggplot() +
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  #Test for trend and add lines
  ecodata::geom_gls(aes(x = Time, y = Value,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  # ecodata::geom_lm(aes(x = Time, y = Value,
  #              color = Var),
  #            alpha = trend.alpha, size = trend.size) +

  #Add time series
  ggplot2::geom_ribbon(aes(x = Time, ymin = pmax(lower,0), ymax = upper), 
              alpha = 0.5,
              fill = "grey") +
  ggplot2::geom_line(aes(x = Time, y = Value),size = lwd-0.5) +
  ggplot2::geom_point(aes(x = Time, y = Value),size = pcex-0.5) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  ggplot2::facet_wrap(Var~.,ncol = 2) +

  #Axis and theme
  #ggplot2::scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  #ylim(0, 1200)+
  ggplot2::ylab(expression("Biomass (kg tow"^-1*")")) +
  ecodata::theme_facet()+
  ggplot2::theme(strip.text=element_text(hjust=0), 
        axis.title.x=element_blank())

```




#### Proportion managed species in NEFSC BTS


<!-- ```{r nefsc-survey-disaggregated-managed-spp-bts} -->
<!-- prop <- ecodata::nefsc_survey_disaggregated %>%  -->
<!--   dplyr::filter(!stringr::str_detect(`Feeding guild`, "Other|other"), -->
<!--          !is.na(Proportion)) %>% #remove "other" -->
<!--   tidyr::unite(.,Var,c("Feeding guild","Season"), sep = " ") %>%  -->
<!--   dplyr::filter(!stringr::str_detect(Var,"Apex|Benthos"), -->
<!--          !is.na(Management)) %>% #remove benthos and apex predators -->
<!--   dplyr::group_by(EPU, Management, Var, Time) %>% -->
<!--   dplyr::summarise(Proportion = sum(Proportion)) %>%  -->
<!--   dplyr::mutate(Var2 = paste(Management,Var), -->
<!--          tt = paste(Management,round(Proportion,2), Time), -->
<!--          Proportion = ifelse(Proportion == 0, NA, Proportion)) %>% #tt = tooltip -->
<!--   dplyr::group_by(EPU,Var2) %>%  -->
<!--   dplyr::mutate(hline = mean(Proportion,na.rm = T)) %>%  -->
<!--   tidyr::complete(Time = full_seq(min(.$Time):max(.$Time),1), -->
<!--            tidyr::nesting(Management, Var))  -->


<!-- #Change factor levels -->
<!-- prop$Var <- factor(prop$Var,levels = c("Piscivore spring","Piscivore fall", -->
<!--                                        "Benthivore spring","Benthivore fall",             -->
<!--                                        "Planktivore spring", "Planktivore fall" )) -->

<!-- mab_prop <-  -->
<!--   prop %>%  -->
<!--     dplyr::filter(EPU == "MAB") %>%  -->
<!-- ggplot2::ggplot(aes(x = Time, y = Proportion, color = Management, group = Var2)) + -->

<!--   #Highlight last ten years -->
<!--   ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--            xmin = x.shade.min , xmax = x.shade.max , -->
<!--            ymin = -Inf, ymax = Inf) + -->

<!--   #Add time series -->
<!--   ggplot2::geom_line(size = 0.5) + -->
<!--   ggiraph::geom_point_interactive(aes(tooltip = tt),size = 0.5) + -->
<!-- #  guides(color = FALSE) + -->
<!--   ggplot2::geom_hline(aes(yintercept = hline, -->
<!--                  group = Var2, -->
<!--                  color = Management), -->
<!--              size = 0.5, -->
<!--              alpha = hline.alpha, -->
<!--              linetype = hline.lty)+ -->

<!--   #Facet  -->
<!--   ggplot2::facet_wrap(Var~., ncol = 2) + -->

<!--   #Axis and theme -->
<!--   ggplot2::scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) + -->
<!--   ggplot2::ylab(expression("Proportion of survey")) + -->
<!--   ggplot2::ggtitle("MAB") + -->
<!--   ecodata::theme_facet()+ -->
<!--   ggplot2::theme(strip.text=element_text(hjust=0)) -->
<!-- mab_prop <- ggiraph::girafe(ggobj = mab_prop) -->
<!-- mab_prop <- ggiraph::girafe_options(mab_prop, opts_zoom(max = 5) ) -->
<!-- mab_prop -->
<!-- ``` -->

#### MAFMC Planktivores in NE


<!-- ```{r nefsc-survey-disaggregated-mafmc-spp-in-ne} -->
<!-- mafmc_ne <- ecodata::nefsc_survey_disaggregated %>%  -->
<!--   dplyr::distinct() %>%  -->
<!--   dplyr::filter(EPU %in% c("GOM","GB"), -->
<!--          Management == "MAFMC", -->
<!--          !stringr::str_detect(`Feeding guild`,"Other")) %>%  -->
<!--   dplyr::group_by(EPU, `Feeding guild`, Season, Time) %>%  -->
<!--   dplyr::summarise(Value = sum(Proportion,na.rm = T)) %>% #IMPORTANT: Turn zeros to NA before taking mean -->
<!--   dplyr::mutate(Value = ifelse(Value == 0, NA, Value)) %>% #Turn zeros to NA -->
<!--   tidyr::unite(.,Var,c("Feeding guild","Season"), sep = " ") %>%  -->
<!--   dplyr::group_by(EPU,Var) %>%  -->
<!--   dplyr::mutate(hline = mean(Value, na.rm = T)) %>%  -->
<!--   dplyr::filter(stringr::str_detect(Var,"Planktivore")) %>%  -->
<!--   dplyr::ungroup() %>%  -->
<!--   dplyr::mutate(Var = paste(stringr::str_to_title(stringr::str_extract(Var, "fall|spring")), -->
<!--          "survey")) -->
<!-- mafmc_ne$Var <- factor(mafmc_ne$Var,levels = c("Spring survey","Fall survey")) -->
<!-- gom_mafmc_props <- mafmc_ne %>%  -->
<!--   dplyr::filter(EPU == "GOM") %>%  -->
<!--  ggplot2::ggplot(aes(x = Time, y = Value, group = Var)) + -->

<!--   #Highlight last ten years -->
<!--   ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max , -->
<!--       ymin = -Inf, ymax = Inf) + -->

<!--   #Add time series -->
<!--   ggplot2::geom_line(size = lwd-0.5) + -->
<!--   ggplot2::geom_point(size = pcex-0.5) + -->
<!--   # scale_color_manual(values = series.col, aesthetics = "color")+ -->
<!--   ggplot2::guides(color = FALSE) + -->
<!--   ggplot2::geom_hline(aes(yintercept = hline, -->
<!--                  group = Var), -->
<!--              size = hline.size, -->
<!--              alpha = hline.alpha, -->
<!--              linetype = hline.lty)+ -->

<!--   #Facet  -->
<!--   ggplot2::facet_wrap(Var~.,scales = "free_y", ncol = 2) + -->
<!--   ggplot2::ggtitle("MAFMC planktivores in Gulf of Maine")+ -->
<!--   #Axis and theme -->
<!--   ggplot2::scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) + -->
<!--   ggplot2::ylab(expression("Proportion of GOM survey")) + -->
<!--   ecodata::theme_facet()+ -->
<!--   ggplot2::theme(strip.text=element_text(hjust=0)) -->

<!-- gb_mafmc_props <- mafmc_ne %>%  -->
<!--   dplyr::filter(EPU == "GB") %>%  -->
<!-- ggplot2::ggplot(aes(x = Time, y = Value, group = Var)) + -->

<!--   #Highlight last ten years -->
<!--   ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max , -->
<!--       ymin = -Inf, ymax = Inf) + -->

<!--   #Test for trend and add lines -->
<!--   # geom_gls(aes(x = Time, y = Value, -->
<!--   #              color = Var), -->
<!--   #            alpha = trend.alpha, size = trend.size) + -->

<!--   #Add time series -->
<!--   ggplot2::geom_line(size = lwd-0.5) + -->
<!--   ggplot2::geom_point(size = pcex-0.5) + -->
<!--   # scale_color_manual(values = series.col, aesthetics = "color")+ -->
<!--   ggplot2::guides(color = FALSE) + -->
<!--   ggplot2::geom_hline(aes(yintercept = hline, -->
<!--                  group = Var), -->
<!--              size = hline.size, -->
<!--              alpha = hline.alpha, -->
<!--              linetype = hline.lty)+ -->

<!--   #Facet  -->
<!--   ggplot2::facet_wrap(Var~.,scales = "free_y", ncol = 2) + -->
<!--   ggplot2::ggtitle("MAFMC planktivores on Georges Bank")+ -->
<!--   #Axis and theme -->
<!--   ggplot2::scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) + -->
<!--   ggplot2::ylab("Proportion of GB survey") + -->
<!--   ecodata::theme_facet()+ -->
<!--   ggplot2::theme(strip.text=element_text(hjust=0)) -->


<!-- gom_mafmc_props + gb_mafmc_props + patchwork::plot_layout(ncol = 1) -->


<!-- ``` -->

### Survey Shannon Diversity

```{r survey-shannon}
ecodata::survey_shannon %>% filter(EPU == "MAB") %>% 
  ggplot2::ggplot(aes(x = Time, y = Value, color = Var))+
  ggplot2::geom_point()+
  ggplot2::geom_line()+
  ecodata::geom_gls() +
  #ecodata::geom_lm(aes(x = Time, y = Value, group = Var))+
  ggtitle("MAB Survey Shannon Diversity Index")+
  ggplot2::ylab("Shannon")+
  ggplot2::scale_color_discrete(name = "Season", labels = c("Fall", "Spring"))+
  ecodata::theme_ts()
  
```

### Expected number of Species

```{r exp-n}
exp<- ecodata::exp_n %>% 
  tidyr::separate(Var, into = c("Var", "Season"), sep = "-") %>% 
  dplyr::filter( EPU == "MAB", Season == "FALL", 
                 stringr::str_detect(Var, 'AlbatrossSD|BigelowSD')) %>% 
  dplyr::rename(VarSD = Var, ValueSD = Value) 

exp2<- ecodata::exp_n %>% 
  tidyr::separate(Var, into = c("Var", "Season"), sep = "-") %>% 
  dplyr::filter(EPU == "MAB", Season == "FALL",
         Var %in% c("Albatross", "Bigelow"))   %>% 
  dplyr::left_join(exp) %>% 
  dplyr::mutate(upper = Value+ValueSD, 
         lower = Value - ValueSD)

exp2 %>% 
ggplot2::ggplot(aes(x = Time, y = Value, fill = Var)) +
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +

  ggplot2::geom_ribbon(data = exp2, aes(ymax = pmax(upper, 0), ymin = lower, x = Time),
              alpha = 0.5) +
  ggplot2::geom_line(size = lwd-0.5) +
  ggplot2::geom_point(size = pcex-0.5) +
  #ecodata::geom_lm(aes(x = Time, y = Value, group = Var))+
  #ecodata::geom_lm()+
  # scale_color_manual(values = series.col, aesthetics = "color")+
  #ggplot2::guides(color = FALSE) +
  #ggplot2::geom_hline(aes(yintercept = hline,
  #               group = Var),
  #           size = hline.size,
  #           alpha = hline.alpha,
  #           linetype = hline.lty)+
  ggplot2::facet_wrap(EPU~.,scales = "free_y", ncol = 2) +
  ggplot2::ggtitle("Expected Number of Species - Fall")+
  #ecodata::geom_gls() +
  #Axis and theme
  ggplot2::scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ggplot2::ylab("n species per 1000 ind") +
  ggplot2::xlab(element_blank())+
  ecodata::theme_facet()+
  ggplot2::theme(strip.text=element_text(hjust=0), 
                 legend.title = element_blank())+
  ecodata::theme_title()
```

```{r exp-n-spring}

exp<- ecodata::exp_n %>% 
  tidyr::separate(Var, into = c("Var", "Season"), sep = "-") %>% 
  filter( EPU == "MAB", 
                                   Season == "SPRING", 
                                   stringr::str_detect(Var, 'AlbatrossSD|BigelowSD')) %>% 
    rename(VarSD = Var, 
         ValueSD = Value) 
exp2<- ecodata::exp_n %>% 
  tidyr::separate(Var, into = c("Var", "Season"), sep = "-") %>% 
  filter(EPU == "MAB", 
                                 Season == "SPRING", 
                                 Var %in% c("Albatross", "Bigelow"))   %>% 

  left_join(exp) %>% 
  mutate(upper = Value+ValueSD, 
         lower = Value - ValueSD)

exp2 %>% 
ggplot2::ggplot(aes(x = Time, y = Value, fill = Var)) +
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +

  ggplot2::geom_ribbon(data = exp2, aes(ymax = pmax(upper, 0), ymin = lower, x = Time),
              alpha = 0.5) +
  ggplot2::geom_line(size = lwd-0.5) +
  ggplot2::geom_point(size = pcex-0.5) +
  #ecodata::geom_lm(aes(x = Time, y = Value, group = Var))+
  # scale_color_manual(values = series.col, aesthetics = "color")+
  #ggplot2::guides(color = FALSE) +
  #ggplot2::geom_hline(aes(yintercept = hline,
  #               group = Var),
  #           size = hline.size,
  #           alpha = hline.alpha,
  #           linetype = hline.lty)+
  ggplot2::facet_wrap(EPU~.,scales = "free_y", ncol = 2) +
  ggplot2::ggtitle("Expected Number of Species - Spring")+
  ecodata::geom_gls() +
  #Axis and theme
  ggplot2::scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ggplot2::ylab("n species per 1000 ind") +
  ggplot2::xlab(element_blank())+
  ecodata::theme_facet()+
  ggplot2::theme(strip.text=element_text(hjust=0), 
                 legend.title = element_blank())+
  ecodata::theme_title()


```

### Productivity anomaly


```{r productivity-anomaly, fig.cap = "Small fish per large fish biomass anomaly in the Mid-Atlantic Bight from BTS."}

#### Adjust plot properties -------------------------------
adjustAxes <- 
  ggplot2::theme(axis.title   = element_text(size = 10),
                 axis.text    = element_text(size = 10),
                 plot.title   = element_text(size = 15))


#### Plot stacked bar with cpts for single var ------------
plot_stackbarcpts_single <- function(YEAR, var2bar,
                                     x, xlab, ylab,
                                     titl,
                                     file_suffix,
                                     leg_font_size = 6,
                                     remove_leg = FALSE,
                                     leg_ncol = 1,
                                     wcpts = TRUE,
                                     wdashed = TRUE,
                                     height = 5.5,
                                     width = 8,
                                     filt = TRUE,
                                     label = label,
                                     y.text = y.text,
                                     aggregate = FALSE) {
  
  dat2bar <- data.frame(YEAR, var2bar,
                        x)
  if (filt == TRUE){mab_species <-  list("SUMMER FLOUNDER","SCUP","BLACK SEA BASS","BLUEFISH",
                                         "NORTHERN SHORTFIN SQUID", "LONGFIN SQUID", "ATLANTIC MACKEREL",
                                         "BUTTERFISH","ATLANTIC SURFCLAM", "OCEAN QUAHOG", "TILEFISH",
                                         "BLUELINE TILEFISH","SPINY DOGFISH", "GOOSEFISH")
  dat2plot <-
    dat2bar %>%
    tidyr::gather(variable, value, -YEAR, -var2bar) %>%
    dplyr::mutate(var2bar = gsub(pattern      = "_", 
                                 replacement  = " ", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl.", 
                                 replacement  = "ATLANTIC", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl", 
                                 replacement  = "ATLANTIC", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "NS and combined", 
                                 replacement  = "", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "YT", 
                                 replacement  = "Yellowtail", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " GoM", 
                                 replacement  = " GOM", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " by EPU", 
                                 replacement  = "", 
                                 x            = var2bar)) %>%
    dplyr::filter(var2bar %in% mab_species)
} else if (filt == FALSE){
    dat2plot <-
    dat2bar %>%
    tidyr::gather(variable, value, -YEAR, -var2bar) %>%
    dplyr::mutate(var2bar = gsub(pattern      = "_", 
                                 replacement  = " ", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl.", 
                                 replacement  = "ATLANTIC", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl", 
                                 replacement  = "ATLANTIC", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "NS and combined", 
                                 replacement  = "", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "YT", 
                                 replacement  = "Yellowtail", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " GoM", 
                                 replacement  = " GOM", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " by EPU", 
                                 replacement  = "", 
                                 x            = var2bar))
}
  if (aggregate){
   agg <- dat2plot %>%
     dplyr::group_by(YEAR) %>%
     dplyr::summarise(Total = sum(value, na.rm = T)) %>% 
     dplyr::mutate(Total = ifelse(Total == 0, NA, Total))
  }
  
  p <-   
    ggplot2::ggplot(dat2plot,
           aes(x = YEAR)) +
    ggplot2::geom_bar(data = dat2plot %>% filter(value > 0),
             aes(y = value, fill = var2bar),
             stat = "identity") +
    ggplot2::geom_bar(data = dat2plot %>% filter(value < 0),
             aes(y = value, fill = var2bar),
             stat = "identity") +
    {if(aggregate) geom_line(data = agg,aes(x = YEAR, y = Total),
                             size = 1)} +
    ggplot2::geom_hline(size = 0.3, aes(yintercept = 0)) +
    ggplot2::xlab(xlab) +
    ggplot2::ylab(ylab) +
    ggplot2::ggtitle(titl) +
    ggplot2::guides(fill = guide_legend(ncol = leg_ncol)) +
    ecodata::theme_ts()+
    ggplot2::theme(axis.title   = element_text(size = 12),
          axis.text    = element_text(size = 12),
          plot.title   = element_text(size = 15),
          legend.text  = element_text(size = leg_font_size),
          legend.title = element_blank()) +
    ggplot2::annotate("text", label = label, x = 1980, y = y.text,size = 8, colour = "black")
  

  
  if(remove_leg) p <- p + theme(legend.position = "none")
  
  return(p)
}

bar_dat <- ecodata::productivity_anomaly %>% 
  dplyr::filter(EPU == "MAB") %>% 
  tidyr::separate(Var, into = c("Var", "Survey"), sep = "_")

# mafmc <-plot_stackbarcpts_single(YEAR = bar_dat$Time,
#                          var2bar = bar_dat$Var,
#                          x = bar_dat$Value,
#                          titl = "",
#                          xlab = "",
#                          ylab = "Small fish per large fish biomass (anomaly)",
#                          height = 5.5,
#                          width = 9,
#                          filt = TRUE,
#                          label = "A",
#                          y.text = 4.5)

# 
mid <- plot_stackbarcpts_single(YEAR = bar_dat$Time,
                         var2bar = bar_dat$Var,
                         x = bar_dat$Value,
                         titl = "",
                         xlab = "",
                         ylab = "Small fish per large fish biomass (anomaly)",
                         height = 5.5,
                         width = 9,
                         filt = FALSE,
                         label = "",
                         y.text = 5,
                         aggregate = TRUE)

mid
```

```{r productivity-assessment, fig.cap="Recruitment Anomaly for Mid-Atlantic Stocks from Stock Assessments."}
total<- ecodata::productivity_anomaly %>% 
  tidyr::separate(Var, into = c("Stock", "Var"), sep = "-")  %>% 
  dplyr::filter(EPU == "MA", 
                Var == "rs_anom") %>% 
  dplyr::group_by(Time) %>% 
  dplyr::summarise(Total = sum(Value, na.rm = T),
                      Count = n()) %>% # SG add a count of species
  dplyr::mutate(Totalold = ifelse(Total == 0, NA, Total),
            Total = ifelse(Count < max(Count), NA, Total))
  
prod<- ecodata::productivity_anomaly %>% 
  tidyr::separate(Var, into = c("Stock", "Var"), sep = "-")  %>% 
  dplyr::filter(EPU == "MA", 
                Var == "rs_anom")

p <-   
    ggplot2::ggplot(prod,
           aes(x = Time)) +
    ggplot2::geom_bar(data = prod %>% filter(Value > 0),
             aes(y = Value, fill = Stock),
             stat = "identity") +
    ggplot2::geom_bar(data = prod %>% filter(Value < 0),
             aes(y = Value, fill = Stock),
             stat = "identity") +
    ggplot2::geom_line(data = total, aes(x = Time, y = Total),
                             size = 1) +
    ggplot2::geom_hline(size = 0.3, aes(yintercept = 0)) +
    ggplot2::xlab("") +
    ggplot2::ylab("Recruitment Anomaly") +
    ggplot2::ggtitle("MAB Recruitment Anomaly from Stock Assessments") +
    #ggplot2::guides(fill = guide_legend(ncol = leg_ncol)) +
    ecodata::theme_ts()+
    ggplot2::theme(axis.title   = element_text(size = 10),
          axis.text    = element_text(size = 10),
          plot.title   = element_text(size = 12),
          #legend.text  = element_text(size = leg_font_size),
          legend.title = element_blank()) 
p
```

### Condition factor

```{r mab-cf, fig.cap = "Condition factor for species sampled in MAB."}

knitr::include_graphics(file.path(image.dir, "MAB_Condition_allsex_2023_viridis.jpg"))

```

### Stomach Fullness



```{r stom-fullness, fig.cap= "Stomach fullness anomaly in the Mid-Atlantic Bight." }
fullness <- ecodata::stom_fullness %>%
  dplyr::group_by(Var, EPU) %>% ## Remove values with missing data
  dplyr::filter(n()> 10) %>% ## at least ten years of data
  dplyr::ungroup() %>% 
  dplyr::filter(EPU == "MAB") %>%
  ggplot2::ggplot(aes(x = Time, y = Value)) +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::ggtitle("Stomach fullness") +
  ggplot2::ylab("Stomach fullness") +
  ggplot2::facet_wrap(~Var)+
  ggplot2::theme(strip.text=element_text(hjust=0))

fullness

```

### Larval diversity

```{r ichthyo-diversity}
ma_larv_div <- ecodata::ichthyo_diversity %>%
  dplyr::filter(EPU == "MAB") %>%
  dplyr::mutate(Var = stringr::word(Var,1)) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot2::ggplot(aes(x = Time, y = Value, group = Var)) +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  #ecodata::geom_lm(aes(x = Time, y = Value, group = Var))+
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::ggtitle("Mid-Atlantic larval diversity") +
  ggplot2::ylab("Shannon Diversity") +
  #ggplot2::facet_wrap(~ Season, ncol = 2, scales = "free_y") +
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01))+
  ggplot2::geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  ecodata::theme_facet() +
  ggplot2::xlab(element_blank())+
  ggplot2::theme(strip.text=element_text(hjust=0))+
  ecodata::theme_title()

ma_larv_div


```



### Virginia Common Tern Abundance

<span style="color: red;">NO NEW DATA</span>


```{r seabird-mab, fig.cap = "Estimated number of breeding pairs in Virginia barrier island/lagoon system. "}

bird<- ecodata::seabird_mab %>% 
  dplyr::mutate(hline = mean(Value))

bird %>% 
  ggplot2::ggplot() +
#Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd-0.75) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex-0.75) +
  #geom_gls(aes(x = Time, y = Value)) +
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01),limits = c(1991,2018)) +
  ggplot2::ggtitle("Seabird Abundance") +
  ggplot2::ylab(expression("Number of Breeding Pairs")) +
  ggplot2::xlab("")+
  ggplot2::geom_hline(aes(yintercept = hline),
           color = "black",
          size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ggplot2::theme(legend.position="bottom", legend.direction = "horizontal", 
        legend.title = element_blank(), legend.margin=margin(t = -20)) +
  ecodata::theme_ts()+
  ecodata::theme_title()
```

### Forage Anomaly
<span style="color: red;">NO NEW DATA - NO SURVEY IN 2020</span>

[Taxa include](https://docs.google.com/spreadsheets/d/108snlOTy1wzMGmxbYp1qJuKgqYfYM8MD/edit#gid=966266704)

```{r forage-anomaly}
ecodata::forage_anomaly %>% 
  filter(EPU == "MAB") %>% 
  pivot_wider(names_from = Var, values_from = Value) %>% 
  ggplot()+
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_point(aes(x=Time, y = Forage_Mean))+
  ggplot2::geom_line(aes(x=Time, y =Forage_Mean))+
  #ecodata::geom_lm(aes(x = Time, y = Forage_Mean))+
  ggplot2::geom_ribbon(aes(ymin = Forage_Lower, ymax = Forage_Upper, x = Time), alpha = 0.3)+
  ggplot2::geom_hline(yintercept = 0, linetype = "dashed")+
  ggplot2::ggtitle("Forage Anomalies")+
  ggplot2::ylab("Forage Anomaly")+
  ggplot2::xlab(element_blank())+
  ecodata::theme_ts()+
  ecodata::theme_title()

```

### Forage Index

```{r forage-index}


resca<- ecodata::forage_index %>% 
  dplyr::filter(Var %in% c("Fall Forage Fish Biomass Estimate", 
                           "Spring Forage Fish Biomass Estimate"), 
                EPU == "MAB") %>% 
  dplyr::summarise(max = max(Value)) 

ecodata::forage_index %>% 
  dplyr::filter(Var %in% c("Fall Forage Fish Biomass Estimate", 
                           "Fall Forage Fish Biomass Estimate SE",
                           "Spring Forage Fish Biomass Estimate",
                           "Spring Forage Fish Biomass Estimate SE"), 
                EPU == "MAB") %>% 
  tidyr::separate(Var, into = c("Season", "A", "B", "C", "D", "Var")) %>% 
  dplyr::mutate(Var = replace_na(Var, "Mean"), 
                max = as.numeric(resca)) %>% 
  tidyr::pivot_wider(names_from = Var, values_from = Value) %>% 
  dplyr::mutate(#Value = Value/resca, 
    Mean = as.numeric(Mean), 
                Mean = Mean/max,
                SE = SE/max,
                Upper = Mean + SE, 
                Lower = Mean - SE) %>% 
  ggplot2::ggplot(aes(x = Time, y = Mean, group = Season))+
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Season), alpha = 0.5)+
  ggplot2::geom_point()+
  ggplot2::geom_line()+
  ggplot2::ggtitle("Forage Biomass Index")+
  ggplot2::ylab(expression("Relative forage biomass"))+
  ggplot2::xlab(element_blank())+
  ecodata::geom_gls()+
  ecodata::theme_ts()+
  ecodata::theme_title()
```




### Observed Shark Numbers
<span style="color: red;">NO NEW DATA</span>
```{r observed-sharks}
ecodata::observed_sharks %>% 
  filter(EPU == "MAB") %>% 
  ggplot()+
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_point(aes(x=Time, y = Value, color = Var))+
  ggplot2::geom_line(aes(x=Time, y = Value, color = Var))+
  ggplot2::ggtitle("Observed Sharks")+
  ggplot2::ylab("Number per Haul")+
  ggplot2::xlab(element_blank())+
  ggplot2::scale_color_discrete(name = "Category")+
  ecodata::theme_ts()+
  ecodata::theme_title()

```



## Shelfwide Indicators{.tabset .tabset-fade}

### Protected species 

```{r harborporpoise, fig.cap="Estimated Harbor porpoise bycatch (black) and the potential biological removal (red)." }

ribbon<- ecodata::harborporpoise %>% 
  tidyr::pivot_wider(names_from = Var, values_from = Value)  
  
ecodata::harborporpoise %>% 
  dplyr::filter(Var %in% c("pbr", "totalest5y", "totalest1y")) %>% 
  ggplot2::ggplot()+
  ggplot2::geom_line(aes(x = Time, y = Value, linetype = Var, color = Var))+
  ggplot2::geom_ribbon(data = ribbon, aes(ymin = total5yLCI, ymax =total5yUCI, x = Time), fill = "blue", alpha = 0.2)+
  ggplot2::ggtitle("Harbor Porpoise Bycatch")+
  ggplot2::ylab("Estimated Bycatch (n)")+
  ggplot2::scale_color_manual(name = element_blank(), values = c('red', 'black','blue'))+
  ggplot2::scale_linetype_manual(values=c(1,2,1), 
                                 labels = c("PBR", "Annual Estimates", "5yr rolling mean and CI"))+
  ggplot2::theme(#legend.position = "none",
    legend.title = element_blank(),
                 legend.position = c(0.75, 0.8), 
                 legend.text = element_text(size = 8), 
                 legend.background = element_rect(
                   colour = "transparent", fill = "transparent"))+
  guides(color = FALSE)+
  ecodata::theme_ts()+
  ecodata::theme_title()

```


```{r grayseal, fig.width=5,  fig.cap="5 year Gray Seal bycatch estimate for NEUS Shelf (Blue) and 1 Year estimate for New England (Black) and the potential biological removal (red)." }

ribbon<- ecodata::grayseal %>% 
  tidyr::pivot_wider(names_from = Var, values_from = Value)  
  
ecodata::grayseal %>% 
  dplyr::filter(Var %in% c("pbr", "totalest5y", "totalest1y")) %>% 
  ggplot2::ggplot()+
  ggplot2::geom_line(aes(x = Time, y = Value, linetype = Var, color = Var))+
  ggplot2::geom_ribbon(data = ribbon, aes(ymin = total5yLCI, ymax =total5yUCI, x = Time), fill = "blue", alpha = 0.2)+
  ggplot2::ggtitle("Gray Seal Bycatch")+
  ggplot2::ylab("Estimated Bycatch (n)")+
  ggplot2::scale_color_manual(name = element_blank(), values = c('red', 'black','blue'))+
  ggplot2::scale_linetype_manual(values=c(1,2,1), 
                                 labels = c("PBR", "Annual Estimates", "5yr rolling mean and CI"))+
  ggplot2::theme(#legend.position = "none",
    legend.title = element_blank(),
                 legend.position = c(0.2, 0.8), 
                 legend.text = element_text(size = 8), 
                 legend.background = element_rect(
                   colour = "transparent", fill = "transparent"))+
  guides(color = FALSE)+
  ecodata::theme_ts()+
  ecodata::theme_title()
  

```






```{r narw-abundance, fig.cap = "Estimated North Atlanic right whale abundance on the Northeast Shelf."}
#hline <- mean(narw[narw$Var == "right whale abundance median",]$Value)

ecodata::narw %>% 
  dplyr::filter(Var != "Calves") %>% 
  tidyr::spread(Var, Value) %>% 
  dplyr::rename(Value = Median) %>% 
  dplyr::mutate(Value = as.numeric(Value), 
                Time = as.numeric(Time),
                Lower95 = as.numeric(Lower95), 
                Upper95 = as.numeric(Upper95),
                hline = mean(Value, na.rm = T)) %>% 
  ggplot2::ggplot() +
#Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_line(aes(x = Time, y = Value), size = lwd-0.75) +
  ggplot2::geom_point(aes(x = Time, y = Value), size = pcex-0.75) +
  #ecodata::geom_lm(aes(x = Time, y = Value))+
  ggplot2::geom_ribbon(aes(ymin = Lower95, ymax = Upper95, x = Time), alpha = 0.3)+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("NARW abundance") +
  ggplot2::ylab(expression("Abundance (n)")) +
  ggplot2::xlab(element_blank())+
  ggplot2::geom_hline(aes(yintercept = hline),
          color = "black",
          size = hline.size,
          alpha = hline.alpha,
          linetype = hline.lty) +
  ecodata::theme_ts()+
  ecodata::theme_title()


```

```{r NARW-calf-abundance, fig.cap = "Number of North Atlantic right whale calf births, 1990 - 2022."}

ecodata::narw %>% 
  dplyr::filter(Var == "Calves") %>%
  dplyr::mutate(Value = as.numeric(Value), 
                Time = as.numeric(Time),
                hline = mean(Value, na.rm = T)) %>% 
  ggplot2::ggplot() +
#Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_line(aes(x = Time, y = Value), size = lwd-0.75) +
  ggplot2::geom_point(aes(x = Time, y = Value), size = pcex-0.75) +
  #ecodata::geom_lm(aes(x = Time, y = Value))+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("NARW calf abundance") +
  ggplot2::ylab(expression("Abundance (n)")) +
  ggplot2::xlab(element_blank())+
  ggplot2::geom_hline(aes(yintercept = hline),
           color = "black",
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()+
  ecodata::theme_title()





```

### Protected species hotspot maps

```{r rw-hotspot, fig.cap = ""}

knitr::include_graphics(file.path(image.dir, "SOE_2023_right_whales_hatteras_frame_v3.jpg"))

```

```{r ps-hotspot, fig.cap = "Seabirds, Turtles, Whales"}

knitr::include_graphics(file.path(image.dir, "SOE_2023_birds_mammals_turtles_v4.png"))

```


### Aggregate species distribution


```{r species-dist, fig.cap = "Aggregate species distribution metrics for species in the Northeast Large Marine Ecosystem."}

spec_dist <- ecodata::species_dist %>% 
  #dplyr::filter(!Var == "Season") %>% 
  dplyr::mutate(Value = as.numeric(Value)) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value)) %>% 
  ungroup()

asd <- spec_dist %>% 
  dplyr::filter(Var == "along-shelf distance", 
                !Time == 2020) %>% 
  ggplot2::ggplot(aes(x = Time, y = Value,
               group = Var)) + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ecodata::geom_gls() +
  #ecodata::geom_lm(aes(x = Time, y = Value, group = Var))+
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::ggtitle("Along-shelf distance")+
  ggplot2::ylab(expression("Distance (km)")) +
  ggplot2::xlab("")+
  ggplot2::geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()+
  ecodata::theme_title() 

depth <- spec_dist %>% 
  dplyr::filter(Var == "depth", 
                !Time == 2020) %>% 
  dplyr::mutate(Value = Value, 
         hline = mean(Value)) %>% 
  ggplot2::ggplot(aes(x = Time, y = Value,
               group = Var)) + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ecodata::geom_gls() +
  #ecodata::geom_lm(aes(x = Time, y = Value, group = Var))+
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_y_continuous(trans = "reverse")+
  ggplot2::ggtitle("Depth") +
  ggplot2::ylab(expression("Depth (m)")) +
  ggplot2::xlab("")+
  ggplot2::geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts() +
  ecodata::theme_title()


asd + depth + patchwork::plot_layout(ncol = 1) 

```


### Forage fish energy content

```{r energy-density, eval=T, echo=F}
d<-ecodata::energy_density %>% 
  tidyr::separate(Var, into = c("Species", "Season", "Var"), sep = "/") %>% 
  tidyr::pivot_wider(names_from = Var, values_from = Value)

old.ed<- data.frame("Species" = c("Alewife", "Atl. Herring","Atl. Mackerel","Butterfish", "Illex squid", "Loligo squid",  "Sand lance","Silver hake" ,  "Atl. Herring", "Illex squid","Sand lance"),
                    "Year" = c("1980s", "1980s", "1980s", "1980s", "1980s", "1980s","1980s", "1980s", "1990s",
                               "1990s","1990s"), 
                    "Season" = c("All", "All", "All", "All", "All", "All", "All", "All" , "All", "All", "All"), 
                    "N" = c(rep("NA", 11)), 
                    "Energy.Density_Mean" = c(6.4, 10.6, 6.0, 6.2, 7.1, 5.6, 6.8, 4.6, 9.4, 5.9, 4.4))


d %>% 
  dplyr::mutate(Energy.Density_Mean = as.numeric(Energy.Density_Mean), 
                Energy.Density_SD = as.numeric(Energy.Density_SD), 
                upper = Energy.Density_Mean + Energy.Density_SD, 
                lower = Energy.Density_Mean - Energy.Density_SD) %>% 
  dplyr::group_by(Season, Species) %>% 
  ggplot2::ggplot(aes(x=Time, y = Energy.Density_Mean, color = Season))+
  ggplot2::geom_point()+
  geom_line()+
  ggplot2::geom_errorbar(aes(ymin=lower, ymax=upper), width=.2) + 
  geom_hline(data = old.ed, aes(yintercept = Energy.Density_Mean, linetype =Year))+
  ggplot2::facet_wrap(~Species, nrow = 2)+
  ggplot2::ylab("Mean Energy Density (kJ/g)")+
  ggplot2::theme(axis.title.x=element_blank(), 
                 axis.text.x = element_text(angle = 45,  hjust = 1), 
                 legend.title = element_blank())+
  scale_x_continuous(breaks=c(2017,2018, 2019, 2020, 2021, 2022))+
  ggplot2::ggtitle("Forage Fish Energy Density")+
  ecodata::theme_facet()+
  ecodata::theme_title()


```


<!-- ### Blue Runner on NES -->

<!-- <span style="color: red;">NO NEW DATA</span> -->

<!-- ```{r blue-runner, fig.cap = "Blue runner presence on Northeast Shelf"} -->
<!-- blue<-ecodata::blue_runner %>%  -->
<!--   tidyr::separate(Var, c("Var", "Pos"), "L") %>%  -->
<!--   tidyr::spread(., Pos, Value) %>%  -->
<!--   dplyr::rename(Lat = at,  -->
<!--          Lon = on) %>%  -->
<!--   dplyr::mutate(Var = recode(Var, -->
<!--                       "Positive Blue Runner Tows before 2001 - " = "Prior to 2000", -->
<!--                       "Positive Blue Runner Tows 2001 - 2010 - " = "2001-2010",  -->
<!--                       "Positive Blue Runner Tows since 2010 - " = "Since 2010")) -->
<!-- blue$Var <- factor(blue$Var, levels = c("Prior to 2000", "2001-2010", "Since 2010")) -->

<!-- #EPU shapefile -->
<!-- epu_sf <- ecodata::epu_sf %>%  -->
<!--   dplyr::filter(EPU %in% c("GOM","GB", "MAB")) -->

<!-- #Map line parameters -->
<!-- map.lwd <- 0.4 -->

<!-- # Set lat/lon window for maps -->
<!-- xmin = -77 -->
<!-- xmax = -65 -->
<!-- ymin = 35 -->
<!-- ymax = 45 -->
<!-- xlims <- c(xmin, xmax) -->
<!-- ylims <- c(ymin, ymax) -->

<!-- ## Map plotting blue runner -->
<!-- blue_map <-  -->
<!--   ggplot2::ggplot() + -->
<!--   ggplot2::geom_sf(data = ecodata::coast, size = map.lwd) + -->
<!--   ggplot2::geom_sf(data = epu_sf, fill = "transparent", size = map.lwd) + -->
<!--   ggplot2::geom_point(data = blue, aes(x = Lon, y = Lat, color = Var, shape = Var))+ -->
<!--   ggplot2::scale_shape_manual(values=c(16, 3, 17))+ -->
<!--   ggplot2::scale_color_manual(values = c("blue", "black", "red"))+ -->
<!--   ggplot2::coord_sf(crs = crs, xlim = xlims, ylim = ylims) + -->
<!--   ecodata::theme_map() + -->
<!--   ggplot2::ggtitle("Blue Runner Presence") + -->
<!--   ggplot2::xlab("") + -->
<!--   ggplot2::ylab("") + -->
<!--   ggplot2::theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75), -->
<!--         legend.key = element_blank(), -->
<!--         axis.title = element_text(size = 11), -->
<!--         strip.background = element_blank(), -->
<!--         strip.text=element_text(hjust=0), -->
<!--         axis.text = element_text(size = 8),  -->
<!--         legend.title = element_blank(),  -->
<!--         legend.position = c(0.6, 0.15)) -->

<!-- blue_map -->
<!-- ``` -->

### Condition project 

[text here](https://docs.google.com/document/d/1uHMmMTnZG2LAmPi5SSO30k5_5NzfzdKj/edit)
```{r condition-table, fig.cap = ""}

knitr::include_graphics(file.path(image.dir, "Condition_table.png"))

```


```{r condition-matrix, fig.cap = ""}

knitr::include_graphics(file.path(image.dir, "Condition_matrix.png"))

```

### HMS CPUE

<!-- ```{r, hms-all-cpue} -->

<!-- #knitr::include_graphics(file.path(image.dir, "hms-too-big.png")) -->

<!-- ecodata::hms_cpue %>% -->
<!--   ggplot()+ -->
<!--  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = -Inf, ymax = Inf) + -->
<!--   ggplot2::geom_point(aes(x=Time, y = Value))+ -->
<!--   ggplot2::geom_line(aes(x=Time, y = Value))+ -->
<!--   ggplot2::facet_wrap(~Var, scales = "free")+ -->
<!--   ggplot2::ggtitle("HMS POP CPUE ALL")+ -->
<!--   ggplot2::ylab("Number per Haul")+ -->
<!--   ecodata::theme_ts() -->

<!-- ``` -->


```{r, hms-tuna-cpue}
ecodata::hms_cpue %>% 
  filter(stringr::str_detect(Var, "TUNA")) %>% 
  ggplot()+
 ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_point(aes(x=Time, y = Value))+
  ggplot2::geom_line(aes(x=Time, y = Value))+
  ggplot2::facet_wrap(~Var, scales = "free")+
  ggplot2::ggtitle("HMS POP TUNA CPUE")+
  ggplot2::ylab("Number per Haul")+
  ggplot2::xlab(element_blank())+
  ecodata::geom_gls(aes(x=Time, y = Value))+
  ecodata::theme_ts()+
  ecodata::theme_title()

```

```{r hms-cpue-sharks, fig.cap="Species groupings based on list from Debbie Duarte - missing Boonethead, Atlantic Angel shark, Sixgill shark, sevengill shark, nurse shark, white shark, basking shark, lemon shark." }
sp_cat<- ecodata::hms_category
ecodata::hms_cpue %>% 
  filter(stringr::str_detect(Var, "SHARK")) %>% 
  rename(COMMON_POP = Var) %>% 
  left_join(sp_cat) %>% 
  group_by(Time, SP_CATEGORY) %>% 
  summarise(Value = sum(Value)) %>% 
  rename("Var" = "SP_CATEGORY") %>% 
  filter(!Var == "NA") %>% 
  ggplot()+
 ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_point(aes(x=Time, y = Value, color = Var))+
  ggplot2::geom_line(aes(x=Time, y = Value, color = Var))+
  ggplot2::scale_color_discrete(name = "Category")+
  #ggplot2::facet_wrap(~Var, scales = "free")+
  ggplot2::ggtitle("HMS POP SHARK CPUE")+
  ggplot2::ylab("Number per Haul")+
  ecodata::theme_ts()+
  ecodata::theme_title()

```


### HMS Distribution Shifts

```{r protectedspp-dist-shifts, fig.cap = "Species distribution shifts between 2010 and 2017." }
hms10<- ecodata::HMS_species_distribution %>%
  tidyr::separate(Var, into = c("Var", "species", "season"), sep = "_") %>% 
  tidyr::pivot_wider(names_from = Var, values_from = Value) %>% 
  dplyr::filter(Time == 2010) %>% 
  dplyr::rename("x_start" = wlon, 
                "y_start" = wlat) %>% 
  dplyr::select(!Time)

hms<-ecodata::HMS_species_distribution %>%
  tidyr::separate(Var, into = c("Var", "species", "season"), sep = "_") %>% 
  tidyr::pivot_wider(names_from = Var, values_from = Value) %>% 
  dplyr::filter(Time == 2017) %>% 
  dplyr::rename("x_end" = wlon, 
                "y_end" = wlat) %>% 
  dplyr::select(!Time) %>% 
  dplyr::left_join(hms10) %>% 
  dplyr::mutate(season = dplyr::recode(season, fall = "Fall", 
                                       winter = "Winter", 
                                       spring = "Spring", 
                                       summer = "Summer"))
hms$season <- factor(hms$season,levels = c("Winter","Spring", 
                                           "Summer", "Fall"))
epu_sf <- ecodata::epu_sf %>%  
  dplyr::filter(EPU %in% c("GOM","GB", "MAB"))
map.lwd <- 0.4 
xmin = -77 
xmax = -65 
ymin = 35 
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax) 
hms_map <- hms %>% ggplot2::ggplot() + 
  ggplot2::geom_sf(data = ecodata::coast, size = map.lwd) +
  ggplot2::geom_sf(data = epu_sf, fill = "transparent", size = map.lwd) + 
  geom_segment( mapping = aes(x = x_start, y = y_start, 
                              xend = x_end, yend = y_end, color = species),  
                              arrow = grid::arrow(length = grid::unit(1, "mm")))+

  #ggplot2::scale_shape_manual(values=c(16, 3, 17))+ 
  #ggplot2::scale_color_manual(values = c("blue", "black", "red"))+ 
  ggplot2::coord_sf( xlim = xlims, ylim = ylims) + 
  ecodata::theme_map() + 
  ggplot2::ggtitle("Protected Species Distibution Shifts") + 
  ggplot2::xlab("") + 
  ggplot2::ylab("") +
  scale_x_continuous(breaks=c(-76,-72, -68) )+
  ggplot2::theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
                #legend.key = element_blank(),
                axis.title = element_text(size = 11),
                strip.background = element_blank(),
                strip.text=element_text(hjust=0),
                axis.text = element_text(size = 8),
                legend.title = element_blank())+#,
                #legend.position = c(0.6, 0.15)) +
  ggplot2::facet_wrap(~season)
hms_map

```





