---
title: "Human Dimensions MAB and Shelf-wide"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    theme: lumen
---

```{r setup, include=FALSE}
# Image Directory
image.dir <- here::here("docs/images")
gis.dir <- here::here("data-raw/gis")
#Default Rmd options
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center') #allows for inserting R code into captions

#Plotting and data libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(ecodata)
library(here)
library(kableExtra)
library(ggrepel)
library(stringr)
library(patchwork)
library(grid)
library(cowplot)

#GIS libraries
library(sf)
library(rgdal)
library(raster)
library(ggspatial)
library(marmap)


#General inline text input for report

#Council
council <- "Mid-Atlantic Fishery Management Council"
council_abbr <- "MAFMC"

#Region identifiers
epu <- "Mid-Atlantic Bight"
epu_abbr <- "MAB"
region <- "Mid-Atlantic"
region_abbr <- "MA" #Some commercial data organized by "MA" or "NE" regions, not by EPU 


```

```{r GIS-setup}

#CRS
crs <- "+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0 +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#EPU shapefile
epu_sf <- ecodata::epu_sf %>% 
  filter(EPU %in% c("MAB","GB","GOM"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -77
xmax = -65
ymin = 36
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

#Time series constants
shade.alpha <- 0.3
shade.fill <- "lightgrey"
lwd <- 1
pcex <- 2
trend.alpha <- 0.5
trend.size <- 2
hline.size <- 1
hline.alpha <- 0.35
hline.lty <- "dashed"
label.size <- 5
hjust.label <- 1.5
letter_size <- 4
feeding.guilds1<- c("Piscivore","Planktivore","Benthivore","Benthos")
feeding.guilds <- c("Apex Predator","Piscivore","Planktivore","Benthivore","Benthos")
x.shade.min <- 2010
x.shade.max <- 2020
#Function for custom ggplot facet labels
label <- function(variable,value){
  return(facet_names[value])
}
```

Trend lines are shown when slope is significantly different from 0 at the p < 0.05 level. An orange line signifies an overall positive trend, and purple signifies a negative trend. To minimize bias introduced by small sample size, no trend is fit when N < 30. Dashed lines represent mean values of time series unless the indicator is an anomaly, in which case the dashed line is equal to 0. Shaded regions indicate the past ten years. If there are no new data for 2018, the shaded region will still cover this time period.

## Mid-Atlantic

### Commercial {.tabset .tabset-fade}

#### Commercial landings

```{r hms-landings-comdat-commercial_landings, warning=F, , fig.cap = ("MAFMC managed species landings (red) and total commercial landings (black) by feeding guild. \\label{comm-landings}")}
#Get data for plotting
## Apex pred
apex<-ecodata::hms_landings %>% 
  dplyr::filter(stringr::str_detect(Var, "Landings")) %>% 
  separate(Var, c("Var", "trash"), sep = "_")


#Define constants for figure plot
series.col <- c("indianred","black")

##Plot
p1<-apex %>% 
  dplyr::filter(EPU == "MAB") %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value)) %>% 

  ggplot2::ggplot(aes(x = YEAR, y = Value, color = Var)) +
  
  #Add time series
  ggplot2::geom_line(size = lwd) +
  ggplot2::geom_point(size = pcex) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 color = Var,
                 size = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  #Axis and theme
  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000})+
  ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 5), limits = c(1985, 2020)) +
  ecodata::theme_facet() +
  ggplot2::theme(strip.text=element_text(hjust=0), 
        legend.position = "bottom", 
        legend.direction = "horizontal", 
        legend.title = element_blank())+
  ggplot2::ylab("")

#Managed landings
managed_landings <- ecodata::comdat  %>%
  dplyr::filter(stringr::str_detect(Var, paste0(council_abbr," managed species - Landings weight|JOINT managed species - Landings weight")),
         !stringr::str_detect(Var, "Other"),
         Time >= 1986,
         EPU == epu_abbr)

#Total landings
total_landings <- ecodata::comdat  %>%
  dplyr::filter(!stringr::str_detect(Var, "managed species"),
         !stringr::str_detect(Var, "Other"),
         stringr::str_detect(Var, "Landings"),
         Time >= 1986,
         EPU == epu_abbr)

#Assign feeding guild column for plotting with ggplot
landings <- 
  rbind(managed_landings, total_landings) %>%
  dplyr::filter(Var != "Apex Predator Landings") %>% 
  dplyr::mutate(feeding.guild = stringr::str_extract(Var,paste(feeding.guilds, collapse = "|")),
         grouping = factor(ifelse(stringr::str_detect(Var,council_abbr), "managed",
                                  ifelse(stringr::str_detect(Var, "JOINT"), "joint","total"))),
         Var = paste(word(feeding.guild), grouping)) %>% 
  dplyr::mutate(feeding.guild = factor(feeding.guild, levels = feeding.guilds))

#Add JOINT landings to MANAGED landings and remove
landings[landings$Var ==  "Piscivore managed",]$Value <- landings[landings$Var ==  "Piscivore managed",]$Value + landings[landings$Var ==  "Piscivore joint",]$Value

landings <- landings %>%
  dplyr::filter(Var != "Piscivore joint")  %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value))


#facet names for titles
facet_names <- list("Apex" = expression("Apex"),
                    "Piscivores" = expression("Piscivores"),
                    "Planktivores" = expression("Planktivores"),
                    "Benthivores" = expression("Benthivores"),
                    "Benthos" = expression("Benthos"))


p2<- landings %>% 
  dplyr::filter(EPU == "MAB") %>% 
  ggplot2::ggplot(aes(x = Time, y = Value, color = grouping)) +
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var)) +
  
  #Add time series
  ggplot2::geom_line(size = lwd) +
  ggplot2::geom_point(size = pcex) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 color = grouping,
                 size = grouping),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  ggplot2::facet_wrap(feeding.guild~., scales = "free", labeller = label, ncol = 1)+
  
  #Axis and theme
  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000})+
  ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  ggplot2::ylab(expression("Landings (10"^3*"metric tons)")) +
  ecodata::theme_facet() +
  ggplot2::theme(strip.text=element_text(hjust=0))

p1
p2


``` 


```{r comdat-total-landings, fig.cap = paste0("Total commercial seafood landings (black) shown with ",region," managed seafood landings (red). \\label{total-landings}")}

#Managed landings
managed_landings <- ecodata::comdat  %>%
  dplyr::filter(stringr::str_detect(Var, paste0(council_abbr," managed species - Landings weight|JOINT managed species - Landings weight")),
         !stringr::str_detect(Var, "Other"),
         Time >= 1986,
         EPU == epu_abbr)

#Total landings
total_landings <- ecodata::comdat  %>%
  dplyr::filter(!stringr::str_detect(Var, "managed species"),
         !stringr::str_detect(Var, "Other"),
         stringr::str_detect(Var, "Landings"),
         Time >= 1986,
         EPU == epu_abbr)

total_landings_agg <- total_landings %>%
  dplyr::group_by(Time) %>%
  dplyr::summarise(Value = sum(Value)) %>% 
  dplyr::mutate(Var = "Total",hline = mean(Value))

managed_landings_agg <- managed_landings %>%
  dplyr::group_by(Time) %>%
  dplyr::summarise(Value = sum(Value)) %>% 
  dplyr::mutate(Var = "Managed",hline = mean(Value))

landings_agg <- rbind(total_landings_agg, managed_landings_agg)


ggplot2::ggplot(data = landings_agg)+
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000})+
  ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ylab(expression("Landings (10"^3*"metric tons)")) +
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()

```

#### Commercial revenue 

```{r bennet, fig.cap = paste0("Revenue change from the 2015 values in dollars (black), Price (PI), and Volume Indicators (VI) for commercial landings in the Mid-Atlantic Bight. \\label{bennet}")}

#Filter data into two dataframes for plotting

indicators <- ecodata::bennet %>% 
  dplyr::filter(EPU == epu_abbr) %>% 
  dplyr::filter(stringr::str_detect(Var, pattern="Total"),
         !Var == "Total Revenue Change - Bennet", 
         !Time < 1985) %>% 
  dplyr::mutate(Var, Var = plyr::mapvalues(Var, from = c("Total Volume Index - Bennet", "Total Price Index - Bennet"),
                                           to = c("Volume","Price"))) %>% 
  dplyr::group_by(Time) %>% 
  dplyr::mutate(New = sum(Value))

revchange <- ecodata::bennet %>% 
  dplyr::filter(EPU == "MAB",
         Var %in% c("Total Revenue Change - Bennet"),
         !Time<1985)
#custom bar fill color (color-blind friendly)
ind_fill <- c("#a6cee3", "#b2df8a")

#limits
y.lim <- c(-450,600)

#plot
ggplot2::ggplot()+
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  ggplot2::geom_bar(data = indicators, aes(x = Time, y = Value, fill = Var), stat="identity")+
  ggplot2::scale_fill_manual(name = "Indicators", values = ind_fill) +
  ggplot2::geom_line(data = revchange, aes(x = Time, y = Value, color = "$"))+
  ggplot2::scale_colour_grey(name ="Revenue Change") +
  ggplot2::ggtitle("Bennet Indicator")+
  ggplot2::labs(y="Value $1,000,000 ($2015)") +
  ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  ggplot2::scale_y_continuous(breaks = seq(y.lim[1], y.lim[2], by = 100), 
                              limits = y.lim, expand = c(0.01, 0.01)) +
  ecodata::theme_ts() +
  ggplot2::theme(title = element_text(size = 10))

```


```{r comdat-comm-revenue,  fig.cap = "Total revenue for the region (black) and revenue from MAFMC managed species (red). \\label{comm-rev}"}

#Filtering and aggregation step
rev_agg <- ecodata::comdat %>% 
  dplyr::filter(stringr::str_detect(Var, "Revenue"),
         !stringr::str_detect(Var, "prop|Other|NEFMC"), #Remove proportions, "Other" category species, NEFMC managed species in MAB
         EPU == epu_abbr,
         Time >= 1986) %>% 
  dplyr::mutate(Status = ifelse(str_detect(Var, "Revenue weight"), 
                         "Managed","Total")) %>% #Create groups for aggregation
  dplyr::group_by(Status, Time) %>% 
  dplyr::summarise(Total = sum(Value)) %>% 
  dplyr::group_by(Status) %>% 
  dplyr::mutate(hline = mean(Total))

series.col <- c("indianred","black")

#Plotting
ggplot2::ggplot(data = rev_agg) +
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+  
  
  #lines
  ecodata::geom_gls(aes(x = Time, y = Total,
               group = Status),
             alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Total, color = Status), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Total, color = Status), size = pcex) +

  #axes
  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000000})+
  ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
      scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Total revenue") +
  ggplot2::ylab(expression("Revenue (10"^6*"USD)")) +
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Status),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()

```

#### Commercial diversity

```{r commercial-div, fig.cap = paste0("Fleet diversity and fleet count in the ",region,". \\label{comm-div}")}

# 
comm_div <- ecodata::commercial_div %>% 
  dplyr::filter(EPU == region_abbr) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value))

ylim_fc <- c(min(comm_div[comm_div$Var == "Fleet count",]$Value) - 10, max(comm_div[comm_div$Var == "Fleet count",]$Value) + 10 )
ylim_fd <- c(0, max(comm_div[comm_div$Var == "Fleet diversity in revenue",]$Value) + 3 )
# 
# #Create dataframe for label locations
# label_loc <- data.frame(xloc = min(comm_div$Time)+0.25,
#                         yloc = c(ylim_fc[2]*0.95, ylim_fd[2]*0.95),
#                         labels = LETTERS[1:2],
#                         Var = c("Fleet count","Fleet diversity in revenue"))
# 
 series.col = c("black")


fleet_count <- comm_div %>% 
  dplyr::filter(Var == "Fleet count") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  #label
  # annotate("text", x = label_loc[label_loc$Var == "Fleet count",]$xloc,
  #          y = label_loc[label_loc$Var == "Fleet count",]$yloc,
  #          label = label_loc[label_loc$Var == "Fleet count",]$label,
  #          size = letter_size) +

  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  ggplot2::ylim(ylim_fc)+
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Fleet count") +
  ggplot2::ylab(expression("Count (n)")) +
  ggplot2::xlab("")+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()

fleet_div <- comm_div %>% 
  dplyr::filter(Var == "Fleet diversity in revenue") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
 ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
    #label
  # annotate("text", x = label_loc[label_loc$Var == "Fleet diversity in revenue",]$xloc,
  #          y = label_loc[label_loc$Var == "Fleet diversity in revenue",]$yloc,
  #          label = label_loc[label_loc$Var == "Fleet diversity in revenue",]$label,
  #          size = letter_size) +

  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  ggplot2::ylim(ylim_fd)+
  
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Fleet diversity") +
  ggplot2::ylab(expression("Effective Shannon")) +
  ggplot2::xlab("Time") +

  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
 ecodata::theme_ts()

cowplot::plot_grid(fleet_count, fleet_div, ncol = 1, align = "hv") + 
  ggplot2::theme(plot.margin = unit(c(0.1, 0, 0, 0), "cm"))

```


```{r commercial-div-species-div,  fig.cap = paste0("Species revenue diversity in the ",region,". \\label{spec-div}")}
comm_div %>% 
  dplyr::filter(Var == "Permit revenue species diversity") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  # geom_gls(aes(x = Time, y = Value,
  #              group = Var),
  #            alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Permit revenue species diversity") +
  ggplot2::ylab(expression("Effective Shannon")) +
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
 ecodata::theme_ts()
```

#### Stock status

```{r stock-status, echo=FALSE, warning=F, fig.cap = paste0("Summary of single species status for MAMFC and jointly managed stocks, Goosefish and Dogfish jointly managed.")} 
#Get data, spread for plotting, and filter
stock_status <- ecodata::stock_status %>%
  dplyr::mutate(Code = recode(Code, "Dogfish" = "Sp. Dogfish" )) %>% 
  tidyr::spread(.,Var,Value) %>% 
  dplyr::filter(Council %in% c("MAFMC","Both")) %>% 
  dplyr::group_by(Stock) %>% 
  dplyr::mutate(score = case_when(
    (B.Bmsy <0.5) ~"a",
    (F.Fmsy >1) ~ "a", 
    (F.Fmsy < 1 & B.Bmsy > 0.5 & B.Bmsy < 1) ~ "b",
    (F.Fmsy < 1 & B.Bmsy > 1) ~ "c"))
#Plot constants
y.max <- 2.0 #1.75 mackerel cut off F/Fmsy is 1.8
x.max <- 2.6
#A dataframe that defines custom legend for stocks with unknown status
unknown <- data.frame(text = c("Unknown Status", "Longfin Squid",
                              "Shortfin Squid", "N. Goosefish", "S. Goosefish"),
                    x = rep(0.9*x.max,5), y = seq(0.93*y.max,1.4,-.1))

# Custom Color
custom_color<- c("#56B4E9", "#009E73", "#0072B2")
#Plotting code
ggplot2::ggplot(data = stock_status) +
  ggplot2::geom_vline(xintercept = 1, linetype = "dotted")+
  ggplot2::geom_vline(xintercept = 0.5, linetype = "dashed")+
  ggplot2::geom_hline(yintercept = 1, linetype = "dashed") +
  ggplot2::geom_point(aes(x = B.Bmsy,
                 y = F.Fmsy,
                 shape = Council,
                 color = score)) +
  ggrepel::geom_text_repel(aes(x = B.Bmsy, #geom_text_repel auto-jitters text around points
                      y = F.Fmsy,
                      label = Code, 
                      color = score), 
                  show.legend = FALSE, nudge_y = -0.01, nudge_x = 0.05) +
  ggplot2::scale_color_brewer(palette = "Dark2",
                     breaks = stock_status$score) +
  ggplot2::ylim(0,y.max) +
  ggplot2::xlim(0,x.max) +
  ggplot2::geom_text(data = unknown, aes(x = x, y = y, label = text), #Custom legend for unknown stock status
            size = c(4.75,rep(4,4))) +
  ggplot2::annotate("rect", xmin = 0.8*x.max,
           xmax = x.max,
           ymin = 0.65*y.max,
           ymax = 0.90*y.max,
           alpha = 0.1) +
  ggplot2::xlab(expression(~B/B[msy])) +
  ggplot2::ylab(expression(~F/F[msy])) +
  ggplot2::guides(color = FALSE) +
  ecodata::theme_ts()
```

#### Oyster aquaculture

```{r aquaculture, fig.cap = "Oyster aquaculture production in terms pieces, lease area and production by acre. \\label{oyster-aqua}"}

aqua <- ecodata::aquaculture %>%
  dplyr::filter(Region == "Maryland") %>% 
  dplyr::filter(!Value == "NA") %>% 
  dplyr::mutate(Time = as.integer(Time), 
                Value = as.numeric(Value))

ggplot2::ggplot() +
 #Highlight last ten years
  ggplot2::geom_line(data = aqua, aes(x = Time, y = Value), size = lwd) +
  ggplot2::geom_point(data = aqua,aes(x = Time, y = Value), size = pcex) +
  ggplot2::facet_wrap(~Var, scales = "free")+
  ggplot2::ggtitle("Oyster Production in Maryland")+
  ggplot2::ylab(expression("Oysters production")) +
  ggplot2::xlab("")+
  scale_x_continuous(breaks=c(2009,2011,2013,2015, 2017, 2019))+
  ecodata::theme_ts()

```

#### Engagement and reliance

```{r commercial-engagement, message=F, fig.cap= "Commercial engagement and reliance for the top top commercial fishing communities in the Mid-Atlantic.", message = FALSE, warning=FALSE}

com<-ecodata::engagement %>% 
  dplyr::filter(Region == "Mid-Atlantic", 
                Fishery == "Commercial")

com2<-com %>% 
  ggplot2::ggplot()+
  ggplot2::geom_point(aes(x = Eng, y = Rel, color = Rating), size = 2)+
  ggplot2::geom_vline(xintercept = 1, linetype = "dashed",color = "black")+
  ggplot2::geom_hline(yintercept = 1, linetype = "dashed", color = "black") +
  ggrepel::geom_text_repel(aes(x = Eng, #geom_text_repel auto-jitters text around points
                      y = Rel,
                      label = Community,
                      color = Rating), show.legend = FALSE, direction = "both", box.padding = 0.3, size = 3)+
  ggplot2::scale_color_brewer(palette = "Dark2", #Change legend labels for clarity
                     breaks = com$Rating) +
  xlim(0,12)+
  ylim(0,5.5)+
  theme(legend.position="top",
        legend.title = element_blank())+
  ggplot2::xlab("Commercial Engagament Score") +
  ggplot2::ylab("Commercial Reliance Score") +
  ggplot2::ggtitle("Social Vulnerability in Top Commercial Fishing Communities")+
  #ggplot2::guides(color = FALSE) +
  #theme_bw()
  ecodata::theme_ts()
  #ecodata::theme_facet()
  
  
  gridExtra::grid.arrange(com2, bottom = textGrob("Low <--------------------------------------------------------------------------------------------------------------------------------------> High", 
                                     x = 0.5, y = 1, gp = gpar(fontsize = 7)),
                          left = textGrob("Low <-----------------------------------------------------------------> High", rot = 90,
                                   x = 1, y = 0.45, gp = gpar(fontsize = 7)))


```


```{r recreational-engagement, message=F, fig.cap= "Commercial engagement and reliance for the top top recreational fishing communities in the Mid-atlantic."}

com<-ecodata::engagement %>% 
  dplyr::filter(Region == "Mid-Atlantic", 
                Fishery == "Recreational")

com2<-com %>% 
  ggplot2::ggplot()+
  ggplot2::geom_point(aes(x = Eng, y = Rel, color = Rating), size = 2)+
  ggplot2::geom_vline(xintercept = 1, linetype = "dashed", color = "black")+
  ggplot2::geom_hline(yintercept = 1, linetype = "dashed", color = "black") +
  ggrepel::geom_text_repel(aes(x = Eng, #geom_text_repel auto-jitters text around points
                      y = Rel,
                      label = Community,
                      color = Rating), show.legend = FALSE, direction = "both", box.padding = 0.3, size = 3)+
  ggplot2::scale_color_brewer(palette = "Dark2", #Change legend labels for clarity
                     breaks = com$Rating) +
  xlim(0,12)+
  ylim(0,16)+
  theme(legend.position="top",
        legend.title = element_blank())+
  ggplot2::xlab("Recreation Engagament Score") +
  ggplot2::ylab("Recreation Reliance Score") +
  ggplot2::ggtitle("Social Vulnerability in Top Recreational Fishing Communities")+
  ggplot2::guides(color = FALSE) +
  ecodata::theme_ts()
  
  
  gridExtra::grid.arrange(com2, bottom = textGrob("Low <--------------------------------------------------------------------------------------------------------------------------------------> High", 
                                     x = 0.5, y = 1, gp = gpar(fontsize = 7)),
                          left = textGrob("Low <----------------------------------------------------------------------------------------> High", rot = 90,
                                   x = 1, y = 0.5, gp = gpar(fontsize = 7)))


```

### Recreational fisheries {.tabset .tabset-fade}

#### Recreational landings

```{r recdat-landings, fig.cap = paste0("Total recreational landings in the ",region," region. \\label{rec-landings}")}

landings_rec <- ecodata::recdat %>% 
  dplyr::filter(EPU == region_abbr,
         Var == "Recreational Seafood") %>% 
  dplyr::mutate(hline = mean(Value))

series.col <- "black"

ggplot2::ggplot(data = landings_rec)+
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000000})+
  ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Recreational seafood harvest") +
  ggplot2::ylab(expression("Fish caught (10"^6*"n)")) +

  ggplot2::geom_hline(aes(yintercept = hline,
               
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()

```

#### Recreational diversity

```{r recdat-diversity,fig.cap = paste0("Recreational effort, recreational effort diversity, number of recreational anglers, and diversity of recreational catch in the ",region,". \\label{recdat}")}
recdat <- ecodata::recdat %>% 
  dplyr::filter(EPU == region_abbr) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value))

ylim_re <- c(2e7, 7e7)
ylim_rd <- c(1.75,2.75)
ylim_ra  <- c(1e6, 3.5e6)

# #Create dataframe for label locations
# label_loc <- data.frame(xloc = min(recdat$Time)+0.3,
#                         yloc = c(ylim_re[2]*0.975,
#                                  ylim_rd[2]*0.975,
#                                  ylim_ra[2]*0.975),
#                         labels = LETTERS[1:3],
#                         Var = c("Recreational Effort",
#                                 "Recreational fleet effort diversity across modes",
#                                 "Recreational anglers"))

series.col <- "black"
# x.shade.min <- max(recdat$Time, na.rm = T) - 9
# x.shade.max <- max(recdat$Time, na.rm = T)

rec_effort <- recdat %>% 
  dplyr::filter(Var == "Recreational Effort") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  #label
  # annotate("text", 
  #          x = label_loc[label_loc$Var == "Recreational Effort",]$xloc,
  #          y = label_loc[label_loc$Var == "Recreational Effort",]$yloc,
  #          label = label_loc[label_loc$Var == "Recreational Effort",]$labels,
  #          size = letter_size)+
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000000}, limits = ylim_re)+
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Recreational effort")+
  ggplot2::ylab(expression("Days fished (10"^6*" N)")) +
  ggplot2::xlab("")+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts() 

rec_div <- recdat %>% 
  dplyr::filter(Var == "Recreational fleet effort diversity across modes") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  # annotate("text", 
  #          x = label_loc[label_loc$Var == "Recreational fleet effort diversity across modes",]$xloc,
  #          y = label_loc[label_loc$Var == "Recreational fleet effort diversity across modes",]$yloc,
  #          label = label_loc[label_loc$Var == "Recreational fleet effort diversity across modes",]$labels,
  #          size = letter_size)+
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  ggplot2::ylim(ylim_rd)+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Rec. fleet effort diversity")+
  ggplot2::ylab(expression("Effective Shannon")) +
  ggplot2::xlab("")+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()

rec_div_catch <- recdat %>% 
  dplyr::filter(Var == "Recreational Diversity of Catch") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
    # annotate("text", 
    #        x = label_loc[label_loc$Var == "Recreational anglers",]$xloc,
    #        y = label_loc[label_loc$Var == "Recreational anglers",]$yloc,
    #        label = label_loc[label_loc$Var == "Recreational anglers",]$labels,
    #        size = letter_size)+
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Rec. diversity of catch")+
  ggplot2::ylab(expression("Effective Shannon")) +
  ggplot2::xlab("Time")+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()



cowplot::plot_grid(rec_effort, 
                   rec_div, 
                   rec_div_catch,
                   ncol = 1, 
                   align = "hv") +
    ggplot2::theme(plot.margin = unit(c(0.1, 0, 0, 0), "cm"))


```

#### Recreational Shark Landings

```{r rec_hms, fig.cap="SHark Landings by Yea."}
ecodata::rec_hms %>% 
  dplyr::filter(Region == "Mid-Atlantic") %>% 
  ggplot2::ggplot()+
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var))+
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var))+
  ggplot2::ylab("Landings (number of fish)")+
  ggplot2::xlab("")+ 
  ggplot2::theme(legend.title = element_blank())+
  ecodata::theme_ts()

```

Recent pelagic landings coming primarily from Common Thresher and Shortfin Mako. 

### Primary Production Required

<span style="color: red;">NO NEW DATA</span>

```{r ppr, fig.cap="Primary production required to support the commercial landings. Included are the top species accounting for 80% of the landings in each year."}
ecodata::ppr %>% 
  dplyr::group_by(EPU) %>% 
  dplyr::mutate(hline = mean(Value)) %>% 
  dplyr::filter(EPU == "MAB") %>% 
  ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_point(aes(x = Time, y = Value))+
  ggplot2::geom_line(aes(x = Time, y = Value))+
  ggplot2::geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::ggtitle("Primary Production Required")+
  ggplot2::ylab("Proportion of Total PPD ")+
  ecodata::theme_ts()
```

### Wind Energy Revenue

```{r wind-revenue, fig.cap="Wind energy revenue in the Mid-Atlantic"}
ecodata::wind_revenue %>% 
  dplyr::mutate(Value = Value/1000000, 
                Time = as.numeric(Time)) %>% 
  tidyr::separate(Var, into=c("Var", "Trash"), sep = "[(]") %>% 
  dplyr::select(!Trash) %>% 
  #dplyr::group_by(EPU) %>% 
 # dplyr::mutate(hline = mean(Value)) %>% 
  dplyr::filter(EPU == "MAB") %>% 
  ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var))+
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var))+
  #ggplot2::facet_wrap(~Var, ncol = 1, scales = "free")+
  #ggplot2::geom_hline(aes(yintercept = hline),
  #         size = hline.size,
  #         alpha = hline.alpha,
  #         linetype = hline.lty)+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::ggtitle("Fishery Revenue in Wind Lease Areas")+
  ggplot2::ylab("2019 Constant Million Dollars ")+
  ecodata::theme_ts()
```


## Shelfwide Indicators

### Wind Development Speed

```{r wind-dev-speed0.30, eval = T, echo = F, fig.cap='', out.width='80%'}
labels<- ecodata::wind_dev_speed %>% 
  group_by(Time) %>% 
  summarise("Projects(n)" = length(Project_Name)) %>% 
  filter(!Time == "NA")

total_area<- ecodata::wind_dev_speed %>% 
  filter(Var == "Cumulative_area",
         !Time == "NA") %>% 
  group_by(Time) %>% 
  summarise(Value_2 = sum(Value)) %>% 
  mutate(Value_3 = cumsum(Value_2)) %>% 

  ggplot2::ggplot()+
  ggplot2::geom_point(aes(x = Time, y = Value_3))+
  ggplot2::ylab("Total Area (Acres)")+
  ggplot2::xlab("")+
  ggplot2::ggtitle("Cumulative Area")+
  ecodata::theme_ts()+
  theme(axis.text.x = element_text(angle = 90))
  
dist_area<- ecodata::wind_dev_speed%>% 
  filter(Var == "Cumulative_seafloor_disturbance",
         !Time == "NA") %>% 
  ggplot2::ggplot()+
  ggplot2::geom_point(aes(x = Time, y = Value))+
  ggplot2::ylab(" Total Seafloor Distubrance (Acres)")+
  ggplot2::xlab("")+
  ggplot2::ggtitle("Cumulative Seafloor Disturbance")+
  theme(axis.text.x = element_text(angle = 45))

foundations<- ecodata::wind_dev_speed%>% 
  filter(Var == "Cumulative_foundations",
         !Time == "NA") %>% 
  ggplot2::ggplot()+
  ggplot2::geom_point(aes(x = Time, y = Value))+
  ggplot2::ylab(" Foundations (n)")+
  ggplot2::xlab("")+
  ggplot2::ggtitle("Cumulative Number of Foundations")+
  theme(axis.text.x = element_text(angle = 45))

gridExtra::grid.arrange(
  gridExtra::tableGrob(labels, theme = gridExtra::ttheme_minimal(base_size = 8)),
  total_area,
  ncol = 2,
  widths = c(0.5, 1.5),
  clip = FALSE
)
```

### Wind Sites and Occurrence 

<span style="color: red;">NO NEW DATA</span>

These are the five species most likely to occur in the lease areas. 

```{r wind-occupancy, eval = T, echo = F, fig.cap='', out.width='80%'}
wind1 <- ecodata::wind_occupancy
wind1$trend<- ifelse(wind1$Trend == "pos", 
                    "$\\nearrow$",
                    ifelse(wind1$Trend == "neg",
                    "$\\searrow$", 
                    " ")) 
wind2<-wind1 %>% dplyr::select(Area, Season, Species, trend)
names<-c("Area", "Season", "Species", "trend")
bnew<-c("Area.1", "Season.1", "Species.1", "trend.1")
cnew<-c("Area.2", "Season.2", "Species.2", "trend.2")
dnew<-c("Area.3", "Season.3", "Species.3", "trend.3")
enew<-c("Area.4", "Season.4", "Species.4", "trend.4")
a<-wind2 %>% dplyr::filter(Area == "Existing-North") 
b<-wind2 %>% dplyr::filter(Area == "Proposed-North") %>% 
  dplyr::rename_at(vars(names), ~ bnew)
c<-wind2 %>% dplyr::filter(Area == "Existing-Mid")%>% 
  dplyr::rename_at(vars(names), ~ cnew)
d<-wind2 %>% dplyr::filter(Area == "Proposed-Mid")%>% 
  dplyr::rename_at(vars(names), ~ dnew)
e<-wind2 %>% dplyr::filter(Area == "Existing-South")%>% 
  dplyr::rename_at(vars(names), ~ enew)
all<- a %>% cbind(b,c,d,e) %>% 
  dplyr::select(2:4,7:8,11:12,15:16,19:20)
  
kable(all, escape = FALSE,
      col.names = c("Season", "Species", "Trend", "Species", "Trend", "Species","Trend", "Species","Trend", "Species", "Trend"),
      caption = "Species with highest probability of occupancy species each season and area, with observed trends",
      booktabs = T) %>%
    add_header_above(c(" " = 1, "Existing - North" = 2, "Proposed - North" = 2, 
                     "Existing - Mid" = 2, "Proposed - Mid" = 2, 
                     "Existing - South" = 2)) %>%
  kable_styling(latex_options = c("hold_position", "scale_down")) 
```


<!-- ```{r wind-map, eval = T, echo = F, fig.cap="Map of BOEM existing (black) and proposed (red) lease areas as of February 2019.", message=FALSE, results=FALSE} -->


<!-- nesbath <- marmap::fortify.bathy(marmap::getNOAA.bathy(lon1 = -77, lon2 = -65, lat1 = 35, lat2 = 45, -->
<!--               resolution = 5)) -->

<!-- lease_s<-sf::st_read(file.path(gis.dir, 'BOEM lease areas/ne_existing_leasesSPoly.shp')) -->
<!-- lease_n<-sf::st_read(file.path(gis.dir, 'BOEM lease areas/ne_existing_leasesNPoly.shp')) -->
<!-- lease_m<-sf::st_read(file.path(gis.dir, 'BOEM lease areas/ne_existing_leasesMPoly.shp')) -->
<!-- prop_n<-sf::st_read(file.path(gis.dir, 'BOEM lease areas/ne_proposed_leases_NPoly.shp')) -->
<!-- prop_m<-sf::st_read(file.path(gis.dir, 'BOEM lease areas/ne_proposed_leases_MPoly.shp')) -->

<!-- invisible(sf::st_crs(lease_s)<-crs) -->
<!-- invisible(sf::st_crs(lease_n)<-crs) -->
<!-- invisible(sf::st_crs(lease_m)<-crs) -->
<!-- invisible(sf::st_crs(prop_n)<-crs) -->
<!-- invisible(sf::st_crs(prop_m)<-crs) -->

<!-- ggplot2::ggplot() + -->
<!--   ggplot2::geom_raster(data = nesbath, aes(x=x,y=y, fill = z)) + -->
<!--   ggplot2::scale_fill_gradientn(colors =c("lightcyan","lightblue4"))+ -->
<!--   ggplot2::geom_sf(data = ecodata::coast, size = map.lwd) + -->
<!--   ggplot2::geom_sf(data = epu_sf, fill = "transparent", size = map.lwd) + -->
<!--   ggplot2::geom_sf(data = lease_s, size = map.lwd, color = "black")+ -->
<!--   ggplot2::geom_sf(data = lease_n, size = map.lwd, color = "black")+ -->
<!--   ggplot2::geom_sf(data = lease_m, size = map.lwd, color = "black")+ -->
<!--   ggplot2::geom_sf(data = prop_n, size = map.lwd, color = "red3")+ -->
<!--   ggplot2::geom_sf(data = prop_m, size = map.lwd, color = "red3")+ -->
<!--   ggplot2::coord_sf(crs = crs, xlim = c(-77, -69), ylim = c(36,42))+ -->
<!--   ggplot2::geom_segment(aes(x = -74.6, y = 37.4, xend =-75.4, yend =38), colour = "blue4")+ -->
<!--   ggplot2::geom_segment(aes(x = -71.1, y = 40.2, xend =-71.6, yend =41.1), colour = "blue4")+ -->
<!--   ggplot2::annotate("text", x = -74.9, y = 37, label = "S")+ -->
<!--   ggplot2::annotate("text", x = -73.5, y = 38.7, label = "M")+ -->
<!--   ggplot2::annotate("text", x = -70.5, y = 40.2, label = "N")+ -->
<!--   ggspatial::annotation_scale(location = "br", width_hint = 0.4) + -->
<!--   ggplot2::theme_bw( ) + -->
<!--   ggplot2::ylab("")+ -->
<!--   ggplot2::xlab("")+ -->
<!--   ggplot2::theme(legend.position = "none") + -->
<!--   ggplot2::ggtitle("BOEM lease areas") -->

<!-- ```  -->



