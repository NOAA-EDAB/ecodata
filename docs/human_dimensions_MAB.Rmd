---
title: "Human Dimensions MAB and Shelf-wide"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    theme: lumen
---

```{r setup, include=FALSE}
# Image Directory
image.dir <- here::here("docs/images")
gis.dir <- here::here("data-raw/gis")
#Default Rmd options
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center') #allows for inserting R code into captions

#Plotting and data libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(ecodata)
library(here)
library(kableExtra)
library(ggrepel)
library(stringr)
#library(patchwork)
library(grid)
library(cowplot)

#GIS libraries
library(sf)
library(rgdal)
library(raster)
library(ggspatial)
library(marmap)


#General inline text input for report

#Council
council <- "Mid-Atlantic Fishery Management Council"
council_abbr <- "MAFMC"

#Region identifiers
epu <- "Mid-Atlantic Bight"
epu_abbr <- "MAB"
region <- "Mid-Atlantic"
region_abbr <- "MA" #Some commercial data organized by "MA" or "NE" regions, not by EPU 


```

```{r GIS-setup}

#CRS
crs <- "+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0 +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#EPU shapefile
epu_sf <- ecodata::epu_sf %>% 
  filter(EPU %in% c("MAB","GB","GOM"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -77
xmax = -65
ymin = 36
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

#Time series constants
shade.alpha <- 0.3
shade.fill <- "lightgrey"
lwd <- 1
pcex <- 2
trend.alpha <- 0.5
trend.size <- 2
hline.size <- 1
hline.alpha <- 0.35
hline.lty <- "dashed"
label.size <- 5
hjust.label <- 1.5
letter_size <- 4
feeding.guilds1<- c("Piscivore","Planktivore","Benthivore","Benthos")
feeding.guilds <- c("Apex Predator","Piscivore","Planktivore","Benthivore","Benthos")
x.shade.min <- 2010
x.shade.max <- 2020

#Define constants for figure plot
series.col <- c("indianred","black")

#Function for custom ggplot facet labels
label <- function(variable,value){
  return(facet_names[value])
}
```

Trend lines are shown when slope is significantly different from 0 at the p < 0.05 level. An orange line signifies an overall positive trend, and purple signifies a negative trend. To minimize bias introduced by small sample size, no trend is fit when N < 30. Dashed lines represent mean values of time series unless the indicator is an anomaly, in which case the dashed line is equal to 0. Shaded regions indicate the past ten years. If there are no new data for 2018, the shaded region will still cover this time period.

## Mid-Atlantic

### Commercial {.tabset .tabset-fade}

#### Commercial landings



```{r comdat-commercial-landings, fig.cap="MAFMC managed species landings (red) and total commercial landings (black) by feeding guild. \\label{comm-landings}"}



#Managed landings
managed_landings <- ecodata::comdat  %>%
  dplyr::filter(stringr::str_detect(Var, paste0(council_abbr," managed species - Landings weight|JOINT managed species - Landings weight")),
         !stringr::str_detect(Var, "Other"),
         Time >= 1986,
         EPU == epu_abbr)

#Total landings
total_landings <- ecodata::comdat  %>%
  dplyr::filter(!stringr::str_detect(Var, "managed species"),
         !stringr::str_detect(Var, "Other"),
         stringr::str_detect(Var, "Landings"),
         Time >= 1986,
         EPU == epu_abbr)

#Assign feeding guild column for plotting with ggplot
landings <- 
  rbind(managed_landings, total_landings) %>%
  dplyr::filter(Var != "Apex Predator Landings") %>% 
  dplyr::mutate(feeding.guild = stringr::str_extract(Var,paste(feeding.guilds, collapse = "|")),
         grouping = factor(ifelse(stringr::str_detect(Var,council_abbr), "managed",
                                  ifelse(stringr::str_detect(Var, "JOINT"), "joint","total"))),
         Var = paste(word(feeding.guild), grouping)) %>% 
  dplyr::mutate(feeding.guild = factor(feeding.guild, levels = feeding.guilds))

#Add JOINT landings to MANAGED landings and remove
landings[landings$Var ==  "Piscivore managed",]$Value <- landings[landings$Var ==  "Piscivore managed",]$Value + landings[landings$Var ==  "Piscivore joint",]$Value

landings <- landings %>%
  dplyr::filter(Var != "Piscivore joint")  %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value))


#facet names for titles
facet_names <- list("Apex" = expression("Apex"),
                    "Piscivores" = expression("Piscivores"),
                    "Planktivores" = expression("Planktivores"),
                    "Benthivores" = expression("Benthivores"),
                    "Benthos" = expression("Benthos"))

p2<- landings %>% 
  dplyr::filter(EPU == "MAB") %>% 
  ggplot2::ggplot(aes(x = Time, y = Value, color = grouping)) +
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var)) +
  
  #Add time series
  ggplot2::geom_line(size = lwd) +
  ggplot2::geom_point(size = pcex) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 color = grouping,
                 size = grouping),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  ggplot2::facet_wrap(feeding.guild~., scales = "free", labeller = label, ncol = 1)+
  
  #Axis and theme
  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000})+
  ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  ggplot2::ylab(expression("Landings (10"^3*"metric tons)")) +
  ggplot2::xlab(element_blank())+
  ecodata::theme_facet() +
  ggplot2::theme(strip.text=element_text(hjust=0))

p2
```

```{r hms-landings-comdat-commercial_landings, warning=F, fig.cap = ("HMS groups include “Bluefin Tuna”, “BAYS”, “Swordfish”, “Large Coastal Sharks”, “Small Coastal Sharks”, “Pelagic Sharks”, “Smoothhound Sharks”. “BAYS” includes bigeye, albacore, yellowfin and skipjack tunas. “Large Coastal Sharks” includes blacktip, bull, great hammerhead, scalloped hammerhead, smooth hammerhead, lemon, nurse, sandbar, silky, spinner, and tiger sharks. “Small Coastal Sharks” includes Atlantic sharpnose, blacknose, bonnethead, finetooth sharks. “Pelagic Sharks” includes blue, porbeagle, shortfin mako, and thresher sharks. “Smoothhound Sharks” includes smooth dogfish shark.")}

## Apex pred
apex<-ecodata::hms_landings %>% 
  dplyr::filter(stringr::str_detect(Var, "Landings")) %>% 
  separate(Var, c("Var", "trash"), sep = "_")

##Plot
p1<-apex %>% 
  dplyr::filter(EPU == "MAB") %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value)) %>% 

  ggplot2::ggplot(aes(x = YEAR, y = Value, color = Var)) +
  
  #Add time series
  ggplot2::geom_line(size = lwd) +
  ggplot2::geom_point(size = pcex) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 color = Var,
                 size = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  #Highlight last ten years
  # ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
  #     xmin = x.shade.min , xmax = x.shade.max,
  #     ymin = -Inf, ymax = Inf) +
  # #Axis and theme
  #ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000})+
  #ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 5), limits = c(1985, 2020)) +
  ecodata::theme_facet() +
  ggplot2::theme(strip.text=element_text(hjust=0), 
        legend.position = "bottom", 
        legend.direction = "horizontal", 
        legend.title = element_blank())+
  ggplot2::ylab(expression("Landings (metric tons)")) +
  ggplot2::xlab("Time")+
  ggplot2::ggtitle("HMS Landings")+
  ecodata::theme_title()

p1

``` 


```{r comdat-total-landings, fig.asp=.35, fig.cap = paste0("Total commercial seafood landings (black) shown with ",region," managed seafood landings (red). \\label{total-landings}")}

#Managed landings
managed_landings <- ecodata::comdat  %>%
  dplyr::filter(stringr::str_detect(Var, paste0(council_abbr," managed species - Landings weight|JOINT managed species - Landings weight")),
         !stringr::str_detect(Var, "Other"),
         Time >= 1986,
         EPU == epu_abbr)

# HMS Landings
apex<-ecodata::hms_landings %>% 
  dplyr::filter(stringr::str_detect(Var, "Landings")) %>% 
  separate(Var, c("Var", "trash"), sep = "_") %>% 
  group_by(YEAR) %>% 
  summarise(Value = sum(Value)) %>% 
  rename( Time = YEAR) %>% 
  mutate(Var = c("HMS Landings"), 
         Units = c("metric tons"), 
         EPU = c("MAB"))

#Total landings
total_landings <- ecodata::comdat  %>%
  dplyr::filter(!stringr::str_detect(Var, "managed species"),
         !stringr::str_detect(Var, "Other"),
         !stringr::str_detect(Var, "Apex"),
         stringr::str_detect(Var, "Landings"),
         Time >= 1986,
         EPU == epu_abbr) %>% 
  rbind(apex)

total_landings_agg <- total_landings %>%
  dplyr::group_by(Time) %>%
  dplyr::summarise(Value = sum(Value)) %>% 
  dplyr::mutate(Var = "Total",hline = mean(Value))

managed_landings_agg <- managed_landings %>%
  dplyr::group_by(Time) %>%
  dplyr::summarise(Value = sum(Value)) %>% 
  dplyr::mutate(Var = "Managed",hline = mean(Value))

landings_agg <- rbind(total_landings_agg, managed_landings_agg)


ggplot2::ggplot(data = landings_agg)+
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000})+
  ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ylab(expression("Landings (10"^3*"mt)")) +
  ggplot2::xlab(element_blank())+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ggplot2::ggtitle("Total Landings")+
  ggplot2::theme(axis.title.y = element_text(size = 7))+
  ecodata::theme_ts()+
  ecodata::theme_title()



```

#### Commercial revenue 

```{r bennet, fig.cap = paste0("Revenue change from the 2015 values in dollars (black), Price (PI), and Volume Indicators (VI) for commercial landings in the Mid-Atlantic Bight. \\label{bennet}")}

#Filter data into two dataframes for plotting

indicators <- ecodata::bennet %>% 
  dplyr::filter(EPU == epu_abbr) %>% 
  dplyr::filter(stringr::str_detect(Var, pattern="Total"),
         !Var == "Total Revenue Change - Bennet", 
         !Time < 1985) %>% 
  dplyr::mutate(Var, Var = plyr::mapvalues(Var, from = c("Total Volume Index - Bennet", "Total Price Index - Bennet"),
                                           to = c("Volume","Price"))) %>% 
  dplyr::group_by(Time) %>% 
  dplyr::mutate(New = sum(Value))

revchange <- ecodata::bennet %>% 
  dplyr::filter(EPU == "MAB",
         Var %in% c("Total Revenue Change - Bennet"),
         !Time<1985)
#custom bar fill color (color-blind friendly)
ind_fill <- c("#a6cee3", "#b2df8a")

#limits
y.lim <- c(-450,600)

#plot
ggplot2::ggplot()+
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  ggplot2::geom_bar(data = indicators, aes(x = Time, y = Value, fill = Var), stat="identity")+
  ggplot2::scale_fill_manual(name = "Indicators", values = ind_fill) +
  ggplot2::geom_line(data = revchange, aes(x = Time, y = Value, color = "$"))+
  ggplot2::scale_colour_grey(name ="Revenue Change") +
  ggplot2::ggtitle("Bennet Indicator")+
  ggplot2::labs(y="Value $1,000,000 ($2015)") +
  ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  ggplot2::scale_y_continuous(breaks = seq(y.lim[1], y.lim[2], by = 100), 
                              limits = y.lim, expand = c(0.01, 0.01)) +
  ecodata::theme_ts() +
  ggplot2::xlab(element_blank())+
  ggplot2::theme(title = element_text(size = 10))+
  ecodata::theme_title()

```

```{r bennet-all, fig.cap = paste0("Revenue change from the 2015 values in dollars (black), Price (PI), and Volume Indicators (VI) for commercial landings in the Mid-Atlantic Bight. \\label{bennet}")}

#Filter data into two dataframes for plotting

indicators <- ecodata::bennet %>% 
  dplyr::filter(EPU == epu_abbr) 

indicators <- ecodata::bennet %>% 
  dplyr::filter(EPU == epu_abbr) 

indicators$Var<- gsub( "Predator", "", indicators$Var)
indicators$Var<- gsub( "Value", "Volume", indicators$Var)
indicators<- indicators %>% 
  separate(Var, c("Guild", "Var") ) %>% 
  dplyr::filter(!Var == "Revenue",
                !Guild == "Total", 
         !Time < 1985) %>% 
  dplyr::group_by(Time,  Var) %>% 
  dplyr::mutate(component = sum(Value)) %>% 
  ungroup()

  # dplyr::filter(#stringr::str_detect(Var, pattern="Total"),
  #        !Var == "Total Revenue Change - Bennet", 
  #        !Time < 1985) %>% 
  # dplyr::mutate(Var, Var = plyr::mapvalues(Var, from = c("Total Volume Index - Bennet", "Total Price Index - Bennet"),
  #                                          to = c("Volume","Price"))) %>% 
  # dplyr::group_by(Time) %>% 
  # dplyr::mutate(New = sum(Value)) %>% 
  # dplyr::group_by(Time, Var) %>% 
  # dplyr::mutate(component = sum(Value))

revchange <- ecodata::bennet %>% 
  dplyr::filter(EPU == "MAB",
         #Var %in% c("Total Revenue Change - Bennet"),
         !Time<1985)
#custom bar fill color (color-blind friendly)
#ind_fill <- c("#a6cee3", "#b2df8a", "#000001")

#limits
y.lim <- c(-400,550)

indicators$Guild<-factor(indicators$Guild, levels = c("Apex", "Piscivore", "Planktivore", 
                                                      "Benthivore", "Benthos", "Other"))

#plot
ggplot2::ggplot()+
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  ggplot2::geom_bar(data = indicators, aes(x = Time, y = Value, fill = Guild), stat="identity")+
  #ggplot2::scale_fill_manual(name = "Indicators", values = Guild) +
  ggplot2::geom_line(data = indicators, aes(x = Time, y = component, color = "$"))+
  ggplot2::facet_wrap(~Var)+
  ggplot2::scale_colour_grey(name ="Component") +
  ggplot2::ggtitle("Bennet Indicator")+
  ggplot2::labs(y="Value $1,000,000 ($2015)") +
  ggplot2::scale_x_continuous(breaks = seq(1990, 2020, by = 10), expand = c(0.01, 0.01)) +
  ggplot2::scale_y_continuous(breaks = seq(y.lim[1], y.lim[2], by = 100), 
                              limits = y.lim, expand = c(0.01, 0.01)) +
  ggplot2::scale_fill_brewer(palette = "Set1")+
  ecodata::theme_ts() +
  ggplot2::xlab(element_blank())+
  ggplot2::theme(title = element_text(size = 10))+
  ecodata::theme_title()+
  ecodata::theme_facet()

```

```{r bennet2, fig.cap = paste0("Revenue change from the 2015 values in dollars (black), Price (PI), and Volume Indicators (VI) for commercial landings in the Mid-Atlantic Bight. \\label{bennet}")}

#Filter data into two dataframes for plotting

indicators <- ecodata::bennet %>% 
  dplyr::filter(EPU == epu_abbr) 

indicators$Var<- gsub( "Predator", "", indicators$Var)
indicators$Var<- gsub( "Value", "Volume", indicators$Var)
indicators<- indicators %>% 
  separate(Var, c("Guild", "Var") ) %>% 
  dplyr::filter(!Var == "Revenue",
                !Guild == "Total", 
         !Time < 1985) %>% 
  dplyr::group_by(Time, Guild) %>% 
  dplyr::mutate(New = sum(Value))

revchange <- ecodata::bennet %>% 
  dplyr::filter(EPU == "MAB",
         Var %in% c("Total Revenue Change - Bennet"),
         !Time<1985)
#custom bar fill color (color-blind friendly)
ind_fill <- c("#a6cee3", "#b2df8a")

#limits
y.lim <- c(-450,600)

#plot
ggplot2::ggplot()+
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  ggplot2::geom_bar(data = indicators, aes(x = Time, y = Value, fill = Var), stat="identity")+
  ggplot2::scale_fill_manual(name = "Indicators", values = ind_fill) +
  ggplot2::geom_line(data = revchange, aes(x = Time, y = Value, color = "$"))+
  ggplot2::scale_colour_grey(name ="Revenue Change") +
  ggplot2::ggtitle("Bennet Indicator")+
  ggplot2::labs(y="Value $1,000,000 ($2015)") +
  ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 10), expand = c(0.01, 0.01)) +
  ggplot2::scale_y_continuous(breaks = seq(y.lim[1], y.lim[2], by = 100), 
                              limits = y.lim, expand = c(0.01, 0.01)) +
  ecodata::theme_ts() +
  ggplot2::facet_wrap(~Guild)+
  ggplot2::theme(title = element_text(size = 10), 
                 legend.position = "bottom")+
  ecodata::theme_title()

```

```{r bennet-table}
indicators <- ecodata::bennet %>% 
  dplyr::filter(EPU == epu_abbr) 

indicators$Var<- gsub( "Predator", "", indicators$Var)
indicators$Var<- gsub( "Value", "Volume", indicators$Var)
indicators<- indicators %>% 
  separate(Var, c("Guild", "Var") ) %>% 
  dplyr::filter(!Var == "Revenue",
                !Guild == "Total", 
         !Time < 1985) %>% 
  dplyr::group_by(Time, Guild) %>% 
  dplyr::mutate(New = sum(Value)) %>% 
  ungroup()

#dplyr::select(ind2, !c(Units, EPU, Guild, Source, Var, New))

ind2<- indicators %>% 
  dplyr::mutate(Name = paste(Guild, Var)) %>% 
  dplyr::select(-c(Guild, Units, EPU, Source, Var, New)) %>% 
  tidyr::pivot_wider(names_from = Name, values_from = Value) %>% 
  dplyr::select(Time, `Apex Volume`, `Apex Price`, 
                `Benthivore Volume`, `Benthivore Price`, 
                `Benthos Volume`, `Benthos Price`,
                `Planktivore Volume`, `Planktivore Price`,
                `Piscivore Volume`, `Piscivore Price`,
                `Other Volume`, `Other Price` )

Table<- kable(ind2, col.names = c("Time", "Volume", "Price",  "Volume", "Price",
                           "Volume", "Price",  "Volume", "Price", 
                           "Volume", "Price",  "Volume", "Price")) %>% 
  kableExtra::add_header_above(c(" ", "Apex Pred" = 2, "Benthivore" = 2, 
                                 "Benthos" = 2, "Planktivore" = 2, 
                                 "Piscivore" = 2, "Other" = 2))


```



```{r comdat-comm-revenue,  fig.cap = "Total revenue for the region (black) and revenue from MAFMC managed species (red). \\label{comm-rev}"}
## Apex pred
apex<-ecodata::hms_landings %>% 
  dplyr::filter(stringr::str_detect(Var, "Revenue")) %>% 
  separate(Var, c("Var", "trash"), sep = "_") %>% 
  group_by(YEAR) %>% 
  summarise(Value = sum(Value)) %>% 
  rename( Time = YEAR) %>% 
  mutate(Var = c("HMS Revenue"), 
         Units = c("metric tons"), 
         EPU = c("MAB"))
#Filtering and aggregation step
rev_agg <- ecodata::comdat %>% 
  dplyr::filter(stringr::str_detect(Var, "Revenue"),
         !stringr::str_detect(Var, "Apex|prop|Other|NEFMC"), #Remove proportions, "Other" category species, NEFMC managed species in MAB
         EPU == epu_abbr,
         Time >= 1986) %>% 
  rbind(apex) %>% 
  dplyr::mutate(Status = ifelse(str_detect(Var, "managed"), 
                         "Managed","Total")) %>% #Create groups for aggregation
  dplyr::group_by(Status, Time) %>% 
  dplyr::summarise(Total = sum(Value)) %>% 
  dplyr::group_by(Status) %>% 
  dplyr::mutate(hline = mean(Total))

series.col <- c("indianred","black")

#Plotting
ggplot2::ggplot(data = rev_agg) +
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+  
  
  #lines
  ecodata::geom_gls(aes(x = Time, y = Total,
               group = Status),
             alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Total, color = Status), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Total, color = Status), size = 1.5) +

  #axes
  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000000})+
  ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
      scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Total revenue") +
  ggplot2::ylab(expression("Revenue (10"^6*"USD)")) +
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Status),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ggplot2::xlab(element_blank())+
  ecodata::theme_ts()+
  ecodata::theme_title()



```

```{r hms-comm-revenue,  fig.cap = "HMS revenue. \\label{comm-rev}"}
## Apex pred
apex<-ecodata::hms_landings %>% 
  dplyr::filter(stringr::str_detect(Var, "Revenue")) %>% 
  separate(Var, c("Var", "trash"), sep = "_")


#Define constants for figure plot
series.col <- c("indianred","black")

##Plot
p1<-apex %>% 
  dplyr::filter(EPU == "MAB") %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(Value = Value/1000000, 
                hline = mean(Value)) %>% 

  ggplot2::ggplot(aes(x = YEAR, y = Value, color = Var)) +
  
  #Add time series
  ggplot2::geom_line(size = lwd) +
  ggplot2::geom_point(size = pcex) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 color = Var,
                 size = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  #Highlight last ten years
  # ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
  #     xmin = x.shade.min , xmax = x.shade.max,
  #     ymin = -Inf, ymax = Inf) +
  # #Axis and theme
  #ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000})+
  #ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 5), limits = c(1985, 2020)) +
  ecodata::theme_facet() +
  ggplot2::theme(strip.text=element_text(hjust=0), 
        legend.position = "bottom", 
        legend.direction = "horizontal", 
        legend.title = element_blank())+
  ggplot2::ylab(expression("Revenue (10^6 US Dollars)")) +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("HMS Revenue")+
  ecodata::theme_title()

p1

```

#### Commercial diversity

```{r commercial-div, fig.cap = paste0("Fleet diversity and fleet count in the ",region,". \\label{comm-div}")}

# 
comm_div <- ecodata::commercial_div %>% 
  dplyr::filter(EPU == region_abbr) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value))

ylim_fc <- c(min(comm_div[comm_div$Var == "Fleet count",]$Value) - 10, max(comm_div[comm_div$Var == "Fleet count",]$Value) + 10 )
ylim_fd <- c(0, max(comm_div[comm_div$Var == "Fleet diversity in revenue",]$Value) + 3 )
# 
# #Create dataframe for label locations
# label_loc <- data.frame(xloc = min(comm_div$Time)+0.25,
#                         yloc = c(ylim_fc[2]*0.95, ylim_fd[2]*0.95),
#                         labels = LETTERS[1:2],
#                         Var = c("Fleet count","Fleet diversity in revenue"))
# 
 series.col = c("black")


fleet_count <- comm_div %>% 
  dplyr::filter(Var == "Fleet count") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  #label
  # annotate("text", x = label_loc[label_loc$Var == "Fleet count",]$xloc,
  #          y = label_loc[label_loc$Var == "Fleet count",]$yloc,
  #          label = label_loc[label_loc$Var == "Fleet count",]$label,
  #          size = letter_size) +

  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  ggplot2::ylim(ylim_fc)+
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Fleet count") +
  ggplot2::ylab(expression("Count (n)")) +
  ggplot2::xlab("")+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()+
  ecodata::theme_title()

fleet_div <- comm_div %>% 
  dplyr::filter(Var == "Fleet diversity in revenue") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
 ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
    #label
  # annotate("text", x = label_loc[label_loc$Var == "Fleet diversity in revenue",]$xloc,
  #          y = label_loc[label_loc$Var == "Fleet diversity in revenue",]$yloc,
  #          label = label_loc[label_loc$Var == "Fleet diversity in revenue",]$label,
  #          size = letter_size) +

  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  ggplot2::ylim(ylim_fd)+
  
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Fleet diversity") +
  ggplot2::ylab(expression("Effective Shannon")) +
  ggplot2::xlab(element_blank())+

  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
 ecodata::theme_ts()+
 ecodata::theme_title()

cowplot::plot_grid(fleet_count, fleet_div, ncol = 1, align = "hv") + 
  ggplot2::theme(plot.margin = unit(c(0.1, 0, 0, 0), "cm"))

```


```{r commercial-div-species-div,  fig.cap = paste0("Species revenue diversity in the ",region,". \\label{spec-div}")}
comm_div %>% 
  dplyr::filter(Var == "Permit revenue species diversity") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  # geom_gls(aes(x = Time, y = Value,
  #              group = Var),
  #            alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Permit revenue species diversity") +
  ggplot2::ylab(expression("Effective Shannon")) +
  ggplot2::xlab(element_blank())+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
 ecodata::theme_ts()+
 ecodata::theme_title()
```

#### Stock status

```{r stock-status, echo=FALSE, warning=F, fig.cap = paste0("Summary of single species status for MAMFC and jointly managed stocks, Goosefish and Dogfish jointly managed.")} 
#Get data, spread for plotting, and filter
stock_status <- ecodata::stock_status %>%
  dplyr::mutate(Code = recode(Code, "Dogfish" = "Sp. Dogfish" )) %>% 
  tidyr::spread(.,Var,Value) %>% 
  dplyr::filter(Council %in% c("MAFMC","Both")) %>% 
  dplyr::group_by(Stock) %>% 
  dplyr::mutate(score = case_when(
    (B.Bmsy <0.5) ~"a",
    (F.Fmsy >1) ~ "a", 
    (F.Fmsy < 1 & B.Bmsy > 0.5 & B.Bmsy < 1) ~ "b",
    (F.Fmsy < 1 & B.Bmsy > 1) ~ "c"))
#Plot constants
y.max <- 2.0 #1.75 mackerel cut off F/Fmsy is 1.8
x.max <- 2.6
#A dataframe that defines custom legend for stocks with unknown status
unknown <- data.frame(text = c("Unknown Status", "Longfin Squid",
                              "Shortfin Squid", "N. Goosefish", "S. Goosefish", "Blueline Tilefish"),
                    x = rep(0.9*x.max,6), y = seq(0.93*y.max,1.3,-0.1))

# Custom Color
custom_color<- c("#56B4E9", "#009E73", "#0072B2")
#Plotting code
ggplot2::ggplot(data = stock_status) +
  ggplot2::geom_vline(xintercept = 1, linetype = "dotted")+
  ggplot2::geom_vline(xintercept = 0.5, linetype = "dashed")+
  ggplot2::geom_hline(yintercept = 1, linetype = "dashed") +
  ggplot2::geom_point(aes(x = B.Bmsy,
                 y = F.Fmsy,
                 shape = Council,
                 color = score)) +
  ggrepel::geom_text_repel(aes(x = B.Bmsy, #geom_text_repel auto-jitters text around points
                      y = F.Fmsy,
                      label = Code, 
                      color = score), 
                  show.legend = FALSE, nudge_y = -0.01, nudge_x = 0.05) +
  ggplot2::scale_color_brewer(palette = "Dark2",
                     breaks = stock_status$score) +
  ggplot2::ylim(0,y.max) +
  ggplot2::xlim(0,x.max) +
  ggplot2::geom_text(data = unknown, aes(x = x, y = y, label = text), #Custom legend for unknown stock status
            size = c(4.75,rep(4,5))) +
  ggplot2::annotate("rect", xmin = 0.8*x.max,
           xmax = x.max,
           ymin = 0.65*y.max,
           ymax = 0.90*y.max,
           alpha = 0.1) +
  ggplot2::xlab(expression(~B/B[msy])) +
  ggplot2::ylab(expression(~F/F[msy])) +
  ggplot2::guides(color = FALSE) +
  ecodata::theme_ts()
```

#### Oyster aquaculture

```{r aquaculture, fig.cap = "Oyster aquaculture production in pieces. \\label{oyster-aqua}"}

aqua <- ecodata::aquaculture %>%
  dplyr::filter(Region %in% c("MD", "VA", "NJ")) %>% 
  dplyr::filter(!Value == "NA") %>% 
  dplyr::mutate(Time = as.integer(Time), 
                Value = as.numeric(Value))

ggplot2::ggplot() +
 #Highlight last ten years
  ggplot2::geom_line(data = aqua, aes(x = Time, y = Value, color = Region), size = lwd) +
  ggplot2::geom_point(data = aqua,aes(x = Time, y = Value, color = Region), size = pcex) +
  #ggplot2::facet_wrap(~Region, nrow = 3)+
  ggplot2::ggtitle("Oyster Production in MAB")+
  ggplot2::ylab(expression("Oysters production")) +
  ggplot2::xlab(element_blank())+
  scale_x_continuous(breaks=c(2009,2011,2013,2015, 2017, 2019))+
  ecodata::theme_ts()+
  ecodata::theme_title()

# aqua %>% group_by(Time) %>% summarise(Value = sum(Value)) %>% 
#   dplyr::filter(Time %in% c(max(Time), max(Time-1))) %>% 
#   dplyr::summarise(m = mean(Value))
# 
# aqua %>% group_by(Time) %>% summarise(Value = sum(Value)) %>% 
#   dplyr::filter(Time %in% c(max(Time-2), max(Time-3),  max(Time-4)), 
#                 !Value == "NA") %>%  
#   dplyr::summarise(m= mean(Value))

```

#### Engagement and reliance

```{r commercial-engagement, message=F, fig.cap= "Commercial engagement and reliance for the top top commercial fishing communities in the Mid-Atlantic.", message = FALSE, warning=FALSE}

com<-ecodata::engagement %>% 
  dplyr::filter(Region == "Mid-Atlantic", 
                Fishery == "Commercial")

com2<-com %>% 
  ggplot2::ggplot()+
  ggplot2::geom_point(aes(x = Eng, y = Rel, color = Rating), size = 2)+
  ggplot2::geom_vline(xintercept = 1, linetype = "dashed",color = "black", size = 0.5)+
  ggplot2::geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.5) +
  ggrepel::geom_text_repel(aes(x = Eng, #geom_text_repel auto-jitters text around points
                      y = Rel,
                      label = Community,
                      color = Rating), show.legend = FALSE, direction = "both", box.padding = 0.3, size = 3)+
  ggplot2::scale_color_brewer(palette = "Dark2", #Change legend labels for clarity
                     breaks = com$Rating, 
                     direction = -1) +
  xlim(-1,12)+
  ylim(-1,5.5)+
  theme(legend.position=c(0.75, 0.85), 
        legend.title = element_blank(),       
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))+
  ggplot2::xlab("Commercial Engagement Score") +
  ggplot2::ylab("Commercial Reliance Score") +
  ggplot2::ggtitle("Social Vulnerability in Top Commercial Fishing Communities")+
  #ggplot2::guides(color = FALSE) +
  #theme_bw()
  ecodata::theme_ts()+
  ecodata::theme_title()
  #ecodata::theme_facet()
  
  
  gridExtra::grid.arrange(com2, bottom = textGrob("Low <--------------------------------------------------------------------------------------------------------------------------------------> High", 
                                     x = 0.5, y = 1, gp = gpar(fontsize = 7)),
                          left = textGrob("Low <----------------------------------------------------------------------------------------------------------> High", rot = 90,
                                   x = 1, y = 0.45, gp = gpar(fontsize = 7)))


```



### Recreational fisheries {.tabset .tabset-fade}

#### Recreational landings

```{r recdat-landings, fig.cap = paste0("Total recreational landings in the ",region," region. \\label{rec-landings}")}

landings_rec <- ecodata::recdat %>% 
  dplyr::filter(EPU == region_abbr,
         Var == "Recreational Seafood") %>% 
  dplyr::mutate(hline = mean(Value))

series.col <- "black"

ggplot2::ggplot(data = landings_rec)+
  
  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000000})+
  ggplot2::scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Recreational seafood harvest") +
  ggplot2::ylab(expression("Landings (N)")) +
  ggplot2::xlab(element_blank())+
  ggplot2::geom_hline(aes(yintercept = hline,
               
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()+
  ecodata::theme_title()
# 
# landings_rec %>% 
#   dplyr::filter(Time %in% c(max(Time), max(Time-1))) %>% 
#   dplyr::summarise(m = mean(Value))
# 
# landings_rec %>% 
#   dplyr::filter(Time %in% c(max(Time-2), max(Time-3),  max(Time-4))) %>% 
#   dplyr::summarise(m= mean(Value))
```

#### Recreational diversity

```{r recdat-effort,fig.cap = paste0("Recreational effort, recreational effort diversity, number of recreational anglers, and diversity of recreational catch in the ",region,". \\label{recdat}")}
recdat <- ecodata::recdat %>% 
  dplyr::filter(EPU == region_abbr) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value))

ylim_re <- c(2e7, 7e7)
ylim_rd <- c(1.75,2.75)
ylim_ra  <- c(1e6, 3.5e6)

# #Create dataframe for label locations
# label_loc <- data.frame(xloc = min(recdat$Time)+0.3,
#                         yloc = c(ylim_re[2]*0.975,
#                                  ylim_rd[2]*0.975,
#                                  ylim_ra[2]*0.975),
#                         labels = LETTERS[1:3],
#                         Var = c("Recreational Effort",
#                                 "Recreational fleet effort diversity across modes",
#                                 "Recreational anglers"))

series.col <- "black"
# x.shade.min <- max(recdat$Time, na.rm = T) - 9
# x.shade.max <- max(recdat$Time, na.rm = T)

rec_effort <- recdat %>% 
  dplyr::filter(Var == "Recreational Effort") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  #label
  # annotate("text", 
  #          x = label_loc[label_loc$Var == "Recreational Effort",]$xloc,
  #          y = label_loc[label_loc$Var == "Recreational Effort",]$yloc,
  #          label = label_loc[label_loc$Var == "Recreational Effort",]$labels,
  #          size = letter_size)+
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_y_continuous(labels = function(l){trans = l / 1000000}, limits = ylim_re)+
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Recreational effort")+
  ggplot2::ylab(expression("Days fished (10"^6*" N)")) +
  ggplot2::xlab(element_blank())+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts() +
  ecodata::theme_title()



rec_effort
```

```{r recdat-diversity}

recdat <- ecodata::recdat %>% 
  dplyr::filter(EPU == region_abbr) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value))

ylim_re <- c(2e7, 7e7)
ylim_rd <- c(1.75,2.75)
ylim_ra  <- c(1e6, 3.5e6)

series.col <- "black"

rec_div <- recdat %>% 
  dplyr::filter(Var == "Recreational fleet effort diversity across modes") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  # annotate("text", 
  #          x = label_loc[label_loc$Var == "Recreational fleet effort diversity across modes",]$xloc,
  #          y = label_loc[label_loc$Var == "Recreational fleet effort diversity across modes",]$yloc,
  #          label = label_loc[label_loc$Var == "Recreational fleet effort diversity across modes",]$labels,
  #          size = letter_size)+
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  ggplot2::ylim(ylim_rd)+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Rec. fleet effort diversity")+
  ggplot2::ylab(expression("Effective Shannon")) +
  ggplot2::xlab(element_blank())+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()+
  ecodata::theme_title()

rec_div

```


```{r recdat-div-catch}

recdat <- ecodata::recdat %>% 
  dplyr::filter(EPU == region_abbr) %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Value))

ylim_re <- c(2e7, 7e7)
ylim_rd <- c(1.75,2.75)
ylim_ra  <- c(1e6, 3.5e6)

series.col <- "black"

rec_div_catch <- recdat %>% 
  dplyr::filter(Var == "Recreational Diversity of Catch") %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
    # annotate("text", 
    #        x = label_loc[label_loc$Var == "Recreational anglers",]$xloc,
    #        y = label_loc[label_loc$Var == "Recreational anglers",]$yloc,
    #        label = label_loc[label_loc$Var == "Recreational anglers",]$labels,
    #        size = letter_size)+
  ecodata::geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::ggtitle("Rec. diversity of catch")+
  ggplot2::ylab(expression("Effective Shannon")) +
  ggplot2::xlab(element_blank())+
  ggplot2::geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()+
  ecodata::theme_title()

rec_div_catch
```

#### Recreational Engagement and Reliance

```{r recreational-engagement, message=F, fig.cap= "Commercial engagement and reliance for the top top recreational fishing communities in the Mid-atlantic."}

com<-ecodata::engagement %>% 
  dplyr::filter(Region == "Mid-Atlantic", 
                Fishery == "Recreational")

com2<-com %>% 
  ggplot2::ggplot()+
  ggplot2::geom_point(aes(x = Eng, y = Rel, color = Rating), size = 2)+
  ggplot2::geom_vline(xintercept = 1, linetype = "dashed", color = "black", size = 0.5)+
  ggplot2::geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.5) +
  ggrepel::geom_text_repel(aes(x = Eng, #geom_text_repel auto-jitters text around points
                      y = Rel,
                      label = Community,
                      color = Rating), show.legend = FALSE, direction = "both", box.padding = 0.3, size = 3)+
  ggplot2::scale_color_brewer(palette = "Dark2", #Change legend labels for clarity
                     breaks = com$Rating, 
                     direction = -1) +
  xlim(-1,12)+
  ylim(-1,16)+
  theme(legend.position=c(0.75, 0.83), 
        legend.title = element_blank(),       
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))+
  ggplot2::xlab("Recreation Engagement Score") +
  ggplot2::ylab("Recreation Reliance Score") +
  ggplot2::ggtitle("Social Vulnerability in Top Recreational Fishing Communities")+
  #ggplot2::guides(color = FALSE) +
  ecodata::theme_ts()+
  ecodata::theme_title()
  
  
  gridExtra::grid.arrange(com2, bottom = textGrob("Low <--------------------------------------------------------------------------------------------------------------------------------------> High", 
                                     x = 0.5, y = 1, gp = gpar(fontsize = 7)),
                          left = textGrob("Low <----------------------------------------------------------------------------------------> High", rot = 90,
                                   x = 1, y = 0.5, gp = gpar(fontsize = 7)))


```

#### Recreational Shark Landings

```{r rec_hms, fig.cap="Recreational shark landings from mrip."}
ecodata::rec_hms %>% 
  dplyr::filter(Region == "Mid-Atlantic") %>% 
  ggplot2::ggplot()+
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var))+
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var))+
  ggplot2::ylab("Landings (N)")+
  ggplot2::xlab(element_blank())+
  ggplot2::theme(legend.title = element_blank())+
  ecodata::theme_ts()

```

Recent pelagic landings coming primarily from Common Thresher and Shortfin Mako. 

### Primary Production Required


```{r ppr, fig.cap="Primary production required to support the commercial landings. Included are the top species accounting for 80% of the landings in each year."}
a<- ecodata::ppr %>% 
  dplyr::group_by(EPU) %>% 
  dplyr::mutate(hline = mean(Value)) %>% 
  dplyr::filter(Var == "PPR",
                EPU == "MAB", 
                Time <= 1997) 

ecodata::ppr %>% 
  dplyr::group_by(EPU) %>% 
  dplyr::mutate(hline = mean(Value)) %>% 
  dplyr::filter(Var == "PPR",
                EPU == "MAB", 
                Time >= 1997) %>% 
  ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_point(aes(x = Time, y = Value))+
  ggplot2::geom_line(aes(x = Time, y = Value))+
  ggplot2::geom_line(data = a, aes(x = Time, y = Value), linetype = "dashed")+
  ggplot2::geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::ggtitle("Primary Production Required")+
  ggplot2::ylab("Proportion of Total PPD ")+
  ggplot2::xlab(element_blank())+
  ecodata::theme_ts()+
  ecodata::theme_title()
```

### Fogarty Index

```{r fogarty, fig.cap="Fogarty Index"}

ecodata::ppr %>% 
  dplyr::filter(Var == "Fogarty") %>% 
  dplyr::mutate(Value = Value*1000) %>% 
  dplyr::group_by(EPU) %>% 
  dplyr::mutate(hline = mean(Value), 
                gr_up = c(0.92),
                rd_up = c(2.5),
                gr_lw = c(0.22),
                rd_lw = c(1)) %>% 
  dplyr::filter(EPU == "MAB") %>% 
  ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_ribbon( aes(ymin = gr_lw, ymax = gr_up, x = Time), fill = "darkolivegreen3", alpha = 0.5)+
  ggplot2::geom_ribbon( aes(ymin = rd_lw, ymax = rd_up, x = Time), fill = "sandybrown", aplha = 0.5)+
  #ggplot2::geom_hline(yintercept = .92, color = "green", linetype = "dashed")+
  #ggplot2::geom_hline(yintercept = .22, color = "green", linetype = "dashed")+
  #ggplot2::geom_hline(yintercept = 1, color = "red", linetype = "dashed")+
  #ggplot2::geom_hline(yintercept = 2.5, color = "red", linetype = "dashed")+
  ggplot2::geom_point(aes(x = Time, y = Value))+
  ggplot2::geom_line(aes(x = Time, y = Value))+
  #ggplot2::geom_line(data = a, aes(x = Time, y = Value), linetype = "dashed")+
  #ggplot2::geom_hline(aes(yintercept = hline),
  #         size = hline.size,
  #         alpha = hline.alpha,
  #         linetype = hline.lty)+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  #ggplot2::facet_wrap( ~ EPU)+
  ggplot2::ggtitle("Fogarty Index")+
  ggplot2::ylab("PPT")+
  ggplot2::xlab(element_blank())+
  ecodata::theme_ts()+
  ecodata::theme_title()
```

### Ryther

```{r ryther, fig.cap="Ryther Index"}


ecodata::ppr %>% 
  dplyr::filter(Var == "Ryther") %>% 
  dplyr::group_by(EPU) %>% 
  dplyr::mutate(hline = mean(Value), 
                gr_up = c(1.1),
                rd_up = c(5),
                gr_lw = c(0.3),
                rd_lw = c(3))%>%
  
  dplyr::filter(EPU == "MAB") %>% 
  ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_ribbon( aes(ymin = gr_lw, ymax = gr_up, x = Time), fill = "darkolivegreen3", alpha = 0.5)+
  ggplot2::geom_ribbon( aes(ymin = rd_lw, ymax = rd_up, x = Time), fill = "sandybrown", aplha = 0.5)+
  #ggplot2::geom_hline(yintercept = 0.3, color = "green", linetype = "dashed")+
  #ggplot2::geom_hline(yintercept = 1.1, color = "green", linetype = "dashed")+
  #ggplot2::geom_hline(yintercept = 3, color = "red", linetype = "dashed")+
  #ggplot2::geom_hline(yintercept = 5, color = "red", linetype = "dashed")+
  ggplot2::geom_point(aes(x = Time, y = Value))+
  ggplot2::geom_line(aes(x = Time, y = Value))+
  #ggplot2::geom_line(data = a, aes(x = Time, y = Value), linetype = "dashed")+
  #ggplot2::geom_hline(aes(yintercept = hline),
  #         size = hline.size,
  #         alpha = hline.alpha,
  #         linetype = hline.lty)+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  #ggplot2::facet_wrap( ~ EPU)+
  ggplot2::ggtitle("Ryther Index")+
  ggplot2::ylab("mt km-2 y-1")+
  ggplot2::xlab(element_blank())+
  ecodata::theme_ts()+
  ecodata::theme_title()
```

### Mean Trophic Level

```{r mtl, fig.cap="Mean trophic level"}

ecodata::ppr %>% 
  dplyr::filter(Var == "MTL") %>% 
  dplyr::group_by(EPU) %>% 
  dplyr::mutate(hline = mean(Value)) %>% 
  dplyr::filter(EPU == "MAB") %>% 
  ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_point(aes(x = Time, y = Value))+
  ggplot2::geom_line(aes(x = Time, y = Value))+
  ggplot2::geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  #ggplot2::facet_wrap( ~ EPU)+
  ggplot2::ggtitle("Mean Trophic Level")+
  ggplot2::ylab("")+
  ggplot2::xlab(element_blank())+
  ecodata::theme_ts()+
  ecodata::theme_title()
```

### PP reconstructed

```{r pp-reconstructed, fig.cap="reconstructed primary production"}


a<-ecodata::ppr %>% 
  dplyr::filter(Var == "PP") %>% 
  dplyr::group_by(EPU) %>% 
  dplyr::mutate(hline = mean(Value)) %>% 
  dplyr::filter(EPU == "MAB", 
                Time <=1997) 

ecodata::ppr %>% 
  dplyr::filter(Var == "PP") %>% 
  dplyr::group_by(EPU) %>% 
  dplyr::mutate(hline = mean(Value)) %>% 
  dplyr::filter(EPU == "MAB", 
                Time >=1997) %>% 
  ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  #ggplot2::geom_hline(yintercept = .92, color = "green", linetype = "dashed")+
  #ggplot2::geom_hline(yintercept = .22, color = "green", linetype = "dashed")+
  #ggplot2::geom_hline(yintercept = 1, color = "red", linetype = "dashed")+
  #ggplot2::geom_hline(yintercept = 2.5, color = "red", linetype = "dashed")+
  ggplot2::geom_point(aes(x = Time, y = Value))+
  ggplot2::geom_line(aes(x = Time, y = Value))+
  ggplot2::geom_line(data = a, aes(x = Time, y = Value), linetype = "dashed")+
  ggplot2::geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  #ggplot2::facet_wrap( ~ EPU)+
  ggplot2::ggtitle("PP Reconstrcted")+
  ggplot2::ylab("mtC region-1 year-1")+
  ecodata::theme_ts()+
  ecodata::theme_title()
```

### Wind Energy Revenue

```{r wind-revenue, fig.cap="Wind energy revenue in the Mid-Atlantic"}
ecodata::wind_revenue %>% 
  dplyr::mutate(Value = Value/1000000, 
                Time = as.integer(Time)) %>% 
  tidyr::separate(Var, into=c("Var", "Trash"), sep = "[(]") %>% 
  dplyr::select(!Trash) %>% 
  #dplyr::group_by(EPU) %>% 
 # dplyr::mutate(hline = mean(Value)) %>% 
  dplyr::filter(EPU == "MAB") %>% 
  ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_point(aes(x = Time, y = Value, color = Var))+
  ggplot2::geom_line(aes(x = Time, y = Value, color = Var))+
  #ggplot2::facet_wrap(~Var, ncol = 1, scales = "free")+
  #ggplot2::geom_hline(aes(yintercept = hline),
  #         size = hline.size,
  #         alpha = hline.alpha,
  #         linetype = hline.lty)+
  scale_x_continuous(breaks=c(2008,2012,2016, 2020))+
  ggplot2::ggtitle("Fishery Revenue in Wind Lease Areas")+
  ggplot2::ylab(expression("2019 Constant 10"^6*"Dollars "))+
  theme(legend.title = element_blank())+
  ggplot2::xlab(element_blank())+
  ecodata::theme_ts()+
  ecodata::theme_title()
```


## Shelfwide Indicators

### Wind Development Speed

```{r wind-dev-cumul, fig.cap = ""}

#knitr::include_url("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/docs/images/All_2021119-01.jpg")
knitr::include_graphics(file.path(image.dir, "All_2021128_needsgraph-01.jpg"))
```

```{r wind-dev-cumul-MAB, fig.cap = ""}

knitr::include_graphics(file.path(image.dir, "MidAtlantic_2021128-01.jpg"))
#knitr::include_url("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/docs/images/MidAtlantic_2021119-01.jpg")
```

```{r wind-dev-NE, fig.cap = ""}

#knitr::include_url("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/docs/images/NE2021119.jpg")
knitr::include_graphics(file.path(image.dir, "NE2021128-01.jpg"))
```

```{r wind-dev-survey, fig.cap = ""}

knitr::include_graphics(file.path(image.dir, "SurveyMap202133.png"))
#knitr::include_url("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/docs/images/SurveysWindFarmAreas_20201229.jpg")
```

```{r wind-dev-speed0, eval = T, echo = F, fig.cap='', out.width='80%'}
total_area<- ecodata::wind_dev_speed %>% mutate(Value = as.numeric(Value)/1000000, 
                                                Time = as.integer(Time)) %>% 

  ggplot2::ggplot()+
  ggplot2::geom_point(aes(x = Time, y = Value))+
  ggplot2::geom_line(aes(x = Time, y = Value, group=1))+
  ggplot2::ylab("Total Area (Million Acres)")+
  ggplot2::xlab("Project End Year")+
  ggplot2::ggtitle("Cumulative Area")+
  ecodata::theme_ts()+
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_continuous(breaks=c(2020,2022, 2024,2026, 2028))+
  ecodata::theme_title()

total_area
```

<!-- ### Wind Sites and Occurrence  -->

<!-- <span style="color: red;">NO NEW DATA</span> -->

<!-- These are the five species most likely to occur in the lease areas.  -->

<!-- ```{r wind-occupancy, eval = T, echo = F, fig.cap='', out.width='80%'} -->
<!-- wind1 <- ecodata::wind_occupancy -->
<!-- wind1$trend<- ifelse(wind1$Trend == "pos",  -->
<!--                     "$\\nearrow$", -->
<!--                     ifelse(wind1$Trend == "neg", -->
<!--                     "$\\searrow$",  -->
<!--                     " "))  -->
<!-- wind2<-wind1 %>% dplyr::select(Area, Season, Species, trend) -->
<!-- names<-c("Area", "Season", "Species", "trend") -->
<!-- bnew<-c("Area.1", "Season.1", "Species.1", "trend.1") -->
<!-- cnew<-c("Area.2", "Season.2", "Species.2", "trend.2") -->
<!-- dnew<-c("Area.3", "Season.3", "Species.3", "trend.3") -->
<!-- enew<-c("Area.4", "Season.4", "Species.4", "trend.4") -->
<!-- a<-wind2 %>% dplyr::filter(Area == "Existing-North")  -->
<!-- b<-wind2 %>% dplyr::filter(Area == "Proposed-North") %>%  -->
<!--   dplyr::rename_at(vars(names), ~ bnew) -->
<!-- c<-wind2 %>% dplyr::filter(Area == "Existing-Mid")%>%  -->
<!--   dplyr::rename_at(vars(names), ~ cnew) -->
<!-- d<-wind2 %>% dplyr::filter(Area == "Proposed-Mid")%>%  -->
<!--   dplyr::rename_at(vars(names), ~ dnew) -->
<!-- e<-wind2 %>% dplyr::filter(Area == "Existing-South")%>%  -->
<!--   dplyr::rename_at(vars(names), ~ enew) -->
<!-- all<- a %>% cbind(b,c,d,e) %>%  -->
<!--   dplyr::select(2:4,7:8,11:12,15:16,19:20) -->

<!-- kable(all, escape = FALSE, -->
<!--       col.names = c("Season", "Species", "Trend", "Species", "Trend", "Species","Trend", "Species","Trend", "Species", "Trend"), -->
<!--       caption = "Species with highest probability of occupancy species each season and area, with observed trends", -->
<!--       booktabs = T) %>% -->
<!--     add_header_above(c(" " = 1, "Existing - North" = 2, "Proposed - North" = 2,  -->
<!--                      "Existing - Mid" = 2, "Proposed - Mid" = 2,  -->
<!--                      "Existing - South" = 2)) %>% -->
<!--   kable_styling(latex_options = c("hold_position", "scale_down"))  -->
<!-- ``` -->










<!-- ```{r wind-map, eval = T, echo = F, fig.cap="Map of BOEM existing (black) and proposed (red) lease areas as of February 2019.", message=FALSE, results=FALSE} -->


<!-- nesbath <- marmap::fortify.bathy(marmap::getNOAA.bathy(lon1 = -77, lon2 = -65, lat1 = 35, lat2 = 45, -->
<!--               resolution = 5)) -->

<!-- lease_s<-sf::st_read(file.path(gis.dir, 'BOEM lease areas/ne_existing_leasesSPoly.shp')) -->
<!-- lease_n<-sf::st_read(file.path(gis.dir, 'BOEM lease areas/ne_existing_leasesNPoly.shp')) -->
<!-- lease_m<-sf::st_read(file.path(gis.dir, 'BOEM lease areas/ne_existing_leasesMPoly.shp')) -->
<!-- prop_n<-sf::st_read(file.path(gis.dir, 'BOEM lease areas/ne_proposed_leases_NPoly.shp')) -->
<!-- prop_m<-sf::st_read(file.path(gis.dir, 'BOEM lease areas/ne_proposed_leases_MPoly.shp')) -->

<!-- invisible(sf::st_crs(lease_s)<-crs) -->
<!-- invisible(sf::st_crs(lease_n)<-crs) -->
<!-- invisible(sf::st_crs(lease_m)<-crs) -->
<!-- invisible(sf::st_crs(prop_n)<-crs) -->
<!-- invisible(sf::st_crs(prop_m)<-crs) -->

<!-- ggplot2::ggplot() + -->
<!--   ggplot2::geom_raster(data = nesbath, aes(x=x,y=y, fill = z)) + -->
<!--   ggplot2::scale_fill_gradientn(colors =c("lightcyan","lightblue4"))+ -->
<!--   ggplot2::geom_sf(data = ecodata::coast, size = map.lwd) + -->
<!--   ggplot2::geom_sf(data = epu_sf, fill = "transparent", size = map.lwd) + -->
<!--   ggplot2::geom_sf(data = lease_s, size = map.lwd, color = "black")+ -->
<!--   ggplot2::geom_sf(data = lease_n, size = map.lwd, color = "black")+ -->
<!--   ggplot2::geom_sf(data = lease_m, size = map.lwd, color = "black")+ -->
<!--   ggplot2::geom_sf(data = prop_n, size = map.lwd, color = "red3")+ -->
<!--   ggplot2::geom_sf(data = prop_m, size = map.lwd, color = "red3")+ -->
<!--   ggplot2::coord_sf(crs = crs, xlim = c(-77, -69), ylim = c(36,42))+ -->
<!--   ggplot2::geom_segment(aes(x = -74.6, y = 37.4, xend =-75.4, yend =38), colour = "blue4")+ -->
<!--   ggplot2::geom_segment(aes(x = -71.1, y = 40.2, xend =-71.6, yend =41.1), colour = "blue4")+ -->
<!--   ggplot2::annotate("text", x = -74.9, y = 37, label = "S")+ -->
<!--   ggplot2::annotate("text", x = -73.5, y = 38.7, label = "M")+ -->
<!--   ggplot2::annotate("text", x = -70.5, y = 40.2, label = "N")+ -->
<!--   ggspatial::annotation_scale(location = "br", width_hint = 0.4) + -->
<!--   ggplot2::theme_bw( ) + -->
<!--   ggplot2::ylab("")+ -->
<!--   ggplot2::xlab("")+ -->
<!--   ggplot2::theme(legend.position = "none") + -->
<!--   ggplot2::ggtitle("BOEM lease areas") -->

<!-- ```  -->



