---
title: "Environmental and LTL Indicators"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    theme: lumen
---

```{r setup, include=FALSE}
image.dir<- here::here("docs/images")
#Default Rmd options
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center') #allows for inserting R code into captions

#Plotting and data libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(ecodata)
library(here)
library(kableExtra)
library(ggrepel)
library(stringr)
library(patchwork)
library(grid)

#GIS libraries
library(sf)
library(rgdal)
library(raster)
library(rnaturalearth)


#General inline text input for report

#Council
council <- "Mid-Atlantic Fishery Management Council"
council_abbr <- "MAFMC"

#Region identifiers
epu <- "Mid-Atlantic Bight"
epu_abbr <- "MAB"
region <- "Mid-Atlantic"
region_abbr <- "MA" #Some commercial data organized by "MA" or "NE" regions, not by EPU 


```

```{r GIS-setup}

#CRS
crs <- "+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0 +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#Coastline shapefile
coast <- ne_countries(scale = 10,
                          continent = "North America",
                          returnclass = "sf") %>%
             sf::st_transform(crs = crs)

#State polygons
ne_states <- ne_states(country = "united states of america",
                                      returnclass = "sf") %>%
  sf::st_transform(crs = crs)

#EPU shapefile
epu_sf <- ecodata::epu_sf %>% 
  filter(EPU %in% c("MAB","GB","GOM"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -77
xmax = -65
ymin = 36
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

#Time series constants
shade.alpha <- 0.3
shade.fill <- "lightgrey"
lwd <- 1
pcex <- 2
trend.alpha <- 0.5
trend.size <- 2
hline.size <- 1
hline.alpha <- 0.35
hline.lty <- "dashed"
label.size <- 5
hjust.label <- 1.5
letter_size <- 4
feeding.guilds <- c("Apex Predator","Piscivore","Planktivore","Benthivore","Benthos")
x.shade.min <- 2009
x.shade.max <- 2019
#Function for custom ggplot facet labels
label <- function(variable,value){
  return(facet_names[value])
}
```

Trend lines are shown when slope is significantly different from 0 at the p < 0.05 level. An orange line signifies an overall positive trend, and purple signifies a negative trend. Note that in the final report we will only test for trend when N >= 30. However, I have relaxed that requirement for the purposes of this document so that trends are highlighted when N >= 20. **This means that some trends shown here will not be present in the final document**. Dashed lines represent mean values of time series unless the indicator is an anomaly, in which case the dashed line is equal to 0. Shaded regions indicate the past ten years. If there are no new data for 2018, the shaded region will still cover this time period.

## Mid-Atlantic Bight

### Ocean Temperature {.tabset .tabset-fade}

#### SST
still working on time series update
```{r MAB-SST-insitu, fig.width = 8, fig.height = 7}
annotation_custom2 <- function (grob, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, data) 
{
  layer(data = data, stat = StatIdentity, position = PositionIdentity, 
        geom = ggplot2:::GeomCustomAnn,
        inherit.aes = TRUE, params = list(grob = grob, 
                                          xmin = xmin, xmax = xmax, 
                                          ymin = ymin, ymax = ymax))
}

#EPU shapefile
epu_sf <- ecodata::epu_sf %>% 
  filter(EPU %in% c("MAB"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -81
xmax = -66
ymin = 35.5
ymax = 43
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)
sst <- seasonal_sst_anomaly_gridded 

sst$Season <- factor(sst$Season, levels = c("Winter",
                                            "Spring",
                                            "Summer",
                                            "Fall"))
sst_map <- 
  ggplot() +
  geom_tile(data = sst, aes(x = Longitude, y = Latitude,fill = Value)) +
  geom_sf(data = coast, size = map.lwd) +
  geom_sf(data = epu_sf, fill = "transparent", size = map.lwd) +
  scale_fill_gradient2(name = "Temp.\nAnomaly (°C)",
                       low = scales::muted("blue"),
                       mid = "white",
                       high = scales::muted("red"),
                       limits = c(-6,6)) +
  coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  facet_wrap(Season~.) +
  theme_map() +
  ggtitle("SST anomaly (2019)") +
  xlab("Longitude") +
  ylab("Latitude") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_text(size = 8))

winter_anom <-  ggplotGrob( seasonal_oisst_anom %>% 
                              filter(EPU == "MAB",
                                     str_detect(Var, "winter")) %>% 
                              mutate(hline = mean(Value)) %>% 
                              ggplot(aes(x = Time, y = Value)) +
                              annotate("rect", fill = shade.fill, alpha = shade.alpha,
                                       xmin = x.shade.min , xmax = x.shade.max,
                                       ymin = -Inf, ymax = Inf) +
                              geom_line() +
                              geom_point() +
                              geom_gls(alpha = trend.alpha + 0.25) +
                              ylab("SST anomaly (°C)")+
                              xlab(element_blank())+
                              scale_x_continuous(expand = c(0.01, 0.01)) +
                              geom_hline(aes(yintercept = hline)) +
                              theme_ts()+
                              theme(axis.title = element_text(size = 6),
                                    axis.text = element_text(size = 6),
                                    panel.background = element_rect(fill = "transparent"), 
                                    plot.background = element_rect(fill = "transparent", color = NA), 
                                    panel.grid.major = element_blank(),
                                    panel.grid.minor = element_blank(), 
                                    legend.background = element_rect(fill = "transparent"), 
                                    legend.box.background = element_rect(fill = "transparent"), 
                                    legend.key = element_rect(fill = "transparent", colour = NA), 
                                    axis.line = element_blank(),
                                    panel.border = element_blank())
)

spring_anom <-  ggplotGrob( seasonal_oisst_anom %>% 
                              filter(EPU == "MAB",
                                     str_detect(Var, "spring")) %>% 
                              mutate(hline = mean(Value)) %>% 
                              ggplot(aes(x = Time, y = Value)) +
                              annotate("rect", fill = shade.fill, alpha = shade.alpha,
                                       xmin = x.shade.min , xmax = x.shade.max,
                                       ymin = -Inf, ymax = Inf) +
                              geom_line() +
                              geom_point() +
                              geom_gls(alpha = trend.alpha + 0.25) +
                              ylab("SST anomaly (°C)")+
                              xlab(element_blank())+
                              scale_x_continuous(expand = c(0.01, 0.01)) +
                              geom_hline(aes(yintercept = hline)) +
                              theme_ts()+
                              theme(axis.title = element_text(size = 6),
                                    axis.text = element_text(size = 6),
                                    panel.background = element_rect(fill = "transparent"), 
                                    plot.background = element_rect(fill = "transparent", color = NA),
                                    panel.grid.major = element_blank(),
                                    panel.grid.minor = element_blank(), 
                                    legend.background = element_rect(fill = "transparent"), 
                                    legend.box.background = element_rect(fill = "transparent"), 
                                    legend.key = element_rect(fill = "transparent", colour = NA), 
                                    axis.line = element_blank(),
                                    panel.border = element_blank())
)

summer_anom <-  ggplotGrob( seasonal_oisst_anom %>% 
                              filter(EPU == "MAB",
                                     str_detect(Var, "summer")) %>% 
                              mutate(hline = mean(Value)) %>% 
                              ggplot(aes(x = Time, y = Value)) +
                              annotate("rect", fill = shade.fill, alpha = shade.alpha,
                                       xmin = x.shade.min , xmax = x.shade.max,
                                       ymin = -Inf, ymax = Inf) +
                              geom_line() +
                              geom_point() +
                              geom_gls(alpha = trend.alpha + 0.25) +
                              ylab("SST anomaly (°C)")+
                              xlab(element_blank())+
                              scale_x_continuous(expand = c(0.01, 0.01)) +
                              geom_hline(aes(yintercept = hline)) +
                              theme_ts()+
                              theme(axis.title = element_text(size = 6),
                                    axis.text = element_text(size = 6),
                                    panel.background = element_rect(fill = "transparent"),
                                    plot.background = element_rect(fill = "transparent", color = NA),
                                    panel.grid.major = element_blank(), 
                                    panel.grid.minor = element_blank(), 
                                    legend.background = element_rect(fill = "transparent"),
                                    legend.box.background = element_rect(fill = "transparent"), 
                                    legend.key = element_rect(fill = "transparent", colour = NA), 
                                    axis.line = element_blank(),
                                    panel.border = element_blank())
)

fall_anom <-  ggplotGrob( seasonal_oisst_anom %>% 
                            filter(EPU == "MAB",
                                   str_detect(Var, "fall")) %>% 
                            mutate(hline = mean(Value)) %>% 
                            ggplot(aes(x = Time, y = Value)) +
                            annotate("rect", fill = shade.fill, alpha = shade.alpha,
                                     xmin = x.shade.min , xmax = x.shade.max,
                                     ymin = -Inf, ymax = Inf) +
                            geom_line() +
                            geom_point() +
                            geom_gls(alpha = trend.alpha + 0.25) +
                            ylab("SST anomaly (°C)")+
                            xlab(element_blank())+
                            scale_x_continuous(expand = c(0.01, 0.01)) +
                            geom_hline(aes(yintercept = hline)) +
                            theme_ts()+
                            theme(axis.title = element_text(size = 6),
                                  axis.text = element_text(size = 6),
                                  panel.background = element_rect(fill = "transparent"), 
                                  plot.background = element_rect(fill = "transparent", color = NA), 
                                  panel.grid.major = element_blank(), 
                                  panel.grid.minor = element_blank(), 
                                  legend.background = element_rect(fill = "transparent"), 
                                  legend.box.background = element_rect(fill = "transparent"),
                                  legend.key = element_rect(fill = "transparent", colour = NA),
                                  axis.line = element_blank(),
                                  panel.border = element_blank())
)

sst_map + 
  annotation_custom2(grob = winter_anom,  xmin=-82, xmax=-73.75,
                     ymin=39, ymax=43.5, data = data.frame(Season = "Winter")) +
  annotation_custom2(grob = spring_anom,  xmin=-82, xmax=-73.75,
                     ymin=39, ymax=43.5, data = data.frame(Season = "Spring")) +
  annotation_custom2(grob = summer_anom,  xmin=-82, xmax=-73.75,
                     ymin=39, ymax=43.5, data = data.frame(Season = "Summer")) +
  annotation_custom2(grob = fall_anom,  xmin=-82, xmax=-73.75,
                     ymin=39, ymax=43.5, data = data.frame(Season = "Fall"))

```


#### Bottom temperature

```{r MAB-bot-temp, fig.width = 6, fig.asp = .55}
temp_anom <- ecodata::oceantemp_insitu %>% 
  filter(EPU == epu_abbr) %>% 
  complete(Time = full_seq(min(oceantemp_insitu$Time):max(oceantemp_insitu$Time),1),
           nesting(Var)) %>% 
  mutate(hline = 0)

temp_anom %>%
 filter(Var == "bottom temp anomaly in situ") %>%
ggplot2::ggplot() +
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = Value)) +
  geom_gls(aes(x = Time, y = Value)) +
  geom_point(aes(x = Time, y = Value), size = 1) +
  ylab("Temperature (°C)") +
  xlab(element_blank())+
  ggtitle("Bottom temp. anomaly") +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  theme_ts() +
  theme(strip.text=element_text(hjust=0),
        plot.title = element_text(size = 12))+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
 theme_ts()


```



### Chlorophyll and Primary Productivity {.tabset .tabset-fade}

#### Primary production


```{r PP-OCCI, fig.width=8}
out_pp <- ecodata::chl_pp %>% 
  filter(EPU == epu_abbr,
         str_detect(Var, "MONTHLY_PPD_MEDIAN")) %>% 
  separate(.,Time, into = c("Year","Month"), sep = 4) %>% 
    mutate(Month = plyr::mapvalues(Month, from = c("01","02","03","04","05","06",
                                                   "07","08","09","10","11","12"),
                                   to = c(month.abb))) %>% 
  group_by(Month) %>% 
  mutate(hline = mean(Value))

out_pp$Month <- factor(out_pp$Month, levels = month.abb)


pp_cci <- ggplot(out_pp) +
   # geom_gls(aes(x = Year, y = Value, group = Month))+
    geom_point(aes(x = Year, y = Value, group = Month)) +
    geom_line(aes(x = Year, y = Value, group = Month)) +
    scale_x_discrete(name = "", breaks = seq(min(out_pp$Year),max(out_pp$Year),10)) +  
        geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
    facet_wrap(Month~., ncol = 12) +
    ggtitle("Monthly median PPD") +
    ylab(expression("PP (gC m"^-2*" d"^-1*")")) +
    theme_facet() +
    theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(0.5, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm"))
pp_cci
```


```{r chl-monthly, eval = F}
out_chl <- ecodata::chl_pp %>% 
  filter(EPU == epu_abbr,
         str_detect(Var, "MONTHLY_CHLOR_A_MEDIAN")) %>% 
  separate(.,Time, into = c("Year","Month"), sep = 4) %>% 
    mutate(Month = plyr::mapvalues(Month, from = c("01","02","03","04","05","06",
                                                   "07","08","09","10","11","12"),
                                   to = c(month.abb)))%>% 
  group_by(Month) %>% 
  mutate(hline = mean(Value))
out_chl$Month <- factor(out_chl$Month, levels = month.abb)


chl_cci <- ggplot(out_chl) +
   # geom_gls(aes(x = Year, y = Value, group = Month))+
    geom_point(aes(x = Year, y = Value, group = Month)) +
    geom_line(aes(x = Year, y = Value, group = Month)) +
    scale_x_discrete(name = "", breaks = seq(min(out_chl$Year),max(out_chl$Year),10)) +  
            geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
    facet_wrap(Month~., ncol = 12) +
    ggtitle("Monthly median CHL") +
    ylab(expression("CHL (mg m"^-3*")")) +
    theme_facet() +
    theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(.5, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm"))
chl_cci
```


#### Sesonal chlorophyll *a* & primary production

```{r mab-chl-weekly,fig.cap = "Weekly chlorophyll concentrations and primary productivity in the Mid-Atlantic are shown for by the colored line for 2019. The long-term mean is shown in black and shading indicates +/- 1 sample SD."}

interp_chl_pp <- function(epu, year = 2019, Variable){
  out <- ecodata::chl_pp %>% 
    filter(str_detect(Var,Variable),
           EPU == epu) %>% 
    separate(.,Time, c("Year","Week"),sep = 4) %>% 
    filter(Year == year) %>% 
    group_by(EPU) %>% 
    mutate(Time = 1:length(Year))
  
  ltm_out <- ecodata::chl_pp %>% 
    filter(str_detect(Var,Variable),
           EPU == epu) %>% 
    separate(.,Time, c("Year","Week"),sep = 4) %>% 
    group_by(Week) %>% 
    dplyr::summarise(LTM = mean(Value, na.rm = T),
                     SD = sd(Value, na.rm = T)) %>% 
    mutate(Time = 1:length(Week),
           sd.low = LTM - SD,
           sd.high = LTM + SD) %>% 
    left_join(.,out, by = c("Time")) %>% 
    mutate(status = ifelse(Value < sd.high & Value > sd.low, "near_mean",
                           ifelse(Value > sd.high, "high",
                                  ifelse(Value < sd.low,"low",NA))),
           group = "PLOT")
  
  return(ltm_out)
}

MAB_chl <- interp_chl_pp(epu = "MAB", Variable = "WEEKLY_CHLOR_A_MEDIAN MODIS-Aqua PAN")

MAB_chl_weekly <- ggplot(data = MAB_chl) +
  geom_line(aes(x = Time, y = LTM)) +
  geom_ribbon(aes(x = Time, ymin = sd.low, ymax = sd.high), 
              alpha = 0.1,
              fill = "grey1") +
  geom_line(aes(x = Time, y = Value),
            size = 1,color = "#33a02c") +
  ggtitle(expression("Chlorophyll"~italic(a)~"")) +
  guides(color = F) +
  xlab("")+
  ylab(expression("CHL (mg m"^-3*")")) +
  scale_x_continuous(breaks = seq(1,52,10),
                   labels = c("Jan.","Mar.","May","July","Oct.","Dec."),
                   expand = c(0.01,0.01)) +
  scale_color_manual(values = c("#ef8a62","#2c7fb8","#a1d99b"))+
  theme_ts()

MAB_pp <- interp_chl_pp(epu = "MAB", Variable =  "WEEKLY_PPD_MEDIAN")

MAB_pp_weekly <- ggplot(data = MAB_pp) +
  geom_line(aes(x = Time, y = LTM)) +
  geom_ribbon(aes(x = Time, ymin = sd.low, ymax = sd.high),
              alpha = 0.1,
              fill = "grey1") +
  geom_line(aes(x = Time, y = Value),
            size = 1,color = "#33a02c") +
  ggtitle(expression("Primary production")) +
  guides(color = F) +
  xlab("")+
  ylab(expression("PP (gC m"^-2*" d"^-1*")")) +
  scale_x_continuous(breaks = seq(1,52,10),
                   labels = c("Jan.","Mar.","May","July","Oct.","Dec."),
                   expand = c(0.01,0.01)) +
  scale_color_manual(values = c("#ef8a62","#2c7fb8","#a1d99b"))+
  theme_ts()

MAB_chl_weekly + MAB_pp_weekly + plot_layout(ncol = 1)

```



### Chesapeake Bay Water Quality Attainment
<!-- <p style="color:red">No data delivered. Note from Jan 2 -  We are in the process of finalizing our assessment of Chesapeake bay water quality standards attainment for the latest assessment cycle (2016-2018). We may send you the data in a week or two.</p> -->

```{r cb-attainment,fig.width = 6, fig.asp = 0.55, fig.cap = "Water quality attainment in Chesapeake Bay following rolling three year assessment periods."}

minlab <- seq(1985,2015,5)
maxlab <- seq(1987,2017,5)



ches_bay_wq %>% 
  mutate(hline = mean(Value)) %>% 
  ggplot(aes(x = Time, y = Value)) +
       annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line() +
  geom_point() +
  geom_gls() +
  ylab(expression("Estimated attainment, percent")) +
  xlab(element_blank())+
  ggtitle("Chesapeake Bay Water Quality Attainment") +
  scale_x_continuous(breaks = minlab,labels = paste0(minlab,"-",maxlab),expand = c(0.01, 0.01)) +
    geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()
```


### Chesepeake Bay Salinity Anomolies

Write up on anomalies in salinity we saw in 2018,2019 following record breaking rain in 2018.  The low salinities impacted [hypoxia, fish and oysters](https://docs.google.com/document/d/19ikLWKQWiRSrjmQJ2F7EB_ZcieBMk6Ykf1RX_Gissao/edit). 

### Zooplankton {.tabset .tabset-fade}


#### Euphausiids + Cnidarians
```{r MAB-euph-cnid, fig.width = 8, fig.asp = .35}
zoo_abund <- ecodata::zoo_strat_abun %>% 
  filter(EPU == epu_abbr,
         !str_detect(Var, "Small|Large")) %>% 
  group_by(Var, EPU) %>% 
  mutate(hline = mean(Value)) 

zoo_abund %>% 
  ggplot(aes(x = Time, y = Value)) +
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  ylab("Stratified Abundance") +
  xlab(element_blank())+
  ggtitle("Zooplankton abundance") +
  facet_wrap(Var~., ncol = 3) +
  scale_x_continuous(expand = c(0.01, 0.01))+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))
  

```


#### Small and Large Calanoid stratified abundance
```{r MAB-sm-lg, fig.width = 8, fig.asp = .35}
zoo_abund <- ecodata::zoo_strat_abun %>% 
  filter(EPU == epu_abbr,
         str_detect(Var, "Small|Large")) %>% 
  group_by(Var, EPU) %>% 
  mutate(hline = mean(Value)) 

zoo_abund %>% 
  ggplot() +
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = Value, color = Var)) +
  geom_point(aes(x = Time, y = Value, color = Var)) +
  geom_gls(aes(x = Time, y = Value, group = Var)) +
  ylab("Stratified Abundance") +
  xlab(element_blank())+
  ggtitle("Zooplankton abundance") +
  #facet_wrap(Var~., ncol = 3) +
  scale_x_continuous(expand = c(0.01, 0.01))+
  geom_hline(aes(yintercept = hline,
           color = Var), 
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))
  

```


#### Abundance anomaly

<!-- # ```{r MAB-zoo-abund, fig.width = 8, fig.asp = .35} -->
<!-- # zoo_abund <- ecodata::zoo_abun_anom %>%  -->
<!-- #   filter(EPU == epu_abbr, -->
<!-- #          !str_detect(Var, "small-large")) %>%  -->
<!-- #   mutate(hline = 0, -->
<!-- #          Var = str_to_title(str_remove(Var, "anomaly")))  -->
<!-- #  -->
<!-- # zoo_abund %>%  -->
<!-- #   ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!-- #          annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!-- #       xmin = x.shade.min , xmax = x.shade.max, -->
<!-- #       ymin = -Inf, ymax = Inf) + -->
<!-- #   geom_gls() + -->
<!-- #   geom_line() + -->
<!-- #   geom_point() + -->
<!-- #   ylab("Abundance anomaly") + -->
<!-- #   xlab(element_blank())+ -->
<!-- #   ggtitle("Zooplankton abundance anomaly") + -->
<!-- #   facet_wrap(Var~., ncol = 3) + -->
<!-- #   scale_x_continuous(expand = c(0.01, 0.01))+ -->
<!-- #       geom_hline(aes(yintercept = hline), -->
<!-- #            size = hline.size, -->
<!-- #            alpha = hline.alpha, -->
<!-- #            linetype = hline.lty)+ -->
<!-- #   theme_facet() + -->
<!-- #   theme(strip.text=element_text(hjust=0, -->
<!-- #                                 face = "italic")) -->
<!-- #    -->
<!-- #  -->
<!-- # ``` -->

#### Small-large index

<!-- ```{r MAB-sli} -->
<!-- sli <- ecodata::zoo_sli_anom %>%  -->
<!--   filter(EPU == epu_abbr, -->
<!--          str_detect(Var, "Sm-Lg copepod anom")) %>%  -->
<!--   mutate(hline = 0)  -->

<!-- pp_anom <- ecodata::chl_pp %>%  -->
<!--   filter(str_detect(Var, "ANNUAL_PPD_RATIO_ANOMALY"), -->
<!--          EPU == "MAB") %>%  -->
<!--   mutate(hline = 1, -->
<!--          Time = as.numeric(as.character(Time)), -->
<!--          Var = "ANNUAL_PPD_RATIO_ANOMALY") -->

<!-- sli_plt <- sli %>%  -->
<!--   ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--          annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = -Inf, ymax = Inf) + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   guides(color = F) + -->
<!--   xlab("")+ -->
<!--   ylab("Small-large abundance") + -->
<!--   ggtitle("Small-large copepod abundance") + -->
<!--     scale_x_continuous(expand = c(0.01, 0.01), limits = c(1998, 2018))+ -->
<!--       geom_hline(aes(yintercept = hline, -->
<!--                      group = Var), -->
<!--            size = hline.size, -->
<!--            alpha = hline.alpha, -->
<!--            linetype = hline.lty)+ -->
<!--   theme_ts() + -->
<!--   theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic")) -->

<!-- pp_anom_plt <- pp_anom %>%  -->
<!--     ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--          annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = -Inf, ymax = Inf) + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   guides(color = F) + -->
<!--   ylab("Anomaly ratio") + -->
<!--   xlab(element_blank())+ -->
<!--   ggtitle("Primary production anomaly ratio") + -->
<!--     scale_x_continuous(expand = c(0.01, 0.01), limits = c(1998, 2018))+ -->
<!--     scale_y_continuous(limits = c(0.8,1.2)) + -->
<!--       geom_hline(aes(yintercept = hline, -->
<!--                      group = Var), -->
<!--            size = hline.size, -->
<!--            alpha = hline.alpha, -->
<!--            linetype = hline.lty)+ -->
<!--   theme_ts() + -->
<!--   theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic")) -->


<!-- sli_plt + pp_anom_plt + plot_layout(ncol = 1) & theme(plot.margin = margin(t = 0)) -->
<!-- ``` -->

#### Zooplankton Diversity

```{r MAB-zoo-abund1, fig.width = 8, fig.asp = .35}
zoo_div <- ecodata::zoo_diversity %>% 
  filter(EPU == epu_abbr)

zoo_div %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
         annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  ylab("Shannon Diversity Index") +
  xlab(element_blank())+
  ggtitle("Zooplankton Diversity") +
  facet_wrap(Var~., ncol = 3) +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = mean(Value)),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))
  

```

#### OI abundance

<!-- ```{r MAB-oi-zoo, fig.width=8} -->
<!-- facet_names <- list( -->
<!--   'centropages spring'=expression(paste(italic("Centropages "), "spring")), -->
<!--   'centropages fall'=expression(paste(italic("Centropages "), "fall")), -->
<!--   'temora spring'=expression(paste(italic("Temora "), "spring")), -->
<!--   'temora fall' = expression(paste(italic("Temora "), "fall")), -->
<!--   'pseudocalanus spring'=expression(paste(italic("Pseudocalanus "), "spring")), -->
<!--   'pseudocalanus fall' = expression(paste(italic("Pseudocalanus "), "fall"))) -->

<!-- zoo_oi_mab <- ecodata::zoo_oi %>%  -->
<!--   filter(!str_detect(Var,"SD"), -->
<!--          EPU == "MAB") %>%  -->

<!--   mutate(Var = str_remove(Var, " zoo"), -->
<!--          Val2 = exp(Value)) %>%  -->
<!--       group_by(Var) %>%  -->
<!--   mutate(hline = mean(Val2, na.rm = T)) %>%  -->
<!--   separate(.,col = Var, into = c("Species","Season"), remove = F) %>%  -->
<!--   mutate(Season = factor(Season, levels = c("spring", "fall"))) -->


<!-- top <- zoo_oi_mab %>%   -->
<!--   filter(Species == "centropages") %>%  -->

<!-- ggplot(aes(x = Time, y = Val2, group = Var)) + -->
<!--   annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = 0, ymax = Inf) + -->
<!--   geom_hline(aes(yintercept = hline), -->
<!--      size = hline.size, -->
<!--      alpha = hline.alpha, -->
<!--      linetype = hline.lty)+ -->
<!--   geom_gls() + -->
<!--   geom_line()+ -->
<!--   geom_point()+ -->
<!--   ylab("") + -->
<!--   facet_wrap(Season ~ ., ncol = 2, scales='free_x',labeller = label) + -->
<!--   ggtitle("Zooplankton abundance (OI)") + -->
<!--   scale_x_continuous(expand = c(0.01, 0.01))+ -->
<!--   scale_y_continuous(trans = "log10")+ -->
<!--   theme_facet() + -->
<!--     theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic"), -->
<!--           axis.title.x=element_blank(), -->
<!--         axis.text.x=element_blank(), -->
<!--         axis.ticks.x=element_blank()) -->

<!-- middle <- zoo_oi_mab %>%   -->
<!--   filter(Species == "pseudocalanus") %>%  -->
<!-- ggplot(aes(x = Time, y = Val2, group = Var)) + -->
<!--   annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = 0, ymax = Inf) + -->
<!--   geom_hline(aes(yintercept = hline), -->
<!--      size = hline.size, -->
<!--      alpha = hline.alpha, -->
<!--      linetype = hline.lty)+ -->
<!--   geom_gls() + -->
<!--   geom_line()+ -->
<!--   geom_point()+ -->
<!--   ylab(expression("Abundance num m"^-3*"")) + -->
<!--   facet_wrap(Season ~ ., ncol = 2, scales='free_x',labeller = label) + -->
<!--   scale_x_continuous(expand = c(0.01, 0.01))+ -->
<!--   scale_y_continuous(trans = "log10")+ -->
<!--   theme_facet() + -->
<!--     theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic"), -->
<!--           axis.title.x=element_blank(), -->
<!--         axis.text.x=element_blank(), -->
<!--         axis.ticks.x=element_blank()) -->

<!-- bottom <- zoo_oi_mab %>%   -->
<!--   filter(Species == "temora") %>%  -->
<!-- ggplot(aes(x = Time, y = Val2, group = Var)) + -->
<!--   annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = 0, ymax = Inf) + -->
<!--   geom_hline(aes(yintercept = hline), -->
<!--      size = hline.size, -->
<!--      alpha = hline.alpha, -->
<!--      linetype = hline.lty)+ -->
<!--     geom_gls() + -->
<!--   geom_line()+ -->
<!--   geom_point()+ -->
<!--     ylab("") + -->
<!--   xlab(element_blank())+ -->
<!--   facet_wrap(Season ~ ., ncol = 2,labeller = label) + -->
<!--   scale_x_continuous(breaks = seq(1980,2010,10), -->
<!--                      expand = c(0.01, 0.01))+ -->

<!--   theme_facet() + -->
<!--     theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic")) + -->
<!--    scale_y_log10() -->

<!-- top + middle + bottom + plot_layout(ncol = 1) & theme(plot.margin = margin(0,0,0,0,"cm")) -->

<!-- ``` -->

### Cold Pool Index
```{r cold_pool, eval = T, echo = F}

ecodata::cold_pool %>% 
    mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot() + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -3, ymax = 3) +
  geom_gls(aes(x = Time, y = Value),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value), size = lwd) +
  geom_point(aes(x = Time, y = Value), size = pcex) +
    geom_hline(aes(yintercept = hline),
     size = hline.size,
     alpha = hline.alpha,
     linetype = hline.lty)+
  ggtitle("Cold Pool Index")+
  ylab(expression("Cold Pool Temperature Anomaly (C) ")) +
  xlab("")+
  theme_ts()
```

### Marine Heat Wave

[Notes](https://docs.google.com/document/d/0B1lP7X3GP_hQLTlmU3hqLUMzVWcwS2U5R2oxTWNWb19tcmFz/edit)

```{r MAB_heatwave1, eval= T, echo = F, out.width = "80%"}

knitr::include_graphics(file.path(image.dir,"MAB_Heatwave_timeseries.jpg"))

```

```{r heatwave_mab}

cumu <- ecodata::heatwave %>% 
  filter(Var == "cumulative intensity") %>% 
  mutate(Var = recode(Var, "cumulative intensity" = "Cumulative Intensity (degree C x days)"))

maxin <- ecodata::heatwave %>% 
  filter(Var == "maximum intensity") %>% 
  group_by(Time, EPU, Var, Units) %>% 
  summarise(Value = max(Value)) %>% 
  ungroup() %>% 
  mutate(Var = recode(Var, "maximum intensity" = "Maximum Intensity (degree C)"))

hw<- cumu %>%
  rbind(maxin) %>% 
  group_by(Var, EPU) %>% 
  mutate(hline = mean(Value))

mab.hw<- hw %>% filter(EPU == epu_abbr)
mab.hw %>% 
  ggplot() +
  geom_line(aes(x = Time, y = Value)) +
  geom_point(aes(x = Time, y = Value)) +
  geom_gls(aes(x = Time, y = Value, group = Var)) +
  ylab("") +
  xlab(element_blank())+
  ggtitle("Mid-Atlantic Marine Heatwave Intesity") +
  scale_x_continuous(expand = c(0.01, 0.01))+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  facet_wrap(~Var, scales = "free")+
  theme_ts()+
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))

```

## Gulf of Maine & Georges Bank

### Ocean Temperature {.tabset .tabset-fade}

#### SST 

```{r NE-SST-insitu, fig.width=8, fig.height = 8}
#EPU shapefile
epu_sf <- ecodata::epu_sf %>% 
  filter(EPU %in% c("GOM","GB"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -73
xmax = -65
ymin = 39
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)
sst <- seasonal_sst_anomaly_gridded 

sst$Season <- factor(sst$Season, levels = c("Winter",
                                            "Spring",
                                            "Summer",
                                            "Fall"))
sst_map <- 
  ggplot() +
  geom_tile(data = sst, aes(x = Longitude, y = Latitude,fill = Value)) +
  geom_sf(data = coast, size = map.lwd) +
  geom_sf(data = epu_sf, fill = "transparent", size = map.lwd) +
  scale_fill_gradient2(name = "Temp.\nAnomaly (°C)",
                       low = scales::muted("blue"),
                       mid = "white",
                       high = scales::muted("red"),
                       limits = c(-5,5)) +
  coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  facet_wrap(Season~.) +
  theme_map() +
  ggtitle("SST anomaly (2019)") +
  xlab("Longitude") +
  ylab("Latitude") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_text(size = 8))


sst_map 

```

```{r NE-SST-anom-series, fig.width = 8}
ne_anom <- seasonal_oisst_anom %>% 
  filter(EPU %in% c("GOM","GB")) %>% 
    mutate(hline = 0,
           Var = str_to_title(str_extract(Var,"winter|spring|summer|fall")))
ne_anom$Var <- factor(ne_anom$Var, levels= c("Winter","Spring","Summer","Fall"))

ne_anom_plt <- ggplot(data = ne_anom, 
       aes(x = Time, y = Value, color = EPU, group = EPU))+ #plot
     annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line()+
  geom_point()+
  ylim(-2,3)+
  geom_gls() +
  ylab(expression("SST Anomaly (°C)")) +
  xlab(element_blank())+
  ggtitle("Gulf of Maine & Georges Bank SST Anomaly") +
    scale_color_manual(values = c("black","indianred"))+
    scale_x_continuous(expand = c(0.01, 0.01)) +
    geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  facet_wrap(Var ~., ncol = 2, scales = "free_y")+
  theme_facet() +
  theme(strip.text=element_text(hjust=0),
        plot.title = element_text(size = 12))
ne_anom_plt
```


#### Bottom temperature

```{r NE-bot-temp}
bot_temp_insitu_gom <- oceantemp_insitu %>%
  filter(EPU == "GOM",
         Var == "bottom temp anomaly in situ") %>% 
  mutate(hline = 0) %>% 
    ggplot()+ #plot
     annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = Value)) +
  geom_gls(aes(x = Time, y = Value)) +
  geom_point(aes(x = Time, y = Value), size = 1) +
  ylab("Temperature Anomaly (°C)") +
  xlab(element_blank())+
  ggtitle("GOM Bottom Temperature Anomaly") +
  scale_x_continuous(expand = c(0.01, 0.01)) +
    geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() +
  theme(strip.text=element_text(hjust=0),
        plot.title = element_text(size = 12))


bot_temp_insitu_gb <- oceantemp_insitu %>%
  filter(EPU == "GB",
         Var == "bottom temp anomaly in situ") %>%
   mutate(hline = 0) %>% 
    ggplot()+ #plot
     annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = Value)) +
  geom_gls(aes(x = Time, y = Value)) +
  geom_point(aes(x = Time, y = Value), size = 1) +
  ylab("Temperature Anomaly (°C)") +
  xlab(element_blank())+
  ggtitle("GB Bottom Temperature Anomaly") +
  scale_x_continuous(expand = c(0.01, 0.01)) +
    geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() +
  theme(strip.text=element_text(hjust=0),
        plot.title = element_text(size = 12))



bot_temp_insitu_gom +
 bot_temp_insitu_gb + 
  plot_layout(ncol =  1) &
  theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))

```


#### GOM Slopewater Proportions

```{r wsw-prop, fig.width=5, fig.asp = 0.55}

sw.df <- slopewater %>% 
  mutate(Var, Var = plyr::mapvalues(Var, from = c("WSW proportion ne channel",
                                                  "LSLW proportion ne channel"),
                                    to = c("WSW","LSLW"))) %>% 
  dplyr::rename(Flavor  = Var) %>% 
  group_by(Flavor) %>% 
  mutate(hline = mean(Value)) 

sw.df$Flavor <- factor(sw.df$Flavor, levels = c("WSW","LSLW"))

ggplot(data = sw.df) +
  geom_line(aes(x = Time, y = Value, color = Flavor))+
  geom_point(aes(x = Time, y = Value, color = Flavor)) +
  ylab("Percent of Total Slopewater") +
  xlab(element_blank())+
  ggtitle("Slopewater Proportions in NE Channel")+
    scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline,
                     color = Flavor),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_ts() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))

```


### Chlorophyll and Primary Productivity {.tabset .tabset-fade}

#### Primary production

```{r NE-PP-OCCI, fig.width=8, fig.height = 8}
out_pp <- ecodata::chl_pp %>% 
  filter(EPU %in% c("GOM","GB"),
         str_detect(Var, "MONTHLY_PPD_MEDIAN")) %>% 
  separate(.,Time, into = c("Year","Month"), sep = 4) %>% 
    mutate(Month = plyr::mapvalues(Month, from = c("01","02","03","04","05","06",
                                                   "07","08","09","10","11","12"),
                                   to = c(month.abb))) %>% 
  group_by(EPU, Month) %>% 
  mutate(hline = mean(Value))
out_pp$Month <- factor(out_pp$Month, levels = month.abb)

pp_cci_gom <- out_pp %>% 
  filter(EPU == "GOM") %>% 
 ggplot() +
   # geom_gls(aes(x = Year, y = Value, group = Month))+
    geom_point(aes(x = Year, y = Value, group = Month)) +
    geom_line(aes(x = Year, y = Value, group = Month)) +
    scale_x_discrete(name = "", breaks = seq(min(out_pp$Year),max(out_pp$Year),10)) +  
    facet_wrap(Month~., ncol = 12) +
    ggtitle("GOM Monthly median PPD") +
    ylab(expression("PP (gC m"^-2*" d"^-1*")")) +
        geom_hline(aes(yintercept = hline,
                     group = Month),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
    theme_facet() +
    theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(1, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm"))
 
 pp_cci_gb <-out_pp %>% 
  filter(EPU == "GB") %>% 
 ggplot() +
   # geom_gls(aes(x = Year, y = Value, group = Month))+
    geom_point(aes(x = Year, y = Value, group = Month)) +
    geom_line(aes(x = Year, y = Value, group = Month)) +
    scale_x_discrete(name = "", breaks = seq(min(out_pp$Year),max(out_pp$Year),10)) +  
    facet_wrap(Month~., ncol = 12) +
    ggtitle("GB Monthly median PPD") +
    ylab(expression("PP (gC m"^-2*" d"^-1*")")) +
        geom_hline(aes(yintercept = hline,
                     group = Month),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
    theme_facet() +
    theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(1, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm"))
 
 pp_cci_gom + pp_cci_gb + plot_layout(ncol = 1)
 
```

#### Sesonal chlorophyll *a* & primary production

```{r NE-chl-weekly, fig.width = 8, fig.cap = "Weekly chlorophyll concentrations and primary productivity for 2019 in Gulf of Maine and Georges Bank are shown by the colored lines in the above figures. The long-term mean is shown in black and shading indicates +/- 1 sample SD."}

GB_chl_weekly <- interp_chl_pp(epu = "GB", year = 2019,Variable = "WEEKLY_CHLOR_A_MEDIAN")
GOM_chl_weekly <- interp_chl_pp(epu = "GOM", year = 2019,Variable = "WEEKLY_CHLOR_A_MEDIAN")
ne_chl_weekly<-rbind(GB_chl_weekly, GOM_chl_weekly)

ne_chl <- ggplot(data = ne_chl_weekly) +
  geom_line(aes(x = Time, y = LTM)) +
  geom_ribbon(aes(x = Time, ymin = pmax(sd.low,0), ymax = sd.high), 
              alpha = 0.1,
              fill = "grey1") +
  geom_line(aes(x = Time, y = Value),
            size = 1,color = "#33a02c") +
  ggtitle(expression("GB chlorophyll"~italic(a)~"")) +
  ylim(c(0, 3))+
  facet_wrap(EPU~., ncol = 2)+
  guides(color = F) +
  xlab("")+
  ylab("") +
  scale_x_continuous(breaks = seq(1,52,10),
                   labels = c("Jan.","Mar.","May","July","Oct.","Dec."),
                   expand = c(0.01,0.01)) +
  scale_color_manual(values = c("#ef8a62","#2c7fb8","#a1d99b"))+
  theme_ts()


GB_ppd_weekly <- interp_chl_pp(epu = "GB",  year = 2019,Variable = "WEEKLY_PPD_MEDIAN")
GOM_ppd_weekly <- interp_chl_pp(epu = "GOM",  year = 2019,Variable = "WEEKLY_PPD_MEDIAN")
ne_ppd_weekly<-rbind(GB_ppd_weekly, GOM_ppd_weekly)

ne_ppd <- ggplot(data = ne_ppd_weekly) +
  geom_line(aes(x = Time, y = LTM)) +
  geom_ribbon(aes(x = Time, ymin = pmax(sd.low,0), ymax = sd.high), 
              alpha = 0.1,
              fill = "grey1") +
  geom_line(aes(x = Time, y = Value),
            size = 1,color = "#33a02c") +
  ggtitle(expression("GB primary production")) +
  guides(color = F) +
  facet_wrap(EPU~., ncol = 2)+
  xlab("")+
  ylab("") +
  scale_x_continuous(breaks = seq(1,52,10),
                   labels = c("Jan.","Mar.","May","July","Oct.","Dec."),
                   expand = c(0.01,0.01)) +
  scale_color_manual(values = c("#ef8a62","#2c7fb8","#a1d99b"))+
  theme_ts()

ne_ppd
ne_chl

```



```{r NE-chl-monthly, fig.width = 8, fig.height=8, eval = F}
out_chl <- ecodata::chl_pp %>% 
  filter(EPU %in% c("GOM","GB"),
         str_detect(Var, "MONTHLY_CHLOR_A_MEDIAN")) %>% 
  separate(.,Time, into = c("Year","Month"), sep = 4) %>% 
    mutate(Month = plyr::mapvalues(Month, from = c("01","02","03","04","05","06",
                                                   "07","08","09","10","11","12"),
                                   to = c(month.abb)))
out_chl$Month <- factor(out_chl$Month, levels = month.abb)


chl_cci_gom <- 
  out_chl %>% 
  filter(EPU == "GOM") %>% 
  ggplot() +
    #geom_gls(aes(x = Year, y = Value, group = Month))+
    geom_point(aes(x = Year, y = Value, group = Month)) +
    geom_line(aes(x = Year, y = Value, group = Month)) +
    scale_x_discrete(name = "", breaks = seq(min(out_chl$Year),max(out_chl$Year),10)) +  
    facet_wrap(Month~., ncol = 12) +
    ggtitle("GOM Monthly median CHL (OC-CCI)") +
    ylab(expression("CHL (mg m"^-3*")")) +
    theme_facet() +
    theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(0.5, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm"))

chl_cci_gb <- 
  out_chl %>% 
  filter(EPU == "GB") %>% 
  ggplot() +
    #geom_gls(aes(x = Year, y = Value, group = Month))+
    geom_point(aes(x = Year, y = Value, group = Month)) +
    geom_line(aes(x = Year, y = Value, group = Month)) +
    scale_x_discrete(name = "", breaks = seq(min(out_chl$Year),max(out_chl$Year),10)) +  
    facet_wrap(Month~., ncol = 12) +
    ggtitle("GB Monthly median CHL (OC-CCI)") +
    ylab(expression("CHL (mg m"^-3*")")) +
    theme_facet() +
    theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(0.5, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm"))
chl_cci_gom + chl_cci_gb + plot_layout(ncol = 1)

```

### Zooplankton {.tabset .tabset-fade}


#### Euphausiids + Cnidarians
```{r ne-euph-cnid, fig.width = 8}
zoo_abund <- ecodata::zoo_strat_abun %>% 
  filter(EPU %in% c("GOM", "GB"),
         !str_detect(Var, "Small|Large")) %>% 
  group_by(Var, EPU) %>% 
  mutate(hline = mean(Value)) 

gom_zoo<-zoo_abund %>% 
  filter(EPU == "GOM") %>% 
  ggplot() +
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls(aes(x = Time, y = Value, group = Var)) +
  geom_line(aes(x = Time, y = Value)) +
  geom_point(aes(x = Time, y = Value)) +
  ylab("") +
  xlab(element_blank())+
  ggtitle("GOM Zooplankton abundance") +
  facet_wrap(Var~., ncol = 3) +
  scale_x_continuous(expand = c(0.01, 0.01))+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))
  
gb_zoo<-zoo_abund %>% 
  filter(EPU == "GB") %>% 
  ggplot(aes(x = Time, y = Value)) +
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  ylab("Abundance estimate (n)") +
  xlab(element_blank())+
  ggtitle("GB Zooplankton abundance") +
  facet_wrap(Var~., ncol = 3) +
  scale_x_continuous(expand = c(0.01, 0.01))+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))
  
cowplot::plot_grid(gb_zoo, gom_zoo, nrow = 2)
```


#### Small and Large Calanoid stratified abundance
```{r ne-sm-lg, fig.width = 8, fig.asp = .35}
zoo_abund <- ecodata::zoo_strat_abun %>% 
  filter(EPU %in% c("GOM", "GB"),
         str_detect(Var, "Small|Large")) %>% 
  group_by(Var, EPU) %>% 
  mutate(hline = mean(Value)) 

zoo_abund %>% 
  ggplot() +
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = Value, color = Var)) +
  geom_point(aes(x = Time, y = Value, color = Var)) +
  geom_gls(aes(x = Time, y = Value, group = Var)) +
  ylab("Abundance Estimate (n)") +
  xlab(element_blank())+
  ggtitle("Zooplankton abundance") +
  facet_wrap(EPU~., ncol = 1, scales = "free") +
  scale_x_continuous(expand = c(0.01, 0.01))+
  geom_hline(aes(yintercept = hline,
           color = Var), 
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))
  

```


#### Abundance anomaly

<!-- ```{r NE-zoo-abund} -->
<!-- zoo_abund <- ecodata::zoo_sli_anom %>%  -->
<!--   filter(EPU %in% c("GOM","GB"), -->
<!--          !str_detect(Var, "small-large")) %>%  -->
<!--   mutate(hline = 0, -->
<!--          Var = str_to_title(str_remove(Var, "anomaly")))  -->

<!-- gom_zoo_abund <- zoo_abund %>%  -->
<!--   filter(EPU == "GOM") %>%  -->
<!--   ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--          annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = -Inf, ymax = Inf) + -->
<!--   geom_gls() + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   ylab("Abundance anomaly") + -->
<!--   xlab(element_blank())+ -->
<!--   ggtitle("GOM Zooplankton abundance anomaly") + -->
<!--   facet_wrap(Var~., ncol = 3) + -->
<!--   scale_x_continuous(expand = c(0.01, 0.01))+ -->
<!--       geom_hline(aes(yintercept = hline), -->
<!--            size = hline.size, -->
<!--            alpha = hline.alpha, -->
<!--            linetype = hline.lty)+ -->
<!--   theme_facet() + -->
<!--   theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic")) -->

<!-- gb_zoo_abund <- zoo_abund %>%  -->
<!--   filter(EPU == "GB") %>%  -->
<!--   ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--          annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = -Inf, ymax = Inf) + -->
<!--   geom_gls() + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   ylab("Abundance anomaly") + -->
<!--   xlab(element_blank())+ -->
<!--   ggtitle("GB Zooplankton abundance anomaly") + -->
<!--   facet_wrap(Var~., ncol = 3) + -->
<!--   scale_x_continuous(expand = c(0.01, 0.01))+ -->
<!--       geom_hline(aes(yintercept = hline), -->
<!--            size = hline.size, -->
<!--            alpha = hline.alpha, -->
<!--            linetype = hline.lty)+ -->
<!--   theme_facet() + -->
<!--   theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic")) -->

<!-- gom_zoo_abund + gb_zoo_abund + plot_layout(ncol = 1) -->

<!-- ``` -->

#### Small-large index
 

<!-- ```{r NE-sli} -->
<!-- sli <- ecodata::zoo_sli_anom %>%  -->
<!--   filter(EPU %in% c("GOM","GB"), -->
<!--          str_detect(Var, "Sm-Lg copepod anom")) %>%  -->
<!--   mutate(hline = 0)  -->
<!-- sli$EPU <- factor(sli$EPU, levels = c("GOM","GB")) -->

<!-- pp_anom <- ecodata::chl_pp %>%  -->
<!--   filter(str_detect(Var, "ANNUAL_PPD_RATIO_ANOMALY"), -->
<!--          EPU %in% c("GOM","GB")) %>%  -->
<!--   mutate(hline = 1, -->
<!--          Time = as.numeric(as.character(Time)), -->
<!--          Var = "ANNUAL_PPD_RATIO_ANOMALY") -->
<!-- pp_anom$EPU <- factor(pp_anom$EPU, levels = c("GOM","GB")) -->

<!-- sli_plt <- sli %>%  -->
<!--   ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--          annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = -Inf, ymax = Inf) + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   guides(color = F) + -->
<!--   facet_wrap(EPU~.,ncol = 2)+ -->
<!--   xlab("")+ -->
<!--   ylab("Small-large abundance") + -->
<!--   xlab(element_blank())+ -->
<!--   ggtitle("Small-large copepod abundance") + -->
<!--     scale_x_continuous(expand = c(0.01, 0.01), limits = c(1998, 2018))+ -->
<!--       geom_hline(aes(yintercept = hline, -->
<!--                      group = Var), -->
<!--            size = hline.size, -->
<!--            alpha = hline.alpha, -->
<!--            linetype = hline.lty)+ -->
<!--   theme_facet() + -->
<!--   theme(strip.text=element_text(hjust=0)) -->

<!-- pp_anom_plt <- pp_anom %>%  -->
<!--     ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--          annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = -Inf, ymax = Inf) + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   guides(color = F) + -->
<!--   ylab("Anomaly ratio") + -->
<!--   xlab(element_blank())+ -->
<!--   facet_wrap(EPU~.,ncol = 2)+ -->
<!--   ggtitle("Primary production anomaly ratio") + -->
<!--     scale_x_continuous(expand = c(0.01, 0.01), limits = c(1998, 2018))+ -->
<!--     scale_y_continuous(limits = c(0.65,1.35)) + -->
<!--       geom_hline(aes(yintercept = hline, -->
<!--                      group = Var), -->
<!--            size = hline.size, -->
<!--            alpha = hline.alpha, -->
<!--            linetype = hline.lty)+ -->
<!--   theme_facet() + -->
<!--   theme(strip.text=element_text(hjust=0)) -->


<!-- sli_plt + pp_anom_plt + plot_layout(ncol = 1) & theme(plot.margin = margin(t = 0)) -->
<!-- ``` -->

#### Zooplankton Diversity
```{r NE-zoo-div}
zoo_div <- ecodata::zoo_diversity %>% 
  filter(EPU %in% c("GOM","GB"))

gom_zoo_div <- zoo_div %>% 
  filter(EPU == "GOM") %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
         annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  ylab("Shannon Diversity") +
  xlab(element_blank())+
  ggtitle("GOM Zooplankton Diversity") +
  facet_wrap(Var~., ncol = 3) +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = mean(Value)),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))

gb_zoo_div <- zoo_div %>% 
  filter(EPU == "GB") %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
         annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  ylab("Shannon Diversity") +
  xlab(element_blank())+
  ggtitle("GB Zooplankton Diversity") +
  facet_wrap(Var~., ncol = 3) +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = mean(Value)),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))
  
gom_zoo_div + gb_zoo_div + plot_layout(ncol = 1)

```

#### OI abundance

<!-- ```{r NE-oi-zoo, fig.width=8, fig.height=7} -->
<!-- facet_names <- list( -->
<!--   'centropages spring'=expression(paste(italic("Centropages "), "spring")), -->
<!--   'centropages fall'=expression(paste(italic("Centropages "), "fall")), -->
<!--   'temora spring'=expression(paste(italic("Temora "), "spring")), -->
<!--   'temora fall' = expression(paste(italic("Temora "), "fall")), -->
<!--   'pseudocalanus spring'=expression(paste(italic("Pseudocalanus "), "spring")), -->
<!--   'pseudocalanus fall' = expression(paste(italic("Pseudocalanus "), "fall"))) -->

<!-- zoo_oi_ne <- ecodata::zoo_oi %>%  -->
<!--   filter(!str_detect(Var,"SD")) %>%  -->
<!--   mutate(Var  = str_replace(Var," zoo",""), -->
<!--          Value = exp(Value)) %>%  -->
<!--   filter(EPU %in% c("GOM","GB")) %>%  -->
<!--       group_by(EPU, Var) %>%  -->
<!--   mutate(hline = mean(Value, na.rm = T), -->
<!--          Species = word(Var, 1), -->
<!--          Season = word(Var, 2)) %>%  -->
<!--   mutate(Season = factor(Season, levels = c("spring", "fall"))) -->


<!-- gom_top <- zoo_oi_ne %>%   -->
<!--   filter(Species == "centropages", EPU == "GOM") %>%  -->

<!-- ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--   annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = 0, ymax = Inf) + -->
<!--   geom_hline(aes(yintercept = hline), -->
<!--      size = hline.size, -->
<!--      alpha = hline.alpha, -->
<!--      linetype = hline.lty)+ -->
<!--   geom_gls() + -->
<!--   geom_line()+ -->
<!--   geom_point()+ -->
<!--   ylab("") + -->
<!--   xlab(element_blank())+ -->
<!--   facet_wrap(Season ~ ., ncol = 2, scales='free_x', labeller = label) + -->
<!--   ggtitle("GOM zooplankton abundance") + -->
<!--   scale_x_continuous(expand = c(0.01, 0.01))+ -->
<!--   scale_y_continuous(trans = "log10")+ -->
<!--   theme_facet() + -->
<!--     theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic"), -->
<!--           axis.title.x=element_blank(), -->
<!--         axis.text.x=element_blank(), -->
<!--         axis.ticks.x=element_blank()) -->

<!-- gom_middle <- zoo_oi_ne %>%   -->
<!--   filter(Species == "pseudocalanus", EPU == "GOM") %>%  -->
<!-- ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--   annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = 0, ymax = Inf) + -->
<!--   geom_hline(aes(yintercept = hline), -->
<!--      size = hline.size, -->
<!--      alpha = hline.alpha, -->
<!--      linetype = hline.lty)+ -->
<!--   geom_gls() + -->
<!--   geom_line()+ -->
<!--   geom_point()+ -->
<!--   ylab(expression("Abundance num m"^-3*"")) + -->
<!--   facet_wrap(Season ~ ., ncol = 2, scales='free_x',labeller = label) + -->
<!--   scale_x_continuous(expand = c(0.01, 0.01))+ -->
<!--   scale_y_continuous(trans = "log10")+ -->
<!--   theme_facet() + -->
<!--     theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic"), -->
<!--           axis.title.x=element_blank(), -->
<!--         axis.text.x=element_blank(), -->
<!--         axis.ticks.x=element_blank()) -->

<!-- gom_bottom <- zoo_oi_ne %>%   -->
<!--   filter(Species == "temora", EPU == "GOM") %>%  -->
<!-- ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--   annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = 0, ymax = Inf) + -->
<!--   geom_hline(aes(yintercept = hline), -->
<!--      size = hline.size, -->
<!--      alpha = hline.alpha, -->
<!--      linetype = hline.lty)+ -->
<!--     geom_gls() + -->
<!--   geom_line()+ -->
<!--   geom_point()+ -->
<!--     ylab("") + -->
<!--   facet_wrap(Season ~ ., ncol = 2,labeller = label) + -->
<!--   scale_x_continuous(breaks = seq(1980,2010,10), -->
<!--                      expand = c(0.01, 0.01))+ -->
<!--   scale_y_continuous(trans = "log10")+ -->
<!--   theme_facet() + -->
<!--     theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic"))  -->

<!-- gom_top + gom_middle + gom_bottom + plot_layout(ncol = 1) & theme(plot.margin = margin(0,0,0,0,"cm")) -->

<!-- ``` -->

<!-- ```{r GB-zoo-seasonal-abundance, fig.width = 8, fig.height = 7} -->
<!-- gb_top <- zoo_oi_ne %>%   -->
<!--   filter(Species == "centropages", EPU == "GB") %>%  -->

<!-- ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--   annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = 0, ymax = Inf) + -->
<!--   geom_hline(aes(yintercept = hline), -->
<!--      size = hline.size, -->
<!--      alpha = hline.alpha, -->
<!--      linetype = hline.lty)+ -->
<!--   geom_gls() + -->
<!--   geom_line()+ -->
<!--   geom_point()+ -->
<!--   ylab("") + -->
<!--   facet_wrap(Season ~ ., ncol = 2, scales='free_x', labeller = label) + -->
<!--   ggtitle("GB zooplankton abundance") + -->
<!--   scale_x_continuous(expand = c(0.01, 0.01))+ -->
<!--   scale_y_continuous(trans = "log10")+ -->
<!--   theme_facet() + -->
<!--     theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic"), -->
<!--           axis.title.x=element_blank(), -->
<!--         axis.text.x=element_blank(), -->
<!--         axis.ticks.x=element_blank()) -->

<!-- gb_middle <- zoo_oi_ne %>%   -->
<!--   filter(Species == "pseudocalanus", EPU == "GB") %>%  -->
<!-- ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--   annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = 0, ymax = Inf) + -->
<!--   geom_hline(aes(yintercept = hline), -->
<!--      size = hline.size, -->
<!--      alpha = hline.alpha, -->
<!--      linetype = hline.lty)+ -->
<!--   geom_gls() + -->
<!--   geom_line()+ -->
<!--   geom_point()+ -->
<!--   ylab(expression("Abundance num m"^-3*"")) + -->
<!--   xlab(element_blank())+ -->
<!--   facet_wrap(Season ~ ., ncol = 2, scales='free_x',labeller = label) + -->
<!--   scale_x_continuous(expand = c(0.01, 0.01))+ -->
<!--   scale_y_continuous(trans = "log10")+ -->
<!--   theme_facet() + -->
<!--     theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic"), -->
<!--           axis.title.x=element_blank(), -->
<!--         axis.text.x=element_blank(), -->
<!--         axis.ticks.x=element_blank()) -->

<!-- gb_bottom <- zoo_oi_ne %>%   -->
<!--   filter(Species == "temora", EPU == "GB") %>%  -->
<!-- ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--   annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = 0, ymax = Inf) + -->
<!--   geom_hline(aes(yintercept = hline), -->
<!--      size = hline.size, -->
<!--      alpha = hline.alpha, -->
<!--      linetype = hline.lty)+ -->
<!--     geom_gls() + -->
<!--   geom_line()+ -->
<!--   geom_point()+ -->
<!--     ylab("") + -->
<!--   xlab(element_blank())+ -->
<!--   facet_wrap(Season ~ ., ncol = 2,labeller = label) + -->
<!--   scale_x_continuous(breaks = seq(1980,2010,10), -->
<!--                      expand = c(0.01, 0.01))+ -->
<!--   scale_y_continuous(trans = "log10")+ -->
<!--   theme_facet() + -->
<!--     theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic"))  -->

<!-- gb_top + gb_middle + gb_bottom + plot_layout(ncol = 1) & theme(plot.margin = margin(0,0,0,0,"cm")) -->

<!-- ``` -->


### Marine Heat Wave

```{r GOM_heatwave, eval= T, echo = F}
gb.hw<-hw %>% filter(EPU == "GB") %>% 
  ggplot() +
  geom_line(aes(x = Time, y = Value)) +
  geom_point(aes(x = Time, y = Value)) +
  geom_gls(aes(x = Time, y = Value)) +
  ylab("") +
  xlab(element_blank())+
  ggtitle("Georges Bank Marine Heatwave Intensity") +
  scale_x_continuous(expand = c(0.01, 0.01))+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  facet_wrap(~Var, scales = "free") +
  theme_ts()+
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))


gom.hw<-hw %>% filter(EPU == "GOM") %>% 
  ggplot() +
  geom_line(aes(x = Time, y = Value)) +
  geom_point(aes(x = Time, y = Value)) +
  geom_gls(aes(x = Time, y = Value)) +
  ylab("") +
  xlab(element_blank())+
  ggtitle("Gulf of Maine Marine Heatwave Intensity") +
  scale_x_continuous(expand = c(0.01, 0.01))+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  facet_wrap(~Var, scales = "free") +
  theme_ts()+
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))
gb.hw
gom.hw
```


```{r timesseries_heatwave, fig.cap="Georges Bank", eval= T, echo = F}


cowplot::ggdraw() + cowplot::draw_image(file.path(image.dir,"GB_Heatwave_timeseries.jpg"))
```

```{r timesseries_heatwave1, fig.cap = "Gulf of Maine", eval= T, echo = F}

cowplot::ggdraw() + cowplot::draw_image(file.path(image.dir,"GOM_Heatwave_timeseries.jpg"))
```


```{r heatwave_map, fig.cap = "Gulf of Maine", eval= T, echo = F}
knitr::include_graphics(file.path(image.dir,"SST_anom_Aug_23_2019.png"))

```
## Shelfwide Indicators {.tabset .tabset-fade}

### Seasonal SST anomaly

```{r seasonal-sst, fig.height=8}
# Set lat/lon window for maps
xmin = -77
xmax = -65
ymin = 36
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)
sst <- seasonal_sst_anomaly_gridded 

sst$Season <- factor(sst$Season, levels = c("Winter",
                                            "Spring",
                                            "Summer",
                                            "Fall"))
epu_sf <- ecodata::epu_sf[ecodata::epu_sf$EPU != "SS",]

ggplot() +
  geom_tile(data = sst, aes(x = Longitude, y = Latitude, fill = Value)) +
  geom_sf(data = coast, size = map.lwd) +
  geom_sf(data = epu_sf, fill = "transparent", size = map.lwd) +
  scale_fill_gradient2(name = "Temp.\nAnomaly (°C)",
                       low = scales::muted("blue"),
                       mid = "white",
                       high = scales::muted("red"),
                       limits = c(-6,6)) +
  coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  facet_wrap(Season~.) +
  theme_map() +
  ggtitle("SST anomaly (2019)") +
  xlab("Longitude") +
  ylab("Latitude") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_text(size = 8))
```

### Long-term SST

```{r long-term-sst}
lt_sst <- ecodata::long_term_sst %>% 
  mutate(hline = mean(Value, na.rm = TRUE))

hline <- mean(lt_sst$Value)

lt_sst %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  geom_hline(aes(yintercept = hline),
             size = hline.size,
             alpha = hline.alpha,
           linetype = hline.lty)+
  ylab("Temperature (°C)") +
  xlab(element_blank())+
  ggtitle("Long-term SST") +
  scale_x_continuous(expand = c(0.01, 0.01), breaks = seq(1840,2010,10))+
  theme_facet() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))
```

### GSI
[Notes](https://drive.google.com/drive/u/0/folders/0B1lP7X3GP_hQfk00dFd6bTQ2cmJyQjlwQnFWQ0JMWF9ZOWhRckNvSTlxT2NHSEZRdjV1WVk)
```{r GSI, fig.width = 5, fig.asp = 0.55}
gsi %>% 
  mutate(Year = floor(Time)) %>% 
  group_by(Year) %>% 
  dplyr::summarise(Value = mean(Value)) %>% 
  mutate(hline = mean(Value)) %>% 
  dplyr::rename(Time = Year) %>% 
  ggplot(aes(x = Time, y = Value)) +
         annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  ylab("Gulf Stream position anomaly") +
  xlab(element_blank())+
  ggtitle("Gulf Stream Index") +
    scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_ts() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))
```

### Warm Core Rings
```{r warm-core-rings}
upper.line<-ecodata::wcr %>%
  filter(Time>2000) %>% 
  mutate(hline = c(mean(Value)))
lower.line<-ecodata::wcr%>%
  filter(Time<2000) %>% 
  mutate(hline = c(mean(Value)))
wcr<- upper.line %>% 
  rbind(lower.line)

wcr %>% 
  ggplot(aes(x = Time, y = Value))+
  geom_point()+
  geom_line()+
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ylab("Warm Core Ring Births")+
  xlab(element_blank())+
  ggtitle("Warm Core Rings")+
  theme_ts()+
  geom_segment(data = upper.line, aes(x = min(Time), y = hline, 
                                      xend = max(Time), yend = hline, color = "segment") )+
  geom_segment(data = lower.line, aes(x = min(Time), y = hline, 
                                      xend = max(Time), yend = hline, color = "segment") )+
  theme(legend.position = "none")
```


### NERRs water quality 

<p style="color:red">Potentially possible to get map like this for DO, chl and nitrogen. Not this year though. </p>
```{r NERRs-MP-DIN, eval= T, echo = F, out.width = "80%"}

knitr::include_graphics(file.path(image.dir,"nerrs_map.png"))
```
<p style="color:red">I've asked for the total number of events per year.</p>
```{r NERRs-MH-DIN, eval= T, echo = F, out.width = "80%"}

knitr::include_graphics(file.path(image.dir,"nerrs_DO.png"))
```

